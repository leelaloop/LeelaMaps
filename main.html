<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeelaMaps - Social Map Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Prevent text selection on mobile while preserving touch functionality */
        body, html {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Allow text selection in input fields and content areas */
        input, textarea, [contenteditable], #viewContent, #viewTitle, #viewAuthor, .prose, .comment-content, .whitespace-pre-wrap {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Word highlighting and search functionality */
        .word-highlight {
            background-color: rgba(93, 92, 222, 0.2);
            border-radius: 3px;
            padding: 1px 2px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .word-highlight:hover {
            background-color: rgba(93, 92, 222, 0.3);
        }
        
        .word-search-icon {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #5D5CDE;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            z-index: 100;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .word-highlight:hover .word-search-icon,
        .word-search-icon.show {
            opacity: 1;
            transform: scale(1);
        }
        
        .word-search-icon:hover {
            background: #4A4BC7;
            transform: scale(1.1);
        }
        
        /* Prevent text selection on map but preserve touch events */
        #map {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Glow effect for new notes */
        .new-note-glow {
            animation: noteGlow 3s ease-out forwards;
        }
        
        @keyframes noteGlow {
            0% {
                filter: drop-shadow(0 0 15px #5D5CDE) drop-shadow(0 0 25px #5D5CDE) drop-shadow(0 0 35px #5D5CDE);
                transform: scale(1.1);
            }
            50% {
                filter: drop-shadow(0 0 10px #5D5CDE) drop-shadow(0 0 20px #5D5CDE);
                transform: scale(1.05);
            }
            100% {
                filter: none;
                transform: scale(1);
            }
        }
        
        /* Pulse effect for very new notes */
        .new-note-pulse {
            animation: notePulse 1s ease-in-out 3;
        }
        
        @keyframes notePulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        /* Modal overlay fade animation */
        .modal-overlay-fade {
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        
        .modal-overlay-fade-active {
            opacity: 1;
        }
        
        /* Pin-to-modal zoom animation - applies to the modal content only */
        .modal-content-zoom {
            transform-origin: var(--animation-origin-x, 50%) var(--animation-origin-y, 50%);
            transform: scale(0.1);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .modal-content-zoom-active {
            transform: scale(1);
        }
        
        /* Fallback animation when no origin point is available */
        .modal-content-fade {
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.3s ease-out;
        }
        
        .modal-content-fade-active {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white pt-16">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700 z-[1000]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-primary">
                        <span class="hidden sm:inline">LeelaMaps</span>
                        <span class="sm:hidden">LM</span>
                    </h1>
                </div>
                
                <!-- Search Bar -->
                <div class="flex-1 max-w-md mx-4">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="searchInput" 
                               class="block w-full pl-10 pr-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg leading-5 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="Search notes...">
                    </div>
                </div>

                <!-- User Menu -->
                <div id="userMenu" class="relative">
                    <div id="loggedOutMenu" class="flex space-x-2">
                        <button id="loginBtn" class="px-3 py-2 text-sm text-primary border border-primary rounded-lg hover:bg-primary hover:text-white transition-colors">
                            <span class="hidden sm:inline">Login</span>
                            <i class="fas fa-sign-in-alt sm:hidden"></i>
                        </button>
                        <button id="registerBtn" class="px-3 py-2 text-sm bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            <span class="hidden sm:inline">Register</span>
                            <i class="fas fa-user-plus sm:hidden"></i>
                        </button>
                    </div>
                    <div id="loggedInMenu" class="hidden">
                        <button id="profileBtn" class="flex items-center space-x-2 sm:space-x-3 px-2 sm:px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600 cursor-pointer hover:border-primary transition-colors" id="headerProfilePicContainer">
                                <img id="headerProfilePic" src="" alt="Profile" class="w-full h-full object-cover bg-gray-200 dark:bg-gray-600 rounded-full">
                            </div>
                            <div class="text-left hidden sm:block cursor-pointer hover:text-primary transition-colors" id="headerUserInfo">
                                <div id="currentUserName" class="text-sm font-medium"></div>
                                <div id="currentUserStatus" class="text-xs text-gray-500 dark:text-gray-400">Available</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    <span id="noteCount">0</span> notes
                                </div>
                            </div>
                            <i class="fas fa-chevron-down text-xs text-gray-400 hidden sm:block"></i>
                        </button>
                        
                        <!-- Profile Dropdown -->
                        <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50 hidden">
                            <div class="p-2 space-y-1">
                                <button id="editProfileBtn" onclick="document.getElementById('profileDropdown').classList.add('hidden'); showProfileSettingsModal('profile');" class="w-full flex items-center space-x-2 px-3 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                    <i class="fas fa-user-edit"></i>
                                    <span>Edit Profile</span>
                                </button>
                                <button id="accountSettingsBtn" onclick="document.getElementById('profileDropdown').classList.add('hidden'); showProfileSettingsModal('account');" class="w-full flex items-center space-x-2 px-3 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                    <i class="fas fa-cog"></i>
                                    <span>Account Settings</span>
                                </button>
                                <button id="friendsBtn" onclick="document.getElementById('profileDropdown').classList.add('hidden'); showProfileSettingsModal('friends');" class="w-full flex items-center space-x-2 px-3 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                    <i class="fas fa-users"></i>
                                    <span>Friends</span>
                                </button>
                                <button id="eventsBtn" onclick="document.getElementById('profileDropdown').classList.add('hidden'); showProfileSettingsModal('events');" class="w-full flex items-center space-x-2 px-3 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Events</span>
                                </button>
                                <button id="transactionsBtn" onclick="document.getElementById('profileDropdown').classList.add('hidden'); showProfileSettingsModal('transactions');" class="w-full flex items-center space-x-2 px-3 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                    <i class="fas fa-receipt"></i>
                                    <span>Transactions</span>
                                </button>
                                <div class="border-t border-gray-200 dark:border-gray-600 pt-1 mt-1">
                                    <button id="logoutBtn" class="w-full flex items-center space-x-2 px-3 py-2 text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors text-red-600 dark:text-red-400">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>Logout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative" style="height: calc(100vh - 64px);">
        <!-- Map Container -->
        <div id="map" class="w-full h-full"></div>

        <!-- Instructions Overlay -->
        <div id="instructionsOverlay" class="absolute top-4 left-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 max-w-sm z-[1000]">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <i id="instructionsIcon" class="fas fa-user-circle text-primary text-lg"></i>
                </div>
                <div id="instructionsContent">
                    <h3 id="instructionsTitle" class="font-semibold text-sm">Welcome to LeelaMaps</h3>
                    <p id="instructionsText" class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        Please login or register to start creating location-based notes and explore what others have shared.
                    </p>
                    <div id="instructionsButtons" class="flex space-x-2 mt-3">
                        <button id="instructionsLoginBtn" class="px-3 py-1 text-xs bg-primary text-white rounded hover:bg-primary/90 transition-colors">
                            Login
                        </button>
                        <button id="instructionsRegisterBtn" class="px-3 py-1 text-xs border border-primary text-primary rounded hover:bg-primary hover:text-white transition-colors">
                            Register
                        </button>
                    </div>
                </div>
                <button id="closeInstructions" class="flex-shrink-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Login/Register Modal -->
    <!-- Place this inside your <body> where your modal markup goes -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000] hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
          <h2 id="authTitle" class="text-xl font-semibold">Login</h2>
          <button id="closeAuthModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="authForm" class="p-6 space-y-4">
          <div id="usernameField">
            <label for="authUsername" class="block text-sm font-medium mb-2">Username</label>
            <input type="text" id="authUsername" required>
          </div>
          <div id="authEmailField" class="hidden">
            <label for="authEmail" class="block text-sm font-medium mb-2">Email</label>
            <input type="email" id="authEmail">
          </div>
          <div id="authPasswordField">
            <label for="authPassword" class="block text-sm font-medium mb-2">Password</label>
            <input type="password" id="authPassword" required>
          </div>
          <div class="flex justify-between items-center pt-4">
            <button type="button" id="authSwitchBtn" class="text-primary hover:text-primary/80 text-sm">
              Need an account? Register
            </button>
            <button type="submit" id="authSubmitBtn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
              Login
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
    // --- CONFIG ---
    const API_BASE = 'http://localhost:4000';

    // --- UTILITIES ---
    function saveToken(token) { localStorage.setItem('jwt', token); }
    function getToken() { return localStorage.getItem('jwt'); }
    function clearToken() { localStorage.removeItem('jwt'); }

    // --- UI ELEMENTS ---
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const authModal = document.getElementById('authModal');
    const authForm = document.getElementById('authForm');
    const authTitle = document.getElementById('authTitle');
    const authSwitchBtn = document.getElementById('authSwitchBtn');
    const authSubmitBtn = document.getElementById('authSubmitBtn');
    const authUsername = document.getElementById('authUsername');
    const authPassword = document.getElementById('authPassword');
    const closeAuthModal = document.getElementById('closeAuthModal');
    const loggedInMenu = document.getElementById('loggedInMenu');
    const loggedOutMenu = document.getElementById('loggedOutMenu');
    const currentUserName = document.getElementById('currentUserName');
    const logoutBtn = document.getElementById('logoutBtn');

    let isLogin = true;

    function openAuthModal(mode) {
      isLogin = (mode === 'login');
      updateAuthModal();
      authModal.classList.remove('hidden');
    }
    function closeModal() {
      authModal.classList.add('hidden');
      authForm.reset();
    }
    closeAuthModal.onclick = closeModal;

    // --- UPDATE MODAL UI ---
    function updateAuthModal() {
      if (isLogin) {
        authTitle.textContent = 'Login';
        authSwitchBtn.textContent = 'Need an account? Register';
        authSubmitBtn.textContent = 'Login';
      } else {
        authTitle.textContent = 'Register';
        authSwitchBtn.textContent = 'Already have an account? Login';
        authSubmitBtn.textContent = 'Register';
      }
    }

    // --- SWITCH LOGIN/REGISTER MODAL ---
    authSwitchBtn.onclick = function() {
      isLogin = !isLogin;
      updateAuthModal();
    };

    // --- OPEN MODAL EVENTS ---
    loginBtn.onclick = () => openAuthModal('login');
    registerBtn.onclick = () => openAuthModal('register');

    // --- FORM SUBMIT HANDLER ---
    authForm.onsubmit = async function(e) {
      e.preventDefault();
      authSubmitBtn.disabled = true;
      authSubmitBtn.textContent = isLogin ? 'Logging in...' : 'Registering...';
      try {
        const payload = isLogin
          ? { username: authUsername.value, password: authPassword.value }
          : { username: authUsername.value, password: authPassword.value };
        const endpoint = isLogin ? '/auth/login' : '/auth/register';
        const res = await fetch(API_BASE + endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Auth failed');
        if (isLogin) {
          saveToken(data.token);
          await loadProfile();
          closeModal();
          showUserMenu();
        } else {
          // After registration, automatically log in
          openAuthModal('login');
        }
      } catch (err) {
        alert(err.message);
      } finally {
        authSubmitBtn.disabled = false;
        authSubmitBtn.textContent = isLogin ? 'Login' : 'Register';
      }
    };

    // --- LOAD PROFILE IF LOGGED IN ---
    async function loadProfile() {
      const token = getToken();
      if (!token) {
        showLoggedOutMenu();
        return;
      }
      try {
        const res = await fetch(API_BASE + '/profile', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Invalid session');
        const user = await res.json();
        currentUserName.textContent = user.username;
        showUserMenu();
      } catch {
        clearToken();
        showLoggedOutMenu();
      }
    }

    // --- SHOW/HIDE MENUS BASED ON AUTH ---
    function showUserMenu() {
      loggedInMenu.classList.remove('hidden');
      loggedOutMenu.classList.add('hidden');
    }
    function showLoggedOutMenu() {
      loggedInMenu.classList.add('hidden');
      loggedOutMenu.classList.remove('hidden');
    }

    // --- LOGOUT HANDLER ---
    if (logoutBtn) logoutBtn.onclick = function() {
      clearToken();
      showLoggedOutMenu();
    };

    // --- INITIALIZE UI ---
    document.addEventListener('DOMContentLoaded', loadProfile);
    </script>

    <!-- Create/Edit Note Modal -->
    <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] flex flex-col">
            
            <!-- Fixed Header with Title and Template -->
            <div class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center space-x-4">
                        <h2 id="modalTitle" class="text-xl font-semibold">New Note</h2>
                        
                        <!-- Template Selector -->
                        <div class="relative">
                            <select id="templateSelector" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Template</option>
                                <optgroup label="Preset Templates">
                                    <!-- Preset templates will be populated here -->
                                </optgroup>
                                <optgroup id="userTemplatesGroup" label="My Templates" class="hidden">
                                    <!-- User templates will be populated here -->
                                </optgroup>
                            </select>
                            <button type="button" id="manageTemplatesBtn" class="absolute right-8 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Manage Templates">
                                <i class="fas fa-cog text-sm"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Scrollable Form Content -->
            <div class="flex-1 overflow-y-auto">
                <form id="noteForm" class="p-6 space-y-4">
                    <!-- Title with Pin Style -->
                    <div class="flex items-center space-x-3">
                        <!-- Compact Pin Style Selector -->
                        <div class="relative flex-shrink-0">
                            <button type="button" id="emojiDropdownBtn" class="w-12 h-12 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 hover:border-primary focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all flex items-center justify-center">
                                <span id="selectedEmojiDisplay" class="text-lg">üìç</span>
                            </button>
                            <div id="emojiDropdown" class="absolute top-full left-0 mt-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg z-50 hidden max-h-80 overflow-y-auto" style="min-width: 280px;">
                                <div class="p-2 border-b border-gray-200 dark:border-gray-600">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Pin Collection</span>
                                </div>
                                
                                <!-- Emoji Section -->
                                <div class="p-2">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Emojis</span>
                                        <button type="button" id="addEmojiBtn" class="text-xs text-primary hover:text-primary/80 font-medium">
                                            <i class="fas fa-plus mr-1"></i>Add
                                        </button>
                                    </div>
                                    <div id="emojiGrid" class="grid grid-cols-6 gap-1 mb-2">
                                        <!-- Emoji pins will be generated here -->
                                    </div>
                                </div>
                                
                                <!-- Custom Art Section -->
                                <div class="border-t border-gray-200 dark:border-gray-600 p-2">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Custom Art</span>
                                        <button type="button" id="addCustomArtBtn" class="text-xs text-primary hover:text-primary/80 font-medium">
                                            <i class="fas fa-plus mr-1"></i>Add
                                        </button>
                                    </div>
                                    <div id="customArtGrid" class="grid grid-cols-6 gap-1">
                                        <!-- Custom art pins will be generated here -->
                                    </div>
                                    <div id="emptyCustomArt" class="text-center py-4 text-xs text-gray-500 dark:text-gray-400">
                                        No custom pin art yet
                                    </div>
                                </div>
                                
                                <!-- Add Emoji Section -->
                                <div id="addEmojiSection" class="hidden border-t border-gray-200 dark:border-gray-600 p-2">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs text-gray-600 dark:text-gray-400">Add Emoji</span>
                                        <button type="button" id="cancelAddEmoji" class="text-xs text-gray-500 hover:text-gray-700">Cancel</button>
                                    </div>
                                    <input type="text" id="newEmojiInput" placeholder="Paste emoji here (e.g. üéØ)" maxlength="2" 
                                           class="w-full px-2 py-1 text-base border border-gray-300 dark:border-gray-600 rounded text-center bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <button type="button" id="saveEmojiBtn" class="w-full mt-2 px-2 py-1 text-xs bg-primary text-white rounded hover:bg-primary/90">Add to Collection</button>
                                </div>
                                
                                <!-- Add Custom Art Upload -->
                                <div id="addCustomArtSection" class="hidden border-t border-gray-200 dark:border-gray-600 p-2">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs text-gray-600 dark:text-gray-400">Upload Custom Art</span>
                                        <button type="button" id="cancelAddCustomArt" class="text-xs text-gray-500 hover:text-gray-700">Cancel</button>
                                    </div>
                                    <label for="newCustomPinUpload" class="flex items-center justify-center w-full h-16 border border-gray-300 dark:border-gray-600 border-dashed rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <div class="flex flex-col items-center">
                                            <i class="fas fa-upload text-gray-400 text-sm mb-1"></i>
                                            <span class="text-xs text-gray-500 dark:text-gray-400">Click to upload image</span>
                                        </div>
                                        <input type="file" id="newCustomPinUpload" class="hidden" accept="image/*">
                                    </label>
                                </div>
                                
                                <!-- Quick Upload Section -->
                                <div class="border-t border-gray-200 dark:border-gray-600 p-2">
                                    <label for="pinArtUpload" class="flex items-center justify-center w-full h-12 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-upload text-gray-400 text-sm"></i>
                                            <span class="text-sm text-gray-500 dark:text-gray-400">Quick upload</span>
                                        </div>
                                        <input type="file" id="pinArtUpload" class="hidden" accept="image/*">
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Title Input -->
                        <div class="flex-1">
                            <input type="text" id="noteTitle"
                                   class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                   placeholder="Note title (optional)...">
                        </div>
                        
                        <!-- Custom Pin Preview (when uploaded) -->
                        <div id="customPinPreview" class="hidden flex-shrink-0">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 rounded-full border-2 border-white shadow-lg overflow-hidden">
                                    <img id="customPinImage" class="w-full h-full object-cover" alt="Custom pin">
                                </div>
                                <button type="button" id="removeCustomPin" class="text-red-500 hover:text-red-700 text-sm">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div>
                        <textarea id="noteContent" rows="4"
                                  class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                  placeholder="Describe your location, experience, or observation (optional)..."></textarea>
                    </div>





                    <!-- Media Upload -->
                    <div class="space-y-4">
                        <!-- Upload Button -->
                        <div>
                            <label for="mediaUpload" class="flex items-center justify-center h-12 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-camera text-gray-400"></i>
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Add Photos/Videos</span>
                                </div>
                                <input type="file" id="mediaUpload" class="hidden" accept="image/*,video/*" multiple>
                            </label>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-center">
                                <span class="inline-flex items-center">
                                    Add photos/videos 
                                    <button type="button" class="ml-1 w-4 h-4 bg-gray-400 text-white rounded-full text-xs hover:bg-gray-500 transition-colors" title="Click the edit icon on thumbnails to add titles, descriptions, and prices">
                                        <i class="fas fa-info" style="font-size: 8px;"></i>
                                    </button>
                                </span>
                            </div>
                        </div>



                        <!-- Media Preview Gallery -->
                        <div id="mediaPreviewGallery" class="hidden">
                            <div class="flex space-x-3 overflow-x-auto pb-2" id="mediaPreviewGrid" style="scrollbar-width: thin;">
                                <!-- Media items will be added here -->
                            </div>
                        </div>

                        <!-- Objects Preview Gallery -->
                        <div id="objectsPreview" class="hidden">
                            <div class="flex space-x-3 overflow-x-auto pb-2" id="objectsPreviewGrid" style="scrollbar-width: thin;">
                                <!-- Object items will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Privacy, Event, Payment Toggle Buttons -->
                    <div class="grid grid-cols-3 gap-3">
                        <!-- Privacy Toggle -->
                        <div>
                            <button type="button" id="privacyToggleBtn" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 flex items-center justify-center space-x-2">
                                <i class="fas fa-globe"></i>
                                <span id="privacyToggleText">Public</span>
                                <i id="privacyToggleIcon" class="fas fa-toggle-off text-lg"></i>
                            </button>
                        </div>
                        
                        <!-- Event Toggle -->
                        <div>
                            <button type="button" id="eventToggleBtn" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 flex items-center justify-center space-x-2">
                                <i class="fas fa-calendar-alt"></i>
                                <span id="eventToggleText">Event</span>
                                <i id="eventToggleIcon" class="fas fa-toggle-off text-lg"></i>
                            </button>
                        </div>
                        
                        <!-- Payment Toggle -->
                        <div>
                            <button type="button" id="paymentToggleBtn" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200 flex items-center justify-center space-x-2">
                                <i class="fas fa-credit-card"></i>
                                <span id="paymentToggleText">Payment</span>
                                <i id="paymentToggleIcon" class="fas fa-toggle-off text-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hidden form fields to store event and payment data -->
                    <input type="hidden" id="eventStartDate">
                    <input type="hidden" id="eventStartTime">
                    <input type="hidden" id="eventEndDate">
                    <input type="hidden" id="eventEndTime">
                    <input type="hidden" id="rsvpListVisible">
                    <input type="hidden" id="paymentType" value="free">
                    <input type="hidden" id="paymentAmount">
                    <input type="hidden" id="paymentDetails">
                    <input type="hidden" id="ticketPrice">
                    <input type="hidden" id="ticketQuantityAlt">
                    <input type="hidden" id="crowdfundGoal">
                    <input type="hidden" id="crowdfundRaised" value="0">
                </form>
            </div>
            
            <!-- Fixed Footer with Action Buttons -->
            <div class="flex-shrink-0 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-750">
                <div class="flex justify-between items-center">
                    <button type="button" id="deleteNoteBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors hidden">
                        <i class="fas fa-trash mr-2"></i>Delete Note
                    </button>
                    <div class="flex space-x-3 ml-auto">
                        <button type="button" id="cancelBtn" class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            Cancel
                        </button>
                        <button type="button" id="saveAsTemplateBtn" class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition-colors" title="Save as Template">
                            <i class="fas fa-bookmark mr-1"></i>Template
                        </button>
                        <button type="submit" form="noteForm" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            <i class="fas fa-save mr-2"></i>Save Note
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Note Modal -->
    <div id="viewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] flex flex-col">
            <!-- Header with enhanced info -->
            <div class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-start">
                    <div class="flex-1 pr-4">
                        <h2 id="viewTitle" class="text-xl font-semibold mb-3"></h2>
                        <div class="flex items-center space-x-4 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600" style="border-radius: 50%;">
                                    <img id="viewAuthorPic" src="" alt="Author" class="w-full h-full object-cover bg-gray-200 dark:bg-gray-600" style="border-radius: 50%;">
                                </div>
                                <span id="viewAuthor" class="font-medium"></span>
                            </div>
                            <div class="text-gray-500 dark:text-gray-400">
                                <div class="flex items-center space-x-1">
                                    <i class="fas fa-clock text-xs"></i>
                                    <span id="viewDate"></span>
                                </div>
                                <div id="viewModified" class="hidden flex items-center space-x-1 mt-1">
                                    <i class="fas fa-edit text-xs"></i>
                                    <span id="viewModifiedDate"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="editNoteBtn" class="px-3 py-1 text-sm bg-primary text-white rounded hover:bg-primary/90 transition-colors hidden">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button id="closeViewModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Dynamic Content Container -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Note Content Section (Adaptive Size) -->
                <div id="contentSection" class="transition-all duration-300 ease-in-out overflow-y-auto px-6 pt-6">
                    <div id="viewContent" class="prose dark:prose-invert max-w-none whitespace-pre-wrap"></div>
                    
                    <!-- Event Information Section -->
                    <div id="eventInfoSection" class="hidden mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                        <div class="flex items-start space-x-3">
                            <div class="text-blue-600 dark:text-blue-400">
                                <i class="fas fa-calendar-alt text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-medium text-blue-900 dark:text-blue-100 mb-2">Event Details</h4>
                                <div id="eventDateTime" class="text-sm text-blue-800 dark:text-blue-200 mb-3"></div>
                                
                                <!-- RSVP Button -->
                                <div class="flex items-center justify-between mb-3">
                                    <div id="rsvpCount" class="text-sm text-blue-700 dark:text-blue-300 font-medium"></div>
                                    <button id="rsvpButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                        <i class="fas fa-check mr-2"></i>RSVP
                                    </button>
                                </div>
                                
                                <!-- RSVP List -->
                                <div id="rsvpListSection" class="hidden">
                                    <div class="border-t border-blue-200 dark:border-blue-700 pt-3">
                                        <h5 class="text-xs font-medium text-blue-700 dark:text-blue-300 mb-2 uppercase tracking-wide">Attendees</h5>
                                        <div id="rsvpList" class="space-y-2 max-h-32 overflow-y-auto">
                                            <!-- RSVP users will be listed here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Media Gallery (Expandable) -->
                <div id="mediaSection" class="transition-all duration-300 ease-in-out overflow-hidden">
                    <div id="viewMediaGallery" class="hidden">
                        <div class="px-6 py-3">
                            <div id="mediaScrollContainer" class="overflow-hidden transition-all duration-300 ease-in-out">
                                <div class="flex space-x-3 overflow-x-auto pb-2" id="viewMediaGrid" style="scrollbar-width: thin;">
                                    <!-- Media items will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Objects Gallery (Expandable) -->
                <div id="objectsSection" class="transition-all duration-300 ease-in-out overflow-hidden">
                    <div id="viewObjectsGallery" class="hidden">
                        <div class="px-6 py-3">
                            <div id="objectsScrollContainer" class="overflow-hidden transition-all duration-300 ease-in-out">
                                <div class="flex space-x-3 overflow-x-auto pb-2" id="viewObjectsGrid" style="scrollbar-width: thin;">
                                    <!-- Object items will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Comments Section (Expandable/Collapsible) -->
                <div id="commentsSection" class="flex-shrink-0 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 transition-all duration-300 ease-in-out">
                    <div class="px-6 py-4">
                        <!-- Add Comment Form -->
                        <div id="addCommentForm" class="mb-4 hidden">
                            <div class="flex space-x-3 items-start">
                                <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600 flex-shrink-0">
                                    <img id="commentUserPic" src="" alt="Your profile" class="w-full h-full object-cover bg-gray-200 dark:bg-gray-600">
                                </div>
                                <div class="flex-1 relative">
                                    <div class="flex items-center border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 transition-all duration-200 ease-in-out">
                                        <textarea id="commentInput" rows="1" 
                                                  class="flex-1 px-3 py-2 text-base bg-transparent text-gray-900 dark:text-white focus:outline-none resize-none overflow-hidden"
                                                  placeholder="Add a comment..."
                                                  style="min-height: 40px; max-height: 120px;"></textarea>
                                        <div class="flex items-center space-x-1 px-2">
                                            <button type="button" id="cancelCommentBtn" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors opacity-0 pointer-events-none" title="Cancel">
                                                <i class="fas fa-times text-sm"></i>
                                            </button>
                                            <button type="button" id="submitCommentBtn" class="p-1 text-gray-400 hover:text-primary transition-colors opacity-50 pointer-events-none" title="Post comment" disabled>
                                                <i class="fas fa-check text-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Expanded text preview for long comments -->
                                    <div id="commentPreview" class="hidden mt-2 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                                        <div class="text-sm text-gray-700 dark:text-gray-300">
                                            <span id="commentPreviewText"></span>
                                            <button type="button" id="showLessBtn" class="text-primary hover:text-primary/80 ml-2 font-medium">show less</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Login to Comment Prompt -->
                        <div id="commentLoginPrompt" class="mb-4 p-3 bg-white dark:bg-gray-700 rounded-lg hidden">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Login to join the conversation</span>
                                <button id="loginToCommentBtn" class="px-3 py-1 text-sm bg-primary text-white rounded hover:bg-primary/90 transition-colors">
                                    Login
                                </button>
                            </div>
                        </div>

                        <!-- Comment Count (clickable to toggle visibility) -->
                        <div id="commentCountSection" class="mb-3 hidden">
                            <div id="commentCount" class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400 cursor-pointer hover:text-primary transition-colors">
                                <i id="commentCountArrow" class="fas fa-chevron-right transition-transform duration-200"></i>
                                <span id="commentCountText">0 comments</span>
                            </div>
                        </div>

                        <!-- Comments List Container -->
                        <div id="commentsScrollContainer" class="overflow-y-auto transition-all duration-300 ease-in-out">
                            <div id="commentsList" class="space-y-4">
                                <!-- Comments will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile/Account Settings Modal -->
    <div id="profileSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] flex flex-col">
            <!-- Fixed Header -->
            <div class="flex-shrink-0 flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 id="settingsModalTitle" class="text-xl font-semibold">Edit Profile</h2>
                <button id="closeSettingsModal" onclick="document.getElementById('profileSettingsModal').classList.add('hidden');" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Scrollable Content Area -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Profile Section -->
                <div id="profileSection" class="space-y-6">
                    <!-- Profile Picture -->
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-gray-300 dark:border-gray-600">
                                <img id="editProfilePic" src="" alt="Profile" class="w-full h-full object-cover bg-gray-200 dark:bg-gray-600 rounded-full">
                            </div>
                            <label for="profilePicUpload" class="absolute bottom-0 right-0 w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center cursor-pointer hover:bg-primary/90 transition-colors">
                                <i class="fas fa-camera text-xs"></i>
                                <input type="file" id="profilePicUpload" class="hidden" accept="image/*">
                            </label>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium">Profile Picture</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Click the camera icon to change your profile picture</p>
                            <button id="removeProfilePicBtn" class="text-sm text-red-500 hover:text-red-700 mt-1 hidden">Remove Photo</button>
                        </div>
                    </div>

                    <!-- GPS Visibility -->
                    <div>
                        <label class="block text-sm font-medium mb-2">GPS Visibility</label>
                        <select id="userVisibilitySelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="invisible">üëª Invisible</option>
                            <option value="public">üåç Public</option>
                            <option value="friends">üë• Friends Only</option>
                        </select>
                    </div>

                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Status</label>
                        <input type="text" id="userStatusInput" placeholder="What are you up to?" maxlength="100" 
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>

                    <!-- Bio -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Bio</label>
                        <textarea id="userBioInput" rows="4" 
                                  class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                                  placeholder="Tell others about yourself..."></textarea>
                    </div>

                    <!-- Tags -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Tags</label>
                        <input type="text" id="userTagsInput"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="photographer, foodie, traveler (comma separated)">
                    </div>

                    <!-- Media Upload -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Photos & Videos</label>
                        <div class="space-y-3">
                            <!-- Upload Button -->
                            <label for="profileMediaUpload" class="flex items-center justify-center w-full h-24 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <div class="flex flex-col items-center space-y-2">
                                    <i class="fas fa-camera text-gray-400 text-xl"></i>
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Add photos or videos to your profile</span>
                                </div>
                                <input type="file" id="profileMediaUpload" class="hidden" accept="image/*,video/*" multiple>
                            </label>

                            <!-- Media Preview Gallery -->
                            <div id="profileMediaPreviewGallery" class="hidden">
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="profileMediaPreviewGrid">
                                    <!-- Media items will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Section -->
                <div id="accountSection" class="space-y-6 hidden">
                    <!-- Default Load Location -->
                    <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4 mb-6">
                        <h4 class="font-medium mb-3">Default Map Location</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">When you open LeelaMaps, show:</label>
                                <select id="defaultLocationMode" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="gps">üìç My Current Location (Default)</option>
                                    <option value="custom">üìå Custom Location</option>
                                    <option value="default">üóΩ New York City</option>
                                </select>
                            </div>
                            
                            <!-- Custom Location Settings -->
                            <div id="customLocationSettings" class="hidden space-y-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                    <span id="currentCustomLocation">No custom location set</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button type="button" id="selectLocationBtn" class="flex-1 px-3 py-2 text-sm bg-primary text-white rounded hover:bg-primary/90 transition-colors">
                                        <i class="fas fa-map-marker-alt mr-2"></i>Select on Map
                                    </button>
                                    <button type="button" id="useCurrentGPSBtn" class="flex-1 px-3 py-2 text-sm border border-primary text-primary rounded hover:bg-primary hover:text-white transition-colors">
                                        <i class="fas fa-crosshairs mr-2"></i>Use Current GPS
                                    </button>
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    Click "Select on Map" to choose a location by clicking on the map, or "Use Current GPS" to set your current position.
                                </div>
                            </div>
                            
                            <!-- GPS Status for GPS mode -->
                            <div id="gpsLocationStatus" class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="text-sm text-blue-600 dark:text-blue-400">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    The map will center on your current location when you open LeelaMaps. You'll be prompted to allow location access.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Username -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Username</label>
                        <input type="text" id="editUsername" required
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Username must be unique and can contain letters, numbers, and underscores</p>
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Email</label>
                        <input type="email" id="editEmail" required
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>

                    <!-- Change Password -->
                    <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                        <h4 class="font-medium mb-3">Change Password</h4>
                        <div class="space-y-3">
                            <input type="password" id="currentPassword" placeholder="Current password"
                                   class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <input type="password" id="newPassword" placeholder="New password"
                                   class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <input type="password" id="confirmPassword" placeholder="Confirm new password"
                                   class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>



                    <!-- Payment Method Settings -->
                    <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4 mb-6">
                        <h4 class="font-medium mb-3">Payment Method</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-2">Preferred Payment Method</label>
                                <select id="userPaymentMethod" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Select Payment Method</option>
                                    <option value="venmo">Venmo</option>
                                    <option value="paypal">PayPal</option>
                                    <option value="cashapp">Cash App</option>
                                    <option value="zelle">Zelle</option>
                                    <option value="stripe">Credit/Debit Card (Stripe)</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div id="paymentMethodDetails" class="hidden">
                                <label class="block text-sm font-medium mb-2">Payment Details</label>
                                <input type="text" id="userPaymentDetails" placeholder="e.g., @yourusername, email@example.com, or account info"
                                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    <span id="paymentMethodHint">Enter your payment details</span>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                                <div class="text-sm text-blue-800 dark:text-blue-200">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Required for receiving crowdfund payments. Other payment types can use custom instructions.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Stats -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <h4 class="font-medium mb-2">Account Statistics</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Member since:</span>
                                <div id="memberSinceDate" class="font-medium"></div>
                            </div>
                            <div>
                                <span class="text-gray-500 dark:text-gray-400">Notes created:</span>
                                <div id="userNotesCount" class="font-medium">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Logout Section -->
                    <div class="border border-red-200 dark:border-red-700 rounded-lg p-4 bg-red-50 dark:bg-red-900/20">
                        <h4 class="font-medium mb-3 text-red-700 dark:text-red-300">Account Actions</h4>
                        <button id="accountLogoutBtn" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                        <div class="text-xs text-red-600 dark:text-red-400 mt-2 text-center">
                            You'll need to login again to access your account
                        </div>
                    </div>
                </div>

                <!-- Events Section -->
                <div id="eventsSection" class="space-y-6 hidden">
                    <!-- Events I'm Hosting -->
                    <div id="hostedEventsSection">
                        <h4 class="font-medium mb-3 flex items-center">
                            <i class="fas fa-calendar-plus mr-2 text-primary"></i>
                            Events I'm Hosting
                            <span id="hostedEventsBadge" class="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded-full hidden">0</span>
                        </h4>
                        <div id="hostedEventsList" class="space-y-3">
                            <!-- Hosted events will be populated here -->
                        </div>
                        <div id="noHostedEvents" class="text-sm text-gray-500 dark:text-gray-400 italic">
                            No events created yet. Create a note with an event to start hosting!
                        </div>
                    </div>

                    <!-- Events I've RSVP'd To -->
                    <div id="rsvpedEventsSection">
                        <h4 class="font-medium mb-3 flex items-center">
                            <i class="fas fa-calendar-check mr-2 text-primary"></i>
                            Events I've RSVP'd To
                            <span id="rsvpedEventsBadge" class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded-full hidden">0</span>
                        </h4>
                        <div id="rsvpedEventsList" class="space-y-3">
                            <!-- RSVP'd events will be populated here -->
                        </div>
                        <div id="noRsvpedEvents" class="text-sm text-gray-500 dark:text-gray-400 italic">
                            No event RSVPs yet. RSVP to events to see them here!
                        </div>
                    </div>
                </div>

                <!-- Transactions Section -->
                <div id="transactionsSection" class="space-y-6 hidden">
                    <!-- Incoming Transactions (Money you'll receive) -->
                    <div id="incomingTransactionsSection">
                        <h4 class="font-medium mb-3 flex items-center">
                            <i class="fas fa-arrow-down mr-2 text-green-600"></i>
                            Incoming Payments
                            <span id="incomingTransactionsBadge" class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded-full hidden">0</span>
                        </h4>
                        <div id="incomingTransactionsList" class="space-y-3">
                            <!-- Incoming transactions will be populated here -->
                        </div>
                        <div id="noIncomingTransactions" class="text-sm text-gray-500 dark:text-gray-400 italic">
                            No incoming payments yet.
                        </div>
                    </div>

                    <!-- Outgoing Transactions (Money you'll send) -->
                    <div id="outgoingTransactionsSection">
                        <h4 class="font-medium mb-3 flex items-center">
                            <i class="fas fa-arrow-up mr-2 text-blue-600"></i>
                            Outgoing Payments
                            <span id="outgoingTransactionsBadge" class="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded-full hidden">0</span>
                        </h4>
                        <div id="outgoingTransactionsList" class="space-y-3">
                            <!-- Outgoing transactions will be populated here -->
                        </div>
                        <div id="noOutgoingTransactions" class="text-sm text-gray-500 dark:text-gray-400 italic">
                            No outgoing payments yet.
                        </div>
                    </div>
                </div>

                <!-- Friends Section -->
                <div id="friendsSection" class="space-y-6 hidden">
                    <!-- Friend Requests Section -->
                    <div id="friendRequestsSection">
                        <h4 class="font-medium mb-3 flex items-center">
                            <i class="fas fa-user-clock mr-2 text-primary"></i>
                            Friend Requests
                            <span id="friendRequestsBadge" class="ml-2 text-xs bg-red-500 text-white px-2 py-1 rounded-full hidden">0</span>
                        </h4>
                        <div id="friendRequestsList" class="space-y-3">
                            <!-- Friend requests will be populated here -->
                        </div>
                        <div id="noFriendRequests" class="text-sm text-gray-500 dark:text-gray-400 italic">
                            No pending friend requests
                        </div>
                    </div>

                    <!-- Current Friends Section -->
                    <div id="currentFriendsSection">
                        <h4 class="font-medium mb-3 flex items-center">
                            <i class="fas fa-users mr-2 text-primary"></i>
                            Friends
                            <span id="friendsCountBadge" class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded-full hidden">0</span>
                        </h4>
                        <div id="currentFriendsList" class="space-y-3">
                            <!-- Current friends will be populated here -->
                        </div>
                        <div id="noCurrentFriends" class="text-sm text-gray-500 dark:text-gray-400 italic">
                            No friends yet. Add friends by visiting their profiles!
                        </div>
                    </div>

                    <!-- Sent Requests Section -->
                    <div id="sentRequestsSection">
                        <h4 class="font-medium mb-3 flex items-center">
                            <i class="fas fa-paper-plane mr-2 text-primary"></i>
                            Sent Requests
                            <span id="sentRequestsBadge" class="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded-full hidden">0</span>
                        </h4>
                        <div id="sentRequestsList" class="space-y-3">
                            <!-- Sent requests will be populated here -->
                        </div>
                        <div id="noSentRequests" class="text-sm text-gray-500 dark:text-gray-400 italic">
                            No pending sent requests
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer with tabs and save button -->
            <div class="border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-750">
                <!-- Tab Navigation -->
                <div class="flex border-b border-gray-200 dark:border-gray-600">
                    <button id="profileTab" onclick="switchSettingsTab('profile');" class="flex-1 px-4 py-3 text-sm font-medium text-primary border-b-2 border-primary bg-white dark:bg-gray-800">
                        <i class="fas fa-user mr-2"></i>Profile
                    </button>
                    <button id="accountTab" onclick="switchSettingsTab('account');" class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-50 dark:bg-gray-750">
                        <i class="fas fa-cog mr-2"></i>Account
                    </button>
                    <button id="friendsTab" onclick="switchSettingsTab('friends');" class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-50 dark:bg-gray-750">
                        <i class="fas fa-users mr-2"></i>Friends
                    </button>
                    <button id="eventsTab" onclick="switchSettingsTab('events');" class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-50 dark:bg-gray-750">
                        <i class="fas fa-calendar-alt mr-2"></i>Events
                    </button>
                    <button id="transactionsTab" onclick="switchSettingsTab('transactions');" class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 bg-gray-50 dark:bg-gray-750">
                        <i class="fas fa-receipt mr-2"></i>Transactions
                    </button>
                </div>

                <!-- Action Buttons -->
                <div class="p-4 flex justify-end space-x-3">
                    <button id="cancelSettingsBtn" onclick="document.getElementById('profileSettingsModal').classList.add('hidden');" class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button id="saveSettingsBtn" onclick="saveProfileSettings();" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global variables
        let map;
        let notes = [];
        let users = [];
        let currentUser = null;
        let currentNoteId = null;
        let selectedPinStyle = { type: 'emoji', value: 'üìç' };
        let currentNoteLat = null;
        let currentNoteLng = null;
        let mapMarkers = [];
        let filteredNotes = []; // Stores currently filtered notes
        let activeFilters = {
            search: '',
            author: '',
            tag: ''
        };
        let highlightedMarker = null; // Track currently highlighted pin

        // Toggle states for note creation
        let privacyEnabled = false;
        let eventEnabled = false;
        let paymentEnabled = false;

        // Objects management
        let currentNoteObjects = []; // Store current note's object cards
        let lastUsedCurrency = 'USD'; // Remember last used currency

        // Clear data functions
        function clearEventData() {
            document.getElementById('eventStartDate').value = '';
            document.getElementById('eventStartTime').value = '';
            document.getElementById('eventEndDate').value = '';
            document.getElementById('eventEndTime').value = '';
            document.getElementById('rsvpListVisible').value = 'false';
            document.getElementById('eventToggleText').textContent = 'Event';
        }

        function clearPaymentData() {
            document.getElementById('paymentType').value = 'free';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentDetails').value = '';
            document.getElementById('ticketPrice').value = '';
            document.getElementById('ticketQuantityAlt').value = '';
            document.getElementById('crowdfundGoal').value = '';
            document.getElementById('crowdfundRaised').value = '0';
            document.getElementById('paymentToggleText').textContent = 'Payment';
        }

        // Toggle update functions
        function updatePrivacyToggle() {
            const btn = document.getElementById('privacyToggleBtn');
            const icon = document.getElementById('privacyToggleIcon');
            const text = document.getElementById('privacyToggleText');
            
            if (privacyEnabled) {
                btn.classList.add('bg-primary', 'text-white', 'border-primary');
                btn.classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'border-gray-300', 'dark:border-gray-600');
                icon.classList.remove('fa-toggle-off');
                icon.classList.add('fa-toggle-on');
                text.textContent = 'Privacy';
            } else {
                btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                btn.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'border-gray-300', 'dark:border-gray-600');
                icon.classList.remove('fa-toggle-on');
                icon.classList.add('fa-toggle-off');
                text.textContent = 'Public';
            }
        }

        function updateEventToggle() {
            const btn = document.getElementById('eventToggleBtn');
            const icon = document.getElementById('eventToggleIcon');
            
            if (eventEnabled) {
                btn.classList.add('bg-primary', 'text-white', 'border-primary');
                btn.classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'border-gray-300', 'dark:border-gray-600');
                icon.classList.remove('fa-toggle-off');
                icon.classList.add('fa-toggle-on');
            } else {
                btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                btn.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'border-gray-300', 'dark:border-gray-600');
                icon.classList.remove('fa-toggle-on');
                icon.classList.add('fa-toggle-off');
            }
        }

        function updatePaymentToggle() {
            const btn = document.getElementById('paymentToggleBtn');
            const icon = document.getElementById('paymentToggleIcon');
            
            if (paymentEnabled) {
                btn.classList.add('bg-primary', 'text-white', 'border-primary');
                btn.classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'border-gray-300', 'dark:border-gray-600');
                icon.classList.remove('fa-toggle-off');
                icon.classList.add('fa-toggle-on');
            } else {
                btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                btn.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'border-gray-300', 'dark:border-gray-600');
                icon.classList.remove('fa-toggle-on');
                icon.classList.add('fa-toggle-off');
            }
        }

        // Default emoji collection
        const defaultEmojis = ['üìç', 'üìå', 'üè†', 'üè¢', 'üçï', '‚òï', 'üç∫', 'üõí', '‚õΩ', 'üè•', 'üè´', 'üèõÔ∏è', 'üé≠', 'üé™', 'üé®', 'üå≥', 'üå∏', 'üèîÔ∏è', 'üèñÔ∏è', 'üåä', '‚≠ê', 'üíé', '‚ù§Ô∏è', 'üíô', 'üíö', 'üíõ', 'üíú', 'üß°', 'üî•', '‚ö°'];

        // Pin collection management
        function getUserEmojis() {
            if (!currentUser) return defaultEmojis;
            if (!currentUser.customEmojis) {
                currentUser.customEmojis = [];
            }
            return [...defaultEmojis, ...currentUser.customEmojis];
        }

        function getUserCustomArt() {
            if (!currentUser) return [];
            if (!currentUser.customPins) {
                currentUser.customPins = [];
            }
            return currentUser.customPins;
        }

        function addEmojiToCollection(emoji) {
            if (!currentUser) return;
            if (!currentUser.customEmojis) {
                currentUser.customEmojis = [];
            }
            
            if (!currentUser.customEmojis.includes(emoji) && !defaultEmojis.includes(emoji)) {
                currentUser.customEmojis.push(emoji);
                updatePinGrids();
                showNotification(`Emoji ${emoji} added to collection!`, 'success');
            }
        }

        function addCustomPinToCollection(dataUrl) {
            if (!currentUser) return;
            if (!currentUser.customPins) {
                currentUser.customPins = [];
            }
            
            const newPin = {
                id: Date.now() + Math.random(),
                type: 'custom',
                value: dataUrl,
                createdAt: new Date()
            };
            
            currentUser.customPins.push(newPin);
            updatePinGrids();
            showNotification('Custom pin added to collection!', 'success');
        }

        function updatePinGrids() {
            updateEmojiGrid();
            updateCustomArtGrid();
        }

        function updateEmojiGrid() {
            const emojiGrid = document.getElementById('emojiGrid');
            const userEmojis = getUserEmojis();

            let emojiHTML = userEmojis.map(emoji => {
                return `<button type="button" class="pin-grid-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded text-xl relative" data-type="emoji" data-value="${emoji}">
                    ${emoji}
                </button>`;
            }).join('');

            emojiGrid.innerHTML = emojiHTML;

            // Add event listeners
            emojiGrid.querySelectorAll('.pin-grid-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const emoji = btn.dataset.value;
                    selectedPinStyle = { type: 'emoji', value: emoji };
                    document.getElementById('selectedEmojiDisplay').textContent = emoji;
                    document.getElementById('emojiDropdown').classList.add('hidden');
                    document.getElementById('customPinPreview').classList.add('hidden');
                });
            });
        }

        function updateCustomArtGrid() {
            const customArtGrid = document.getElementById('customArtGrid');
            const emptyCustomArt = document.getElementById('emptyCustomArt');
            const userCustomArt = getUserCustomArt();

            if (userCustomArt.length === 0) {
                customArtGrid.innerHTML = '';
                emptyCustomArt.classList.remove('hidden');
            } else {
                emptyCustomArt.classList.add('hidden');
                customArtGrid.innerHTML = userCustomArt.map(pin => {
                    return `<button type="button" class="pin-grid-btn p-1 hover:bg-gray-100 dark:hover:bg-gray-600 rounded relative" data-type="custom" data-value="${pin.value}" data-id="${pin.id}">
                        <img src="${pin.value}" class="w-6 h-6 rounded object-cover" alt="Custom pin">
                    </button>`;
                }).join('');

                // Add event listeners
                customArtGrid.querySelectorAll('.pin-grid-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const pinValue = btn.dataset.value;
                        selectedPinStyle = { type: 'custom', value: pinValue };
                        document.getElementById('selectedEmojiDisplay').innerHTML = `<img src="${pinValue}" class="w-6 h-6 rounded-full object-cover" alt="Custom pin">`;
                        document.getElementById('emojiDropdown').classList.add('hidden');
                        document.getElementById('customPinPreview').classList.add('hidden');
                    });
                });
            }
        }

        // File handling
        function createImageDataUrl(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        async function handleCustomPinUpload(file) {
            if (file && file.type.startsWith('image/')) {
                const dataUrl = await createImageDataUrl(file);
                selectedPinStyle = { type: 'custom', value: dataUrl };
                
                document.getElementById('customPinImage').src = dataUrl;
                document.getElementById('customPinPreview').classList.remove('hidden');
                document.getElementById('selectedEmojiDisplay').innerHTML = `<img src="${dataUrl}" class="w-6 h-6 rounded-full object-cover" alt="Custom pin">`;
                
                // Also add to collection if user is logged in
                if (currentUser) {
                    addCustomPinToCollection(dataUrl);
                }
            }
        }

        function removeCustomPin() {
            selectedPinStyle = { type: 'emoji', value: 'üìç' };
            document.getElementById('customPinPreview').classList.add('hidden');
            document.getElementById('selectedEmojiDisplay').textContent = 'üìç';
        }

        function updatePinStyleFromTemplate(pinStyle) {
            // Clear any existing custom pin preview first
            document.getElementById('customPinPreview').classList.add('hidden');
            
            if (pinStyle.type === 'emoji') {
                // Handle emoji pins
                document.getElementById('selectedEmojiDisplay').textContent = pinStyle.value;
            } else if (pinStyle.type === 'custom') {
                // Handle custom pin art - check if it's a valid image
                if (pinStyle.value && pinStyle.value.startsWith('data:image/')) {
                    // Show in dropdown selector
                    document.getElementById('selectedEmojiDisplay').innerHTML = `<img src="${pinStyle.value}" class="w-4 h-4 rounded inline" alt="Custom"> Custom`;
                    
                    // Also show in quick upload preview
                    document.getElementById('customPinImage').src = pinStyle.value;
                    document.getElementById('customPinPreview').classList.remove('hidden');
                } else {
                    // Invalid custom pin data, fallback to default emoji
                    selectedPinStyle = { type: 'emoji', value: 'üìç' };
                    document.getElementById('selectedEmojiDisplay').textContent = 'üìç';
                    showNotification('Template contains invalid custom pin art, using default pin', 'error');
                }
            } else {
                // Unknown pin type, fallback to default emoji
                selectedPinStyle = { type: 'emoji', value: 'üìç' };
                document.getElementById('selectedEmojiDisplay').textContent = 'üìç';
            }
        }

        // Preset note templates
        const presetTemplates = [
            {
                id: 'restaurant',
                name: 'üçΩÔ∏è Restaurant Review',
                title: '',
                content: 'Rating: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê\n\nWhat I ordered:\n\nHighlights:\n\nPrice range: $$\n\nWould I return? Yes/No\n\nNotes:',
                tags: 'restaurant, food, dining',
                pinStyle: { type: 'emoji', value: 'üçï' }
            },
            {
                id: 'coffee',
                name: '‚òï Coffee Shop',
                title: '',
                content: 'Coffee quality: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê\nWiFi: Yes/No\nAtmosphere: \nPerfect for: work/study/socializing\n\nFavorite drink:\n\nNotes:',
                tags: 'coffee, cafe, work, wifi',
                pinStyle: { type: 'emoji', value: '‚òï' }
            },
            {
                id: 'photo-spot',
                name: 'üì∑ Photo Spot',
                title: '',
                content: 'Best time to visit: \nLighting: \nCrowd level: \nAccessibility: \n\nWhat makes it special:\n\nTips for photographers:',
                tags: 'photography, scenic, views, instagram',
                pinStyle: { type: 'emoji', value: 'üìç' }
            },
            {
                id: 'nature',
                name: 'üå≤ Nature Spot',
                title: '',
                content: 'Type: Park/Trail/Beach/Garden\nDifficulty: Easy/Moderate/Hard\nBest season: \nFacilities: \n\nWhat you\'ll see:\n\nBring:\n\nParking:',
                tags: 'nature, outdoor, hiking, park',
                pinStyle: { type: 'emoji', value: 'üå≥' }
            }
        ];

        // Template management functions
        function getUserTemplates() {
            if (!currentUser) return [];
            if (!currentUser.templates) {
                currentUser.templates = [];
            }
            return currentUser.templates;
        }

        function populateTemplateSelector() {
            const selector = document.getElementById('templateSelector');
            const presetGroup = selector.querySelector('optgroup[label="Preset Templates"]');
            const userGroup = document.getElementById('userTemplatesGroup');
            
            // Clear existing options
            presetGroup.innerHTML = '';
            userGroup.innerHTML = '';
            
            // Add preset templates
            presetTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = `preset:${template.id}`;
                option.textContent = template.name;
                presetGroup.appendChild(option);
            });
            
            // Add user templates
            const userTemplates = getUserTemplates();
            if (userTemplates.length > 0) {
                userGroup.classList.remove('hidden');
                userTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = `user:${template.id}`;
                    option.textContent = template.name;
                    userGroup.appendChild(option);
                });
            } else {
                userGroup.classList.add('hidden');
            }
        }

        function applyTemplate(templateValue) {
            if (!templateValue) {
                // Clear custom pin preview when no template selected
                document.getElementById('customPinPreview').classList.add('hidden');
                selectedPinStyle = { type: 'emoji', value: 'üìç' };
                document.getElementById('selectedEmojiDisplay').textContent = 'üìç';
                return;
            }
            
            const [type, id] = templateValue.split(':');
            let template = null;
            
            if (type === 'preset') {
                template = presetTemplates.find(t => t.id === id);
            } else if (type === 'user') {
                template = getUserTemplates().find(t => t.id === id);
            }
            
            if (!template) return;
            
            // Apply template values to form
            document.getElementById('noteTitle').value = template.title || '';
            document.getElementById('noteContent').value = template.content || '';
            document.getElementById('noteTags').value = template.tags || '';
            
            // Apply pin style and clear any existing custom pin preview
            if (template.pinStyle) {
                selectedPinStyle = template.pinStyle;
                updatePinStyleFromTemplate(template.pinStyle);
            } else {
                // Default pin style if template doesn't have one
                selectedPinStyle = { type: 'emoji', value: 'üìç' };
                document.getElementById('selectedEmojiDisplay').textContent = 'üìç';
                document.getElementById('customPinPreview').classList.add('hidden');
            }
        }

        function saveAsTemplate() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const tags = document.getElementById('noteTags').value.trim();
            
            if (!currentUser) {
                showAlert('Please login to save templates');
                return;
            }
            
            if (!title && !content && !tags) {
                showAlert('Please fill in some content before saving as a template');
                return;
            }
            
            showSaveTemplateModal(title, content, tags, selectedPinStyle);
        }

        function showSaveTemplateModal(title, content, tags, pinStyle) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Save as Template</h3>
                        <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Template Name</label>
                            <input type="text" id="templateName" required
                                   class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                   placeholder="e.g., My Restaurant Review">
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                            <h4 class="font-medium text-sm mb-2">Template Preview:</h4>
                            <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                <div><strong>Title:</strong> ${title || '(empty)'}</div>
                                <div><strong>Content:</strong> ${content.length > 50 ? content.substring(0, 50) + '...' : content || '(empty)'}</div>
                                <div><strong>Tags:</strong> ${tags || '(empty)'}</div>
                                <div><strong>Pin:</strong> ${pinStyle.value}</div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded">Save Template</button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.querySelector('form').onsubmit = (e) => {
                e.preventDefault();
                const templateName = document.getElementById('templateName').value.trim();
                
                if (!templateName) {
                    showAlert('Please enter a template name');
                    return;
                }
                
                // Check if template name already exists
                const userTemplates = getUserTemplates();
                if (userTemplates.some(t => t.name === templateName)) {
                    showAlert('A template with this name already exists');
                    return;
                }
                
                // Create new template
                const newTemplate = {
                    id: Date.now() + Math.random(),
                    name: templateName,
                    title: title,
                    content: content,
                    tags: tags,
                    pinStyle: pinStyle,
                    createdAt: new Date()
                };
                
                // Add to user's templates
                if (!currentUser.templates) {
                    currentUser.templates = [];
                }
                currentUser.templates.push(newTemplate);
                
                // Update UI
                populateTemplateSelector();
                modal.remove();
                
                showNotification(`Template "${templateName}" saved successfully!`, 'success');
            };
            
            document.body.appendChild(modal);
        }

        function showManageTemplatesModal() {
            if (!currentUser) {
                showAlert('Please login to manage templates');
                return;
            }
            
            const userTemplates = getUserTemplates();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Manage Templates</h3>
                        <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium mb-2">Preset Templates</h4>
                            <div class="space-y-2 max-h-32 overflow-y-auto">
                                ${presetTemplates.map(template => `
                                    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                        <span class="text-sm">${template.name}</span>
                                        <span class="text-xs text-gray-500">Preset</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-medium mb-2">My Templates (${userTemplates.length})</h4>
                            ${userTemplates.length === 0 ? 
                                '<p class="text-sm text-gray-500 dark:text-gray-400 italic">No custom templates yet. Create a note and save it as a template!</p>' :
                                `<div class="space-y-2 max-h-40 overflow-y-auto" id="userTemplatesList">
                                    ${userTemplates.map(template => `
                                        <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                            <div class="flex-1">
                                                <div class="text-sm font-medium">${template.name}</div>
                                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                                    Created ${template.createdAt.toLocaleDateString()}
                                                </div>
                                            </div>
                                            <div class="flex space-x-2">
                                                <button class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600" 
                                                        data-template-id="${template.id}">Delete</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>`
                            }
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button class="close-btn px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded">Close</button>
                    </div>
                </div>
            `;
            
            // Add event listeners for delete buttons
            modal.querySelectorAll('[data-template-id]').forEach(btn => {
                btn.onclick = () => {
                    const templateId = btn.dataset.templateId;
                    const template = getUserTemplates().find(t => t.id == templateId);
                    if (template) {
                        showConfirmDialog(`Are you sure you want to delete "${template.name}"?`, () => {
                            // Remove template
                            currentUser.templates = currentUser.templates.filter(t => t.id != templateId);
                            // Update selector
                            populateTemplateSelector();
                            // Close and reopen modal to refresh
                            modal.remove();
                            showManageTemplatesModal();
                            showNotification(`Template "${template.name}" deleted`, 'success');
                        });
                    }
                };
            });
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        // Profile management
        function getDefaultProfilePicture() {
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            const gradient = ctx.createLinearGradient(0, 0, 100, 100);
            gradient.addColorStop(0, '#5D5CDE');
            gradient.addColorStop(1, '#8B5CF6');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 100, 100);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('üë§', 50, 50);
            
            return canvas.toDataURL();
        }

        function getUserProfilePicture(user) {
            return user.profilePicture || getDefaultProfilePicture();
        }

        function updateProfilePictures() {
            if (!currentUser) return;
            
            const profilePic = getUserProfilePicture(currentUser);
            
            // Update header profile picture
            const headerProfilePic = document.getElementById('headerProfilePic');
            if (headerProfilePic) {
                headerProfilePic.src = profilePic;
            }
            
            // Update header user info
            const currentUserName = document.getElementById('currentUserName');
            if (currentUserName) {
                currentUserName.textContent = currentUser.username;
            }
            
            const currentUserStatus = document.getElementById('currentUserStatus');
            if (currentUserStatus) {
                currentUserStatus.textContent = currentUser.status || 'Available';
            }
        }

        function showProfileSettingsModal(section = 'profile') {
            console.log('showProfileSettingsModal called with section:', section);
            if (!currentUser) {
                showAlert('Please login to edit profile');
                return;
            }
            
            // Set current section
            switchSettingsTab(section);
            
            // Populate current values
            populateProfileSettings();
            
            // Show modal
            const modal = document.getElementById('profileSettingsModal');
            console.log('Modal element found:', !!modal);
            console.log('Modal classes before:', modal.className);
            modal.classList.remove('hidden');
            console.log('Modal classes after:', modal.className);
            console.log('Profile settings modal should now be visible');
        }
        
        // Make function globally accessible
        window.showProfileSettingsModal = showProfileSettingsModal;

        function switchSettingsTab(sectionName) {
            // Update tabs
            const tabs = ['profileTab', 'accountTab', 'friendsTab', 'eventsTab'];
            const sections = ['profileSection', 'accountSection', 'friendsSection', 'eventsSection'];
            
            tabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tabId === sectionName + 'Tab') {
                    tab.classList.add('text-primary', 'border-b-2', 'border-primary', 'bg-white', 'dark:bg-gray-800');
                    tab.classList.remove('text-gray-500', 'dark:text-gray-400', 'bg-gray-50', 'dark:bg-gray-750');
                } else {
                    tab.classList.remove('text-primary', 'border-b-2', 'border-primary', 'bg-white', 'dark:bg-gray-800');
                    tab.classList.add('text-gray-500', 'dark:text-gray-400', 'bg-gray-50', 'dark:bg-gray-750');
                }
            });
            
            // Update sections
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (sectionId === sectionName + 'Section') {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
            
            // Update modal title
            const title = document.getElementById('settingsModalTitle');
            switch (sectionName) {
                case 'profile':
                    title.textContent = 'Edit Profile';
                    break;
                case 'account':
                    title.textContent = 'Account Settings';
                    break;
                case 'friends':
                    title.textContent = 'Friends';
                    // Render friends data when switching to friends section
                    renderFriendsSection();
                    // Clear notifications when friends section is accessed
                    clearFriendNotifications();
                    break;
                case 'events':
                    title.textContent = 'Events';
                    // Render events data when switching to events section
                    renderEventsSection();
                    break;
            }
        }

        // Profile media management
        let currentProfileMedia = []; // Store current profile media

        function addMediaToProfile(files) {
            const promises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const mediaItem = {
                            id: Date.now() + Math.random(),
                            type: file.type.startsWith('image/') ? 'image' : 'video',
                            data: e.target.result,
                            name: file.name,
                            size: file.size
                        };
                        resolve(mediaItem);
                    };
                    reader.readAsDataURL(file);
                });
            });

            Promise.all(promises).then(mediaItems => {
                currentProfileMedia.push(...mediaItems);
                updateProfileMediaPreview();
            });
        }

        function removeMediaFromProfile(mediaId) {
            currentProfileMedia = currentProfileMedia.filter(item => item.id !== mediaId);
            updateProfileMediaPreview();
        }

        // Make removeMediaFromProfile globally accessible for onclick handlers
        window.removeMediaFromProfile = removeMediaFromProfile;
        
        // Global friend system functions for onclick handlers
        window.sendFriendRequest = sendFriendRequest;
        window.acceptFriendRequest = acceptFriendRequest;
        window.declineFriendRequest = declineFriendRequest;
        window.removeFriend = removeFriend;
        
        // Global transaction functions
        window.createTransaction = createTransaction;
        window.approveTransaction = approveTransaction;
        window.cancelTransaction = cancelTransaction;
        
        // Transaction management functions
        function createTransaction(type, amount, recipientId, details, noteId = null) {
            if (!currentUser) return null;
            
            const recipient = users.find(u => u.id === recipientId);
            if (!recipient) return null;
            
            const transaction = {
                id: Date.now() + Math.random(),
                type: type, // 'donation', 'payment', 'purchase', 'ticket'
                amount: amount,
                payerId: currentUser.id,
                payerName: currentUser.username,
                payeeId: recipientId,
                payeeName: recipient.username,
                details: details,
                noteId: noteId,
                status: 'pending', // 'pending', 'approved', 'cancelled', 'completed'
                createdAt: new Date()
            };
            
            // Add to both users' transaction arrays
            if (!currentUser.transactions) currentUser.transactions = [];
            if (!recipient.transactions) recipient.transactions = [];
            
            currentUser.transactions.push(transaction);
            recipient.transactions.push(transaction);
            
            showNotification(`Payment request sent to ${recipient.username}!`, 'success');
            return transaction;
        }
        
        function approveTransaction(transactionId) {
            if (!currentUser) return false;
            
            const transaction = currentUser.transactions?.find(t => t.id === transactionId);
            if (!transaction || transaction.payeeId !== currentUser.id) {
                return false;
            }
            
            // Update transaction status
            transaction.status = 'approved';
            
            // Update the same transaction in payer's list
            const payer = users.find(u => u.id === transaction.payerId);
            if (payer) {
                const payerTransaction = payer.transactions?.find(t => t.id === transactionId);
                if (payerTransaction) {
                    payerTransaction.status = 'approved';
                }
            }
            
            showNotification(`Payment approved! Transaction completed.`, 'success');
            
            // Refresh transactions if modal is open
            if (!document.getElementById('profileSettingsModal').classList.contains('hidden')) {
                renderTransactionsSection();
            }
            
            return true;
        }
        
        function cancelTransaction(transactionId) {
            if (!currentUser) return false;
            
            const transaction = currentUser.transactions?.find(t => t.id === transactionId);
            if (!transaction) return false;
            
            // Only payer can cancel, or payee can decline
            if (transaction.payerId !== currentUser.id && transaction.payeeId !== currentUser.id) {
                return false;
            }
            
            // Update transaction status
            transaction.status = 'cancelled';
            
            // Update the same transaction in the other user's list
            const otherUserId = transaction.payerId === currentUser.id ? transaction.payeeId : transaction.payerId;
            const otherUser = users.find(u => u.id === otherUserId);
            if (otherUser) {
                const otherTransaction = otherUser.transactions?.find(t => t.id === transactionId);
                if (otherTransaction) {
                    otherTransaction.status = 'cancelled';
                }
            }
            
            const action = transaction.payerId === currentUser.id ? 'cancelled' : 'declined';
            showNotification(`Payment ${action} successfully.`, 'success');
            
            // Refresh transactions if modal is open
            if (!document.getElementById('profileSettingsModal').classList.contains('hidden')) {
                renderTransactionsSection();
            }
            
            return true;
        }
        
        function renderTransactionsSection() {
            if (!currentUser) return;
            
            // Initialize transactions array if it doesn't exist
            if (!currentUser.transactions) currentUser.transactions = [];
            
            // Separate incoming (where user is payee) and outgoing (where user is payer)
            const incomingTransactions = currentUser.transactions.filter(t => 
                t.payeeId === currentUser.id && t.status === 'pending'
            );
            const outgoingTransactions = currentUser.transactions.filter(t => 
                t.payerId === currentUser.id && (t.status === 'pending' || t.status === 'approved')
            );
            
            renderIncomingTransactions(incomingTransactions);
            renderOutgoingTransactions(outgoingTransactions);
        }
        
        function renderIncomingTransactions(transactions) {
            const transactionsList = document.getElementById('incomingTransactionsList');
            const noTransactionsDiv = document.getElementById('noIncomingTransactions');
            const transactionsBadge = document.getElementById('incomingTransactionsBadge');
            
            if (transactions.length === 0) {
                transactionsList.innerHTML = '';
                noTransactionsDiv.classList.remove('hidden');
                transactionsBadge.classList.add('hidden');
            } else {
                noTransactionsDiv.classList.add('hidden');
                transactionsBadge.classList.remove('hidden');
                transactionsBadge.textContent = transactions.length;
                
                transactionsList.innerHTML = transactions.map(transaction => {
                    const timeAgo = getTimeAgo(transaction.createdAt);
                    const typeIcon = {
                        'donation': 'üéÅ',
                        'payment': 'üí≥',
                        'purchase': 'üõí',
                        'ticket': 'üé´'
                    }[transaction.type] || 'üí∞';
                    
                    return `
                        <div class="p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <span class="text-lg">${typeIcon}</span>
                                        <h4 class="font-medium text-sm">${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)} Request</h4>
                                        <span class="text-sm font-bold text-green-600 dark:text-green-400">$${transaction.amount.toFixed(2)}</span>
                                    </div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                        <div><i class="fas fa-user mr-1"></i>From: ${transaction.payerName}</div>
                                        <div><i class="fas fa-clock mr-1"></i>${timeAgo}</div>
                                        ${transaction.details ? `<div><i class="fas fa-info mr-1"></i>${transaction.details}</div>` : ''}
                                        ${transaction.noteId ? `<div><i class="fas fa-map-marked-alt mr-1"></i>Related to a note</div>` : ''}
                                    </div>
                                </div>
                                <div class="flex space-x-2 ml-3">
                                    <button class="px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 transition-colors" onclick="approveTransaction(${transaction.id});">
                                        <i class="fas fa-check mr-1"></i>Approve
                                    </button>
                                    <button class="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors" onclick="cancelTransaction(${transaction.id});">
                                        <i class="fas fa-times mr-1"></i>Decline
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function renderOutgoingTransactions(transactions) {
            const transactionsList = document.getElementById('outgoingTransactionsList');
            const noTransactionsDiv = document.getElementById('noOutgoingTransactions');
            const transactionsBadge = document.getElementById('outgoingTransactionsBadge');
            
            if (transactions.length === 0) {
                transactionsList.innerHTML = '';
                noTransactionsDiv.classList.remove('hidden');
                transactionsBadge.classList.add('hidden');
            } else {
                noTransactionsDiv.classList.add('hidden');
                transactionsBadge.classList.remove('hidden');
                transactionsBadge.textContent = transactions.length;
                
                transactionsList.innerHTML = transactions.map(transaction => {
                    const timeAgo = getTimeAgo(transaction.createdAt);
                    const typeIcon = {
                        'donation': 'üéÅ',
                        'payment': 'üí≥',
                        'purchase': 'üõí',
                        'ticket': 'üé´'
                    }[transaction.type] || 'üí∞';
                    
                    const statusClass = {
                        'pending': 'text-yellow-600 dark:text-yellow-400',
                        'approved': 'text-green-600 dark:text-green-400',
                        'cancelled': 'text-red-600 dark:text-red-400'
                    }[transaction.status] || 'text-gray-600';
                    
                    const statusText = {
                        'pending': 'Waiting for approval',
                        'approved': 'Approved ‚úì',
                        'cancelled': 'Cancelled'
                    }[transaction.status] || transaction.status;
                    
                    return `
                        <div class="p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <span class="text-lg">${typeIcon}</span>
                                        <h4 class="font-medium text-sm">${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</h4>
                                        <span class="text-sm font-bold text-blue-600 dark:text-blue-400">$${transaction.amount.toFixed(2)}</span>
                                    </div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                        <div><i class="fas fa-user mr-1"></i>To: ${transaction.payeeName}</div>
                                        <div><i class="fas fa-clock mr-1"></i>${timeAgo}</div>
                                        <div class="${statusClass}"><i class="fas fa-info-circle mr-1"></i>${statusText}</div>
                                        ${transaction.details ? `<div><i class="fas fa-info mr-1"></i>${transaction.details}</div>` : ''}
                                        ${transaction.noteId ? `<div><i class="fas fa-map-marked-alt mr-1"></i>Related to a note</div>` : ''}
                                    </div>
                                </div>
                                <div class="flex space-x-2 ml-3">
                                    ${transaction.status === 'pending' ? `
                                        <button class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 transition-colors" onclick="cancelTransaction(${transaction.id});">
                                            <i class="fas fa-times mr-1"></i>Cancel
                                        </button>
                                    ` : ''}
                                    ${transaction.noteId ? `
                                        <button class="px-2 py-1 text-xs bg-primary text-white rounded hover:bg-primary/90 transition-colors" onclick="viewNoteFromTransaction(${transaction.noteId});">
                                            <i class="fas fa-eye mr-1"></i>View Note
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function viewNoteFromTransaction(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (note) {
                document.getElementById('profileSettingsModal').classList.add('hidden');
                showViewModal(note);
            }
        }
        
        window.viewNoteFromTransaction = viewNoteFromTransaction;
        
        // Friend button helper functions
        function updateFriendButton(buttonElement, userId) {
            const friendshipStatus = getFriendshipStatus(userId);
            const user = users.find(u => u.id === userId);
            
            if (!user || !buttonElement) return;
            
            if (friendshipStatus === 'friends') {
                buttonElement.innerHTML = '<i class="fas fa-check mr-2"></i>Friends';
                buttonElement.className = 'friend-action-btn px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors';
                buttonElement.onclick = () => showUnfriendConfirm(userId, buttonElement);
            } else if (friendshipStatus === 'pending') {
                buttonElement.innerHTML = '<i class="fas fa-clock mr-2"></i>Request Sent';
                buttonElement.className = 'friend-action-btn px-4 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed';
                buttonElement.disabled = true;
                buttonElement.onclick = null;
            }
        }
        
        function showUnfriendConfirm(userId, buttonElement) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            showConfirmDialog(`Remove ${user.username} from friends?`, () => {
                if (removeFriend(userId)) {
                    buttonElement.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Add Friend';
                    buttonElement.className = 'friend-action-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors';
                    buttonElement.disabled = false;
                    buttonElement.onclick = () => {
                        sendFriendRequest(userId);
                        updateFriendButton(buttonElement, userId);
                    };
                    
                    // Update friends list if friends modal is open
                    if (document.getElementById('profileSettingsModal').classList.contains('hidden') === false) {
                        const friendsTab = document.getElementById('friendsTab');
                        if (friendsTab.classList.contains('text-primary')) {
                            renderFriendsSection();
                        }
                    }
                }
            });
        }
        
        window.updateFriendButton = updateFriendButton;
        window.showUnfriendConfirm = showUnfriendConfirm;
        
        // Friends section rendering
        function renderFriendsSection() {
            if (!currentUser) return;
            
            // Initialize arrays if they don't exist
            if (!currentUser.friends) currentUser.friends = [];
            if (!currentUser.receivedFriendRequests) currentUser.receivedFriendRequests = [];
            if (!currentUser.sentFriendRequests) currentUser.sentFriendRequests = [];
            
            // Render friend requests
            renderFriendRequests();
            
            // Render current friends
            renderCurrentFriends();
            
            // Render sent requests
            renderSentRequests();
        }
        
        function renderFriendRequests() {
            const requestsList = document.getElementById('friendRequestsList');
            const noRequestsDiv = document.getElementById('noFriendRequests');
            const requestsBadge = document.getElementById('friendRequestsBadge');
            
            // Debug logging
            console.log('=== FRIEND REQUESTS DEBUG ===');
            console.log('Current user:', currentUser?.username);
            console.log('Current user ID:', currentUser?.id);
            console.log('Received friend requests:', currentUser?.receivedFriendRequests);
            console.log('All users:', users.map(u => ({id: u.id, username: u.username, received: u.receivedFriendRequests, sent: u.sentFriendRequests})));
            
            const requestUserIds = currentUser.receivedFriendRequests || [];
            const requestUsers = requestUserIds.map(id => users.find(u => u.id === id)).filter(u => u);
            
            console.log('Request user IDs:', requestUserIds);
            console.log('Request users found:', requestUsers.map(u => u?.username));
            
            if (requestUsers.length === 0) {
                requestsList.innerHTML = '';
                noRequestsDiv.classList.remove('hidden');
                requestsBadge.classList.add('hidden');
            } else {
                noRequestsDiv.classList.add('hidden');
                requestsBadge.classList.remove('hidden');
                requestsBadge.textContent = requestUsers.length;
                
                requestsList.innerHTML = requestUsers.map(user => {
                    const profilePic = getUserProfilePicture(user);
                    const userNotesCount = notes.filter(note => note.authorId === user.id).length;
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600 cursor-pointer" onclick="showUserProfile('${user.username}', ${user.id})">
                                    <img src="${profilePic}" alt="${user.username}" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <div class="font-medium cursor-pointer hover:text-primary transition-colors" onclick="showUserProfile('${user.username}', ${user.id})">${user.username}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${userNotesCount} note${userNotesCount !== 1 ? 's' : ''}</div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600 transition-colors" onclick="acceptFriendRequest(${user.id}); renderFriendsSection();">
                                    <i class="fas fa-check mr-1"></i>Accept
                                </button>
                                <button class="px-3 py-1 text-sm bg-gray-400 text-white rounded hover:bg-gray-500 transition-colors" onclick="declineFriendRequest(${user.id}); renderFriendsSection();">
                                    <i class="fas fa-times mr-1"></i>Decline
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function renderCurrentFriends() {
            const friendsList = document.getElementById('currentFriendsList');
            const noFriendsDiv = document.getElementById('noCurrentFriends');
            const friendsBadge = document.getElementById('friendsCountBadge');
            
            const friendUserIds = currentUser.friends || [];
            const friendUsers = friendUserIds.map(id => users.find(u => u.id === id)).filter(u => u);
            
            if (friendUsers.length === 0) {
                friendsList.innerHTML = '';
                noFriendsDiv.classList.remove('hidden');
                friendsBadge.classList.add('hidden');
            } else {
                noFriendsDiv.classList.add('hidden');
                friendsBadge.classList.remove('hidden');
                friendsBadge.textContent = friendUsers.length;
                
                friendsList.innerHTML = friendUsers.map(user => {
                    const profilePic = getUserProfilePicture(user);
                    const userNotesCount = notes.filter(note => note.authorId === user.id).length;
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600 cursor-pointer" onclick="showUserProfile('${user.username}', ${user.id})">
                                    <img src="${profilePic}" alt="${user.username}" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <div class="font-medium cursor-pointer hover:text-primary transition-colors" onclick="showUserProfile('${user.username}', ${user.id})">${user.username}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${user.status || 'Available'}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${userNotesCount} note${userNotesCount !== 1 ? 's' : ''}</div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 text-sm bg-primary text-white rounded hover:bg-primary/90 transition-colors" onclick="viewUserNotes('${user.username}', ${user.id})">
                                    <i class="fas fa-map-marked-alt mr-1"></i>Notes
                                </button>
                                <button class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 transition-colors" onclick="showConfirmDialog('Remove ${user.username} from friends?', () => { removeFriend(${user.id}); renderFriendsSection(); });">
                                    <i class="fas fa-user-minus mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function renderSentRequests() {
            const sentList = document.getElementById('sentRequestsList');
            const noSentDiv = document.getElementById('noSentRequests');
            const sentBadge = document.getElementById('sentRequestsBadge');
            
            const sentUserIds = currentUser.sentFriendRequests || [];
            const sentUsers = sentUserIds.map(id => users.find(u => u.id === id)).filter(u => u);
            
            if (sentUsers.length === 0) {
                sentList.innerHTML = '';
                noSentDiv.classList.remove('hidden');
                sentBadge.classList.add('hidden');
            } else {
                noSentDiv.classList.add('hidden');
                sentBadge.classList.remove('hidden');
                sentBadge.textContent = sentUsers.length;
                
                sentList.innerHTML = sentUsers.map(user => {
                    const profilePic = getUserProfilePicture(user);
                    const userNotesCount = notes.filter(note => note.authorId === user.id).length;
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600 cursor-pointer" onclick="showUserProfile('${user.username}', ${user.id})">
                                    <img src="${profilePic}" alt="${user.username}" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <div class="font-medium cursor-pointer hover:text-primary transition-colors" onclick="showUserProfile('${user.username}', ${user.id})">${user.username}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${userNotesCount} note${userNotesCount !== 1 ? 's' : ''}</div>
                                    <div class="text-xs text-blue-500">Request pending</div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 text-sm bg-gray-400 text-white rounded hover:bg-gray-500 transition-colors" onclick="showConfirmDialog('Cancel friend request to ${user.username}?', () => { cancelFriendRequest(${user.id}); renderFriendsSection(); });">
                                    <i class="fas fa-times mr-1"></i>Cancel
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function cancelFriendRequest(toUserId) {
            if (!currentUser) return false;
            
            const toUser = users.find(u => u.id === toUserId);
            if (!toUser) return false;
            
            // Remove from both users' request arrays
            if (currentUser.sentFriendRequests) {
                currentUser.sentFriendRequests = currentUser.sentFriendRequests.filter(id => id !== toUserId);
            }
            if (toUser.receivedFriendRequests) {
                toUser.receivedFriendRequests = toUser.receivedFriendRequests.filter(id => id !== currentUser.id);
            }
            
            showNotification(`Friend request to ${toUser.username} cancelled`, 'success');
            return true;
        }
        
        window.cancelFriendRequest = cancelFriendRequest;
        
        // Events section rendering
        function renderEventsSection() {
            if (!currentUser) return;
            
            // Get hosted events (notes created by current user that have event data)
            const hostedEvents = notes.filter(note => 
                note.authorId === currentUser.id && 
                note.event && 
                note.event.startDate && 
                note.event.startTime
            );
            
            // Get RSVP'd events (notes where current user has RSVP'd)
            const rsvpedEvents = notes.filter(note => 
                note.authorId !== currentUser.id && 
                note.rsvps && 
                note.rsvps.includes(currentUser.id)
            );
            
            // Render hosted events
            renderHostedEvents(hostedEvents);
            
            // Render RSVP'd events
            renderRSVPedEvents(rsvpedEvents);
        }
        
        function renderHostedEvents(events) {
            const eventsList = document.getElementById('hostedEventsList');
            const noEventsDiv = document.getElementById('noHostedEvents');
            const eventsBadge = document.getElementById('hostedEventsBadge');
            
            if (events.length === 0) {
                eventsList.innerHTML = '';
                noEventsDiv.classList.remove('hidden');
                eventsBadge.classList.add('hidden');
            } else {
                noEventsDiv.classList.add('hidden');
                eventsBadge.classList.remove('hidden');
                eventsBadge.textContent = events.length;
                
                eventsList.innerHTML = events.map(event => {
                    const startDate = new Date(`${event.event.startDate}T${event.event.startTime}`);
                    const eventStatus = startDate > new Date() ? 'Upcoming' : 'Past';
                    const statusColor = eventStatus === 'Upcoming' ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400';
                    const rsvpCount = event.rsvps ? event.rsvps.length : 0;
                    
                    return `
                        <div class="p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <span class="text-lg">${event.pinStyle?.value || 'üìç'}</span>
                                        <h4 class="font-medium text-sm cursor-pointer hover:text-primary transition-colors" onclick="showViewModal(notes.find(n => n.id === ${event.id}))">${event.title}</h4>
                                    </div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                        <div><i class="fas fa-calendar mr-1"></i>${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                        <div><i class="fas fa-users mr-1"></i>${rsvpCount} RSVP${rsvpCount !== 1 ? 's' : ''}</div>
                                        <div class="${statusColor}"><i class="fas fa-clock mr-1"></i>${eventStatus}</div>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="px-2 py-1 text-xs bg-primary text-white rounded hover:bg-primary/90 transition-colors" onclick="showViewModal(notes.find(n => n.id === ${event.id})); document.getElementById('profileSettingsModal').classList.add('hidden');">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                    <button class="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors" onclick="showNoteModal(${event.lat}, ${event.lng}, notes.find(n => n.id === ${event.id})); document.getElementById('profileSettingsModal').classList.add('hidden');">
                                        <i class="fas fa-edit mr-1"></i>Edit
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function renderRSVPedEvents(events) {
            const eventsList = document.getElementById('rsvpedEventsList');
            const noEventsDiv = document.getElementById('noRsvpedEvents');
            const eventsBadge = document.getElementById('rsvpedEventsBadge');
            
            if (events.length === 0) {
                eventsList.innerHTML = '';
                noEventsDiv.classList.remove('hidden');
                eventsBadge.classList.add('hidden');
            } else {
                noEventsDiv.classList.add('hidden');
                eventsBadge.classList.remove('hidden');
                eventsBadge.textContent = events.length;
                
                eventsList.innerHTML = events.map(event => {
                    const startDate = new Date(`${event.event.startDate}T${event.event.startTime}`);
                    const eventStatus = startDate > new Date() ? 'Upcoming' : 'Past';
                    const statusColor = eventStatus === 'Upcoming' ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400';
                    const rsvpCount = event.rsvps ? event.rsvps.length : 0;
                    const author = users.find(u => u.id === event.authorId);
                    
                    return `
                        <div class="p-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <span class="text-lg">${event.pinStyle?.value || 'üìç'}</span>
                                        <h4 class="font-medium text-sm cursor-pointer hover:text-primary transition-colors" onclick="showViewModal(notes.find(n => n.id === ${event.id}))">${event.title}</h4>
                                    </div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                                        <div><i class="fas fa-user mr-1"></i>Hosted by ${author ? author.username : 'Unknown'}</div>
                                        <div><i class="fas fa-calendar mr-1"></i>${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                        <div><i class="fas fa-users mr-1"></i>${rsvpCount} RSVP${rsvpCount !== 1 ? 's' : ''}</div>
                                        <div class="${statusColor}"><i class="fas fa-clock mr-1"></i>${eventStatus}</div>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="px-2 py-1 text-xs bg-primary text-white rounded hover:bg-primary/90 transition-colors" onclick="showViewModal(notes.find(n => n.id === ${event.id})); document.getElementById('profileSettingsModal').classList.add('hidden');">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                    <button class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 transition-colors" onclick="handleRSVPRemoval(${event.id});">
                                        <i class="fas fa-times mr-1"></i>Remove RSVP
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function handleRSVPRemoval(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (note && note.rsvps && currentUser) {
                showConfirmDialog('Remove your RSVP from this event?', () => {
                    // Remove current user from RSVP list
                    note.rsvps = note.rsvps.filter(id => id !== currentUser.id);
                    // Refresh the events section
                    renderEventsSection();
                    showNotification('RSVP removed successfully', 'success');
                });
            }
        }
        
        window.handleRSVPRemoval = handleRSVPRemoval;
        
        // Friend notification system
        function updateFriendNotifications() {
            if (!currentUser) return;
            
            // Initialize arrays if they don't exist
            if (!currentUser.receivedFriendRequests) currentUser.receivedFriendRequests = [];
            
            const pendingRequestsCount = currentUser.receivedFriendRequests.length;
            
            // Update profile menu notification (header)
            updateProfileMenuNotification(pendingRequestsCount);
            
            // Update friends dropdown item notification
            updateFriendsDropdownNotification(pendingRequestsCount);
            
            // Update friends tab notification (if modal is open)
            updateFriendsTabNotification(pendingRequestsCount);
        }
        
        function updateProfileMenuNotification(count) {
            // Remove existing notification badge
            const existingBadge = document.querySelector('#profileBtn .notification-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            if (count > 0) {
                // Add notification badge to profile button
                const profileBtn = document.getElementById('profileBtn');
                const badge = document.createElement('div');
                badge.className = 'notification-badge absolute top-0 right-0 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center z-10 transform translate-x-1 -translate-y-1';
                badge.textContent = count > 9 ? '9+' : count.toString();
                badge.style.fontSize = '10px';
                
                // Make profile button container relative positioned
                profileBtn.style.position = 'relative';
                profileBtn.appendChild(badge);
            }
        }
        
        function updateFriendsDropdownNotification(count) {
            // Remove existing notification badge
            const existingBadge = document.querySelector('#friendsBtn .notification-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            if (count > 0) {
                // Add notification badge to friends dropdown item
                const friendsBtn = document.getElementById('friendsBtn');
                const badge = document.createElement('span');
                badge.className = 'notification-badge ml-auto text-xs bg-red-500 text-white px-2 py-1 rounded-full';
                badge.textContent = count > 9 ? '9+' : count.toString();
                friendsBtn.appendChild(badge);
            }
        }
        
        function updateFriendsTabNotification(count) {
            // Only update if the profile settings modal is open
            const modal = document.getElementById('profileSettingsModal');
            if (modal.classList.contains('hidden')) return;
            
            const friendsTab = document.getElementById('friendsTab');
            
            // Remove existing notification badge
            const existingBadge = friendsTab.querySelector('.notification-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            if (count > 0) {
                // Add notification badge to friends tab
                const badge = document.createElement('span');
                badge.className = 'notification-badge absolute top-1 right-2 text-xs bg-red-500 text-white px-1 py-0.5 rounded-full';
                badge.textContent = count > 9 ? '9+' : count.toString();
                
                // Make friends tab relatively positioned
                friendsTab.style.position = 'relative';
                friendsTab.appendChild(badge);
            }
        }
        
        // Clear friend notifications when section is accessed
        function clearFriendNotifications() {
            // Clear all notification badges
            updateProfileMenuNotification(0);
            updateFriendsDropdownNotification(0);
            updateFriendsTabNotification(0);
        }

        function updateProfileMediaPreview() {
            const gallery = document.getElementById('profileMediaPreviewGallery');
            const grid = document.getElementById('profileMediaPreviewGrid');

            if (currentProfileMedia.length === 0) {
                gallery.classList.add('hidden');
                return;
            }

            gallery.classList.remove('hidden');
            grid.innerHTML = currentProfileMedia.map(item => {
                if (item.type === 'image') {
                    return `
                        <div class="relative group">
                            <img src="${item.data}" alt="${item.name}" class="w-full h-24 object-cover rounded-lg">
                            <button type="button" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity" onclick="removeMediaFromProfile('${item.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 rounded">
                                <i class="fas fa-image"></i>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="relative group">
                            <video src="${item.data}" class="w-full h-24 object-cover rounded-lg" muted></video>
                            <button type="button" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity" onclick="removeMediaFromProfile('${item.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 rounded">
                                <i class="fas fa-video"></i>
                            </div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <i class="fas fa-play text-white text-lg opacity-70"></i>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Payment method functions for account settings
        function updatePaymentMethodFields() {
            const paymentMethod = document.getElementById('userPaymentMethod').value;
            const detailsContainer = document.getElementById('paymentMethodDetails');
            const hintElement = document.getElementById('paymentMethodHint');
            
            if (paymentMethod && paymentMethod !== '') {
                detailsContainer.classList.remove('hidden');
                
                // Update hint text based on payment method
                const hints = {
                    'venmo': 'Enter your Venmo username (e.g., @yourusername)',
                    'paypal': 'Enter your PayPal email address',
                    'cashapp': 'Enter your Cash App username (e.g., $yourusername)',
                    'zelle': 'Enter your Zelle email address or phone number',
                    'stripe': 'Stripe will handle payment processing automatically',
                    'other': 'Enter your payment instructions or contact details'
                };
                
                if (hintElement) {
                    hintElement.textContent = hints[paymentMethod] || 'Enter your payment details';
                }
            } else {
                detailsContainer.classList.add('hidden');
            }
        }
        
        function updatePaymentMethodHints() {
            const paymentMethod = document.getElementById('userPaymentMethod').value;
            const detailsInput = document.getElementById('userPaymentDetails');
            const hintElement = document.getElementById('paymentMethodHint');
            
            if (!detailsInput || !hintElement) return;
            
            const value = detailsInput.value.trim();
            
            // Provide contextual validation hints
            if (paymentMethod === 'venmo' && value && !value.startsWith('@')) {
                hintElement.textContent = 'Venmo usernames should start with @';
                hintElement.className = 'text-xs text-orange-500 mt-1';
            } else if (paymentMethod === 'cashapp' && value && !value.startsWith('$')) {
                hintElement.textContent = 'Cash App usernames should start with $';
                hintElement.className = 'text-xs text-orange-500 mt-1';
            } else if ((paymentMethod === 'paypal' || paymentMethod === 'zelle') && value && !value.includes('@')) {
                hintElement.textContent = 'Please enter a valid email address';
                hintElement.className = 'text-xs text-orange-500 mt-1';
            } else {
                // Reset to default hint
                updatePaymentMethodFields();
                hintElement.className = 'text-xs text-gray-500 dark:text-gray-400 mt-1';
            }
        }

        function populateProfileSettings() {
            // Profile section
            document.getElementById('editProfilePic').src = getUserProfilePicture(currentUser);
            
            // Default visibility to invisible
            const settingsVisibility = currentUser.visibility || 'invisible';
            document.getElementById('userVisibilitySelect').value = settingsVisibility;
            
            // Simple status input
            document.getElementById('userStatusInput').value = currentUser.status || '';
            
            // Bio without character limits
            document.getElementById('userBioInput').value = currentUser.bio || '';
            
            // Tags
            const userTags = currentUser.tags || [];
            document.getElementById('userTagsInput').value = userTags.join(', ');
            
            // Load profile media
            currentProfileMedia = currentUser.media ? [...currentUser.media] : [];
            updateProfileMediaPreview();
            
            // Account section
            document.getElementById('editUsername').value = currentUser.username;
            document.getElementById('editEmail').value = currentUser.email || '';
            
            // Clear password fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // Default location settings
            const defaultLocationMode = currentUser.defaultLocationMode || 'default';
            document.getElementById('defaultLocationMode').value = defaultLocationMode;
            updateDefaultLocationSettings(defaultLocationMode);
            
            // Default location mode change handler
            document.getElementById('defaultLocationMode').addEventListener('change', (e) => {
                updateDefaultLocationSettings(e.target.value);
            });
            
            // Location selection buttons
            document.getElementById('selectLocationBtn').addEventListener('click', setCustomLocationFromMap);
            document.getElementById('useCurrentGPSBtn').addEventListener('click', setCustomLocationFromGPS);
            
            // Payment method settings
            document.getElementById('userPaymentMethod').value = currentUser.paymentMethod || '';
            document.getElementById('userPaymentDetails').value = currentUser.paymentDetails || '';
            updatePaymentMethodFields();
            
            // Account stats
            document.getElementById('memberSinceDate').textContent = new Date(currentUser.createdAt).toLocaleDateString();
            const userNoteCount = notes.filter(note => note.authorId === currentUser.id).length;
            document.getElementById('userNotesCount').textContent = userNoteCount;
            
            // Show/hide remove profile pic button
            const removeBtn = document.getElementById('removeProfilePicBtn');
            if (currentUser.profilePicture) {
                removeBtn.classList.remove('hidden');
            } else {
                removeBtn.classList.add('hidden');
            }
        }

        function updateDefaultLocationSettings(mode) {
            const customLocationSettings = document.getElementById('customLocationSettings');
            const gpsLocationStatus = document.getElementById('gpsLocationStatus');
            const currentCustomLocation = document.getElementById('currentCustomLocation');
            
            // Hide all sections first
            customLocationSettings.classList.add('hidden');
            gpsLocationStatus.classList.add('hidden');
            
            if (mode === 'custom') {
                customLocationSettings.classList.remove('hidden');
                
                // Update custom location display
                if (currentUser.customLocation) {
                    currentCustomLocation.textContent = `Lat: ${currentUser.customLocation.lat.toFixed(4)}, Lng: ${currentUser.customLocation.lng.toFixed(4)}`;
                } else {
                    currentCustomLocation.textContent = 'No custom location set';
                }
            } else if (mode === 'gps') {
                gpsLocationStatus.classList.remove('hidden');
            }
        }

        function setCustomLocationFromMap() {
            // Close the modal and enable map selection mode
            const modal = document.getElementById('profileSettingsModal');
            modal.classList.add('hidden');
            
            // Show instruction overlay
            showMapSelectionMode();
        }

        function setCustomLocationFromGPS() {
            if (!navigator.geolocation) {
                showNotification('GPS not supported by your browser', 'error');
                return;
            }
            
            showNotification('Getting your current location...', 'default');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentUser.customLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        zoom: 15
                    };
                    
                    updateDefaultLocationSettings('custom');
                    showNotification('Custom location set to your current GPS position!', 'success');
                },
                (error) => {
                    const errorMessage = error.message || 'Unknown GPS error';
                    showNotification(`Could not get GPS location: ${errorMessage}`, 'error');
                    console.error('GPS error:', error);
                },
                { timeout: 10000, enableHighAccuracy: true }
            );
        }

        function showMapSelectionMode() {
            // Create overlay with instructions
            const overlay = document.createElement('div');
            overlay.id = 'mapSelectionOverlay';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-30 z-[1500]';
            overlay.innerHTML = `
                <div class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-primary text-white px-6 py-3 rounded-lg shadow-lg">
                    <div class="text-center">
                        <div class="font-medium mb-2">üìç Select Default Location</div>
                        <div class="text-sm mb-3">Click anywhere on the map to set your default location</div>
                        <button id="cancelLocationSelection" class="px-3 py-1 bg-white text-primary rounded text-sm hover:bg-gray-100 transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Cancel button handler
            document.getElementById('cancelLocationSelection').onclick = () => {
                exitMapSelectionMode();
                // Reopen settings modal
                document.getElementById('profileSettingsModal').classList.remove('hidden');
            };
            
            // Set up one-time map click handler
            const mapClickHandler = (e) => {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                const zoom = map.getZoom();
                
                // Save the custom location
                currentUser.customLocation = { lat, lng, zoom };
                
                // Remove the overlay and event listener
                exitMapSelectionMode();
                
                // Reopen settings modal and update display
                document.getElementById('profileSettingsModal').classList.remove('hidden');
                updateDefaultLocationSettings('custom');
                
                showNotification('Custom default location set!', 'success');
                
                // Remove this event listener
                map.off('click', mapClickHandler);
            };
            
            map.on('click', mapClickHandler);
            
            // Store the handler so we can remove it if cancelled
            overlay.mapClickHandler = mapClickHandler;
        }

        function exitMapSelectionMode() {
            const overlay = document.getElementById('mapSelectionOverlay');
            if (overlay) {
                // Remove map click handler if it exists
                if (overlay.mapClickHandler) {
                    map.off('click', overlay.mapClickHandler);
                }
                overlay.remove();
            }
        }

        function updateBioCharCount() {
            const bioInput = document.getElementById('userBioInput');
            const charCount = document.getElementById('bioCharCount');
            charCount.textContent = bioInput.value.length;
        }

        function toggleCustomStatusInput() {
            const statusSelect = document.getElementById('userStatusSelect');
            const customInput = document.getElementById('customStatusInput');
            
            if (statusSelect.value === 'Custom') {
                customInput.classList.remove('hidden');
                customInput.focus();
                customInput.value = currentUser.customStatus || '';
            } else {
                customInput.classList.add('hidden');
            }
        }

        async function handleProfilePicUpload(file) {
            if (file && file.type.startsWith('image/')) {
                const dataUrl = await createImageDataUrl(file);
                currentUser.profilePicture = dataUrl;
                document.getElementById('editProfilePic').src = dataUrl;
                document.getElementById('removeProfilePicBtn').classList.remove('hidden');
                showNotification('Profile picture updated!', 'success');
            }
        }

        function removeProfilePicture() {
            currentUser.profilePicture = null;
            document.getElementById('editProfilePic').src = getDefaultProfilePicture();
            document.getElementById('removeProfilePicBtn').classList.add('hidden');
            showNotification('Profile picture removed', 'success');
        }

        function saveProfileSettings() {
            const activeTab = document.querySelector('[id$="Tab"].text-primary');
            const section = activeTab.id.replace('Tab', '');
            
            if (section === 'profile') {
                // Save profile changes
                const newStatus = document.getElementById('userStatusInput').value.trim();
                const newBio = document.getElementById('userBioInput').value.trim();
                const newTags = document.getElementById('userTagsInput').value.trim();
                
                // Save status (simple input field now)
                currentUser.status = newStatus || '';
                
                // Save bio 
                currentUser.bio = newBio;
                
                // Save tags
                if (newTags) {
                    currentUser.tags = newTags.split(',').map(tag => tag.trim()).filter(tag => tag);
                } else {
                    currentUser.tags = [];
                }
                
                // Save profile media
                currentUser.media = [...currentProfileMedia];
                
                // Save visibility setting
                const newVisibility = document.getElementById('userVisibilitySelect').value;
                currentUser.visibility = newVisibility;
                
            } else if (section === 'account') {
                // Save account changes
                const newUsername = document.getElementById('editUsername').value.trim();
                const newEmail = document.getElementById('editEmail').value.trim();
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Validate username
                if (newUsername !== currentUser.username) {
                    if (users.find(u => u.username === newUsername && u.id !== currentUser.id)) {
                        showAlert('Username already exists');
                        return;
                    }
                    if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
                        showAlert('Username can only contain letters, numbers, and underscores');
                        return;
                    }
                    currentUser.username = newUsername;
                }
                
                // Validate email
                if (newEmail !== currentUser.email) {
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
                        showAlert('Please enter a valid email address');
                        return;
                    }
                    currentUser.email = newEmail;
                }
                
                // Handle password change
                if (currentPassword || newPassword || confirmPassword) {
                    if (!currentPassword) {
                        showAlert('Please enter your current password');
                        return;
                    }
                    if (currentPassword !== currentUser.password) {
                        showAlert('Current password is incorrect');
                        return;
                    }
                    if (!newPassword) {
                        showAlert('Please enter a new password');
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        showAlert('Passwords do not match');
                        return;
                    }
                    if (newPassword.length < 3) {
                        showAlert('Password must be at least 3 characters long');
                        return;
                    }
                    
                    currentUser.password = newPassword;
                    
                    // Clear password fields after successful change
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                }
            }
            
            // Update UI and close modal
            updateUserInterface();
            updateProfilePictures();
            document.getElementById('profileSettingsModal').classList.add('hidden');
            
            showNotification('Settings saved successfully!', 'success');
        }

        // Friend system functions
        function sendFriendRequest(toUserId) {
            if (!currentUser) return false;
            
            const toUser = users.find(u => u.id === toUserId);
            if (!toUser) return false;
            
            // Initialize friend requests arrays if they don't exist
            if (!currentUser.sentFriendRequests) currentUser.sentFriendRequests = [];
            if (!toUser.receivedFriendRequests) toUser.receivedFriendRequests = [];
            if (!currentUser.friends) currentUser.friends = [];
            if (!toUser.friends) toUser.friends = [];
            
            // Check if already friends
            if (currentUser.friends.includes(toUserId)) {
                showNotification('Already friends with this user', 'error');
                return false;
            }
            
            // Check if request already sent
            if (currentUser.sentFriendRequests.includes(toUserId)) {
                showNotification('Friend request already sent', 'error');
                return false;
            }
            
            // Check if they sent us a request (auto-accept)
            if (currentUser.receivedFriendRequests && currentUser.receivedFriendRequests.includes(toUserId)) {
                acceptFriendRequest(toUserId);
                return true;
            }
            
            // Send the request
            currentUser.sentFriendRequests.push(toUserId);
            toUser.receivedFriendRequests.push(currentUser.id);
            
            showNotification(`Friend request sent to ${toUser.username}!`, 'success');
            
            // Update both users' friend notifications
            if (currentUser === toUser) { // Just in case (shouldn't happen)
                updateFriendNotifications();
            } else {
                updateFriendNotifications(); // Update sender's UI
                // Note: In a real app, we'd also send a notification to the recipient
            }
            
            return true;
        }

        function acceptFriendRequest(fromUserId) {
            if (!currentUser) return false;
            
            const fromUser = users.find(u => u.id === fromUserId);
            if (!fromUser) return false;
            
            // Initialize arrays if they don't exist
            if (!currentUser.receivedFriendRequests) currentUser.receivedFriendRequests = [];
            if (!currentUser.friends) currentUser.friends = [];
            if (!fromUser.sentFriendRequests) fromUser.sentFriendRequests = [];
            if (!fromUser.friends) fromUser.friends = [];
            
            // Check if request exists
            if (!currentUser.receivedFriendRequests.includes(fromUserId)) {
                return false;
            }
            
            // Remove from request arrays
            currentUser.receivedFriendRequests = currentUser.receivedFriendRequests.filter(id => id !== fromUserId);
            fromUser.sentFriendRequests = fromUser.sentFriendRequests.filter(id => id !== currentUser.id);
            
            // Add to friends arrays
            currentUser.friends.push(fromUserId);
            fromUser.friends.push(currentUser.id);
            
            showNotification(`You are now friends with ${fromUser.username}!`, 'success');
            
            // Update friend notifications since request count changed
            updateFriendNotifications();
            
            return true;
        }

        function declineFriendRequest(fromUserId) {
            if (!currentUser) return false;
            
            const fromUser = users.find(u => u.id === fromUserId);
            if (!fromUser) return false;
            
            // Initialize arrays if they don't exist
            if (!currentUser.receivedFriendRequests) currentUser.receivedFriendRequests = [];
            if (!fromUser.sentFriendRequests) fromUser.sentFriendRequests = [];
            
            // Remove from request arrays
            currentUser.receivedFriendRequests = currentUser.receivedFriendRequests.filter(id => id !== fromUserId);
            fromUser.sentFriendRequests = fromUser.sentFriendRequests.filter(id => id !== currentUser.id);
            
            showNotification(`Friend request from ${fromUser.username} declined`, 'success');
            
            // Update friend notifications since request count changed
            updateFriendNotifications();
            
            return true;
        }

        function removeFriend(friendUserId) {
            if (!currentUser) return false;
            
            const friendUser = users.find(u => u.id === friendUserId);
            if (!friendUser) return false;
            
            // Initialize arrays if they don't exist
            if (!currentUser.friends) currentUser.friends = [];
            if (!friendUser.friends) friendUser.friends = [];
            
            // Remove from both users' friends arrays
            currentUser.friends = currentUser.friends.filter(id => id !== friendUserId);
            friendUser.friends = friendUser.friends.filter(id => id !== currentUser.id);
            
            showNotification(`Removed ${friendUser.username} from friends`, 'success');
            return true;
        }

        function getFriendshipStatus(userId) {
            if (!currentUser || userId === currentUser.id) return 'self';
            
            // Initialize arrays if they don't exist
            if (!currentUser.friends) currentUser.friends = [];
            if (!currentUser.sentFriendRequests) currentUser.sentFriendRequests = [];
            if (!currentUser.receivedFriendRequests) currentUser.receivedFriendRequests = [];
            
            if (currentUser.friends.includes(userId)) {
                return 'friends';
            } else if (currentUser.sentFriendRequests.includes(userId)) {
                return 'pending';
            } else if (currentUser.receivedFriendRequests.includes(userId)) {
                return 'received';
            } else {
                return 'none';
            }
        }

        // User management
        function registerUser(username, password, email) {
            if (users.find(u => u.username === username)) {
                showAlert('Username already exists');
                return false;
            }
            
            const user = {
                id: Date.now() + Math.random(),
                username,
                password,
                email,
                friends: [],
                sentFriendRequests: [],
                receivedFriendRequests: [],
                createdAt: new Date()
            };
            
            users.push(user);
            return user;
        }

        function loginUser(username, password) {
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                
                // Set last login time and check for new notes
                const now = new Date();
                const lastLogin = currentUser.lastLogin || new Date(0); // Default to epoch if never logged in
                currentUser.lastLogin = now;
                
                updateUserInterface();
                
                // Refresh map and animate new notes
                refreshMapWithNewNoteDetection(lastLogin);
                
                // Start demo note generation from other users
                startDemoNoteGeneration();
                
                return true;
            }
            return false;
        }

        function showFriendRequestsPopup() {
            if (!currentUser) return;
            
            const receivedRequests = currentUser.receivedFriendRequests || [];
            const sentRequests = currentUser.sentFriendRequests || [];
            const friends = currentUser.friends || [];
            
            const receivedUsers = receivedRequests.map(id => users.find(u => u.id === id)).filter(u => u);
            const sentUsers = sentRequests.map(id => users.find(u => u.id === id)).filter(u => u);
            const friendUsers = friends.map(id => users.find(u => u.id === id)).filter(u => u);
            
            let message = `Welcome ${currentUser.username}!\n\n`;
            message += `üì• Friend Requests: ${receivedUsers.length}\n`;
            if (receivedUsers.length > 0) {
                message += `From: ${receivedUsers.map(u => u.username).join(', ')}\n`;
            }
            message += `\nüì§ Sent Requests: ${sentUsers.length}\n`;
            if (sentUsers.length > 0) {
                message += `To: ${sentUsers.map(u => u.username).join(', ')}\n`;
            }
            message += `\nüë• Friends: ${friendUsers.length}\n`;
            if (friendUsers.length > 0) {
                message += `Friends: ${friendUsers.map(u => u.username).join(', ')}\n`;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-3">Friend Status</h3>
                    <pre class="text-sm whitespace-pre-wrap mb-4">${message}</pre>
                    <div class="flex justify-between">
                        <button class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90" onclick="document.getElementById('profileDropdown').classList.remove('hidden'); this.closest('.fixed').remove();">
                            View Profile Menu
                        </button>
                        <button class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500" onclick="this.closest('.fixed').remove();">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function logoutUser() {
            currentUser = null;
            updateUserInterface();
            // Refresh map to hide private notes that the user can no longer see
            refreshMap();
        }

        function updateUserInterface() {
            const loggedOutMenu = document.getElementById('loggedOutMenu');
            const loggedInMenu = document.getElementById('loggedInMenu');
            const currentUserName = document.getElementById('currentUserName');

            if (currentUser) {
                loggedOutMenu.classList.add('hidden');
                loggedInMenu.classList.remove('hidden');
                currentUserName.textContent = currentUser.username;
                updateProfilePictures();
                updateFriendNotifications();
            } else {
                loggedOutMenu.classList.remove('hidden');
                loggedInMenu.classList.add('hidden');
            }
            
            updateInstructionsContent();
        }

        function updateInstructionsContent() {
            const icon = document.getElementById('instructionsIcon');
            const title = document.getElementById('instructionsTitle');
            const text = document.getElementById('instructionsText');
            const buttons = document.getElementById('instructionsButtons');

            if (currentUser) {
                icon.className = 'fas fa-info-circle text-primary text-lg';
                title.textContent = 'How to use LeelaMaps';
                text.textContent = 'Click anywhere on the map to create a new note at that location. Click on existing pins to view notes and explore what others have shared.';
                buttons.classList.add('hidden');
            } else {
                icon.className = 'fas fa-user-circle text-primary text-lg';
                title.textContent = 'Welcome to LeelaMaps';
                text.textContent = 'Please login or register to start creating location-based notes and explore what others have shared.';
                buttons.classList.remove('hidden');
            }
        }

        function canEditNote(note) {
            return currentUser && note.authorId === currentUser.id;
        }

        // Privacy checking functions
        function canViewNote(note) {
            // Handle notes without privacy setting (default to public for backward compatibility)
            const privacy = note.privacy || 'public';
            
            // Public notes are visible to everyone
            if (privacy === 'public') {
                return true;
            }
            
            // If user is not logged in, they can only see public notes
            if (!currentUser) {
                return false;
            }
            
            // Authors can always see their own notes
            if (note.authorId === currentUser.id) {
                return true;
            }
            
            // Private notes are only visible to the author
            if (privacy === 'self') {
                return false;
            }
            
            // Friends-only notes require friendship
            if (privacy === 'friends') {
                return isFriend(note.authorId);
            }
            
            // Friends-of-friends notes require friendship or mutual friends
            if (privacy === 'friends-of-friends') {
                return isFriend(note.authorId) || hasMutualFriends(note.authorId);
            }
            
            // Default to not visible if unknown privacy setting
            return false;
        }
        
        function isFriend(userId) {
            if (!currentUser || !currentUser.friends) return false;
            return currentUser.friends.includes(userId);
        }
        
        function hasMutualFriends(userId) {
            if (!currentUser || !currentUser.friends) return false;
            
            const otherUser = users.find(u => u.id === userId);
            if (!otherUser || !otherUser.friends) return false;
            
            // Check if we have any mutual friends
            return currentUser.friends.some(friendId => 
                otherUser.friends.includes(friendId)
            );
        }
        
        function getPrivacyIcon(privacy) {
            switch (privacy) {
                case 'public': return 'üåç';
                case 'friends': return 'üë•';
                case 'friends-of-friends': return 'ü§ù';
                case 'self': return 'üîí';
                default: return 'üåç'; // Default to public icon
            }
        }
        
        function getPrivacyLabel(privacy) {
            switch (privacy) {
                case 'public': return 'Public';
                case 'friends': return 'Friends Only';
                case 'friends-of-friends': return 'Friends of Friends';
                case 'self': return 'Private';
                default: return 'Public'; // Default to public
            }
        }

        // Initialize map
        function initMap() {
            // Default to NYC coordinates
            let initialCoords = [40.7128, -74.0060];
            let initialZoom = 13;
            
            // Check if user has a default location preference
            if (currentUser && currentUser.defaultLocationMode) {
                const mode = currentUser.defaultLocationMode;
                
                if (mode === 'custom' && currentUser.customLocation) {
                    initialCoords = [currentUser.customLocation.lat, currentUser.customLocation.lng];
                    initialZoom = currentUser.customLocation.zoom || 13;
                } else if (mode === 'gps') {
                    // Attempt to get GPS location
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const userCoords = [position.coords.latitude, position.coords.longitude];
                                map.setView(userCoords, 15);
                                showNotification('Map centered on your current location', 'success');
                            },
                            (error) => {
                                console.warn('GPS location failed:', error);
                                showNotification('Could not access GPS location. Using default location.', 'error');
                            },
                            { timeout: 10000, enableHighAccuracy: true }
                        );
                    } else {
                        showNotification('GPS not supported by your browser. Using default location.', 'error');
                    }
                }
                // For 'default' mode or any other mode, use NYC coordinates (already set above)
            }
            
            map = L.map('map', {
                // Prevent text selection and context menu on mobile
                doubleClickZoom: true,
                touchZoom: true,
                dragging: true,
                tap: false // Disable tap handler to prevent conflicts
            }).setView(initialCoords, initialZoom);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Press and hold functionality for creating notes
            let pressTimer = null;
            let pressStarted = false;
            let pressPosition = null;
            let pressIndicator = null;

            // Mouse events
            map.on('mousedown', function(e) {
                if (!currentUser) return;
                startPressHold(e.latlng, e.containerPoint);
            });

            map.on('mouseup', function(e) {
                cancelPressHold();
            });

            map.on('mousemove', function(e) {
                if (pressStarted && pressPosition) {
                    const distance = Math.sqrt(
                        Math.pow(e.containerPoint.x - pressPosition.x, 2) +
                        Math.pow(e.containerPoint.y - pressPosition.y, 2)
                    );
                    if (distance > 10) { // If moved more than 10 pixels, cancel
                        cancelPressHold();
                    }
                }
            });

            // Simplified touch handling for mobile
            let touchHoldTimer = null;
            let touchStartPos = null;
            
            map.on('contextmenu', function(e) {
                // Handle right-click/long-press on desktop and mobile
                e.originalEvent.preventDefault();
                
                if (currentUser) {
                    showNoteModal(e.latlng.lat, e.latlng.lng);
                } else {
                    showAuthModal(false);
                }
            });
            
            // Simple touch hold detection
            map.getContainer().addEventListener('touchstart', function(e) {
                if (e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                
                // Don't intercept touches on interactive elements
                if (target && (target.closest('.leaflet-marker-icon') || target.closest('.leaflet-control'))) {
                    return;
                }
                
                const mapRect = map.getContainer().getBoundingClientRect();
                const x = touch.clientX - mapRect.left;
                const y = touch.clientY - mapRect.top;
                touchStartPos = { x, y };
                
                const latlng = map.containerPointToLatLng([x, y]);
                
                touchHoldTimer = setTimeout(() => {
                    // Trigger haptic feedback if available
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    
                    if (currentUser) {
                        showNoteModal(latlng.lat, latlng.lng);
                    } else {
                        showAuthModal(false);
                    }
                    touchHoldTimer = null;
                }, 800);
                
            }, { passive: true });
            
            map.getContainer().addEventListener('touchmove', function(e) {
                if (!touchHoldTimer || !touchStartPos) return;
                
                const touch = e.touches[0];
                const mapRect = map.getContainer().getBoundingClientRect();
                const x = touch.clientX - mapRect.left;
                const y = touch.clientY - mapRect.top;
                
                const distance = Math.sqrt(
                    Math.pow(x - touchStartPos.x, 2) +
                    Math.pow(y - touchStartPos.y, 2)
                );
                
                if (distance > 30) {
                    clearTimeout(touchHoldTimer);
                    touchHoldTimer = null;
                }
            }, { passive: true });
            
            map.getContainer().addEventListener('touchend', function(e) {
                if (touchHoldTimer) {
                    clearTimeout(touchHoldTimer);
                    touchHoldTimer = null;
                }
                touchStartPos = null;
            }, { passive: true });

            // Keep mouse events for desktop
            map.on('mousedown', function(e) {
                startPressHold(e.latlng, e.containerPoint);
            });

            map.on('mouseup', function(e) {
                cancelPressHold();
            });

            map.on('mousemove', function(e) {
                if (pressStarted && pressPosition) {
                    const distance = Math.sqrt(
                        Math.pow(e.containerPoint.x - pressPosition.x, 2) +
                        Math.pow(e.containerPoint.y - pressPosition.y, 2)
                    );
                    if (distance > 10) { // If moved more than 10 pixels, cancel
                        cancelPressHold();
                    }
                }
            });

            function startPressHold(latlng, containerPoint) {
                if (pressStarted) return;
                
                pressStarted = true;
                pressPosition = containerPoint;
                
                // Show visual indicator
                showPressIndicator(latlng);
                
                // Set timer for press and hold
                pressTimer = setTimeout(() => {
                    if (pressStarted) {
                        pressStarted = false;
                        removePressIndicator();
                        
                        if (currentUser) {
                            showNoteModal(latlng.lat, latlng.lng);
                        } else {
                            showAuthModal(false);
                        }
                    }
                }, 600); // 600ms press and hold duration
            }

            function cancelPressHold() {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                pressStarted = false;
                pressPosition = null;
                removePressIndicator();
            }

            function showPressIndicator(latlng) {
                removePressIndicator(); // Remove any existing indicator
                
                // Create a growing circle indicator
                pressIndicator = L.circle(latlng, {
                    radius: 1,
                    color: '#5D5CDE',
                    fillColor: '#5D5CDE',
                    fillOpacity: 0.3,
                    weight: 2
                }).addTo(map);
                
                // Animate the circle growing
                let radius = 1;
                const growInterval = setInterval(() => {
                    if (!pressIndicator) {
                        clearInterval(growInterval);
                        return;
                    }
                    radius += 3;
                    pressIndicator.setRadius(radius);
                    if (radius > 50) {
                        clearInterval(growInterval);
                    }
                }, 20);
                
                // Store interval reference to clear it if needed
                pressIndicator._growInterval = growInterval;
            }

            function removePressIndicator() {
                if (pressIndicator) {
                    if (pressIndicator._growInterval) {
                        clearInterval(pressIndicator._growInterval);
                    }
                    map.removeLayer(pressIndicator);
                    pressIndicator = null;
                }
            }
        }

        // Comment management functions
        function addCommentToNote(noteId, content, parentCommentId = null) {
            if (!currentUser) return null;
            
            const note = notes.find(n => n.id === noteId);
            if (!note) return null;
            
            // Initialize comments array if it doesn't exist
            if (!note.comments) {
                note.comments = [];
            }
            
            const comment = {
                id: Date.now() + Math.random(),
                content: content.trim(),
                authorId: currentUser.id,
                author: currentUser.username,
                parentId: parentCommentId,
                createdAt: new Date()
            };
            
            note.comments.push(comment);
            return comment;
        }

        function renderComments(note) {
            const commentsList = document.getElementById('commentsList');
            const commentCountSection = document.getElementById('commentCountSection');
            const commentCount = document.getElementById('commentCount');
            const commentsScrollContainer = document.getElementById('commentsScrollContainer');
            
            const comments = note.comments || [];
            
            // Show comment count only if there are comments
            if (comments.length > 0) {
                commentCount.textContent = `${comments.length} comment${comments.length !== 1 ? 's' : ''}`;
                commentCountSection.classList.remove('hidden');
                
                // Make comment count clickable to toggle visibility
                commentCount.onclick = toggleCommentsVisibility;
                
                // Comments list is hidden by default - don't show them initially
                commentsScrollContainer.classList.add('hidden');
                modalSectionStates.comments.visible = false;
                
                // Organize comments into threads (parent comments and their replies)
                const topLevelComments = comments.filter(comment => !comment.parentId);
                const repliesByParent = {};
                
                comments.forEach(comment => {
                    if (comment.parentId) {
                        if (!repliesByParent[comment.parentId]) {
                            repliesByParent[comment.parentId] = [];
                        }
                        repliesByParent[comment.parentId].push(comment);
                    }
                });
                
                // Render threaded comments
                commentsList.innerHTML = topLevelComments.map(comment => {
                    return renderCommentWithReplies(comment, repliesByParent[comment.id] || [], note.id);
                }).join('');
                
                // Add reply button listeners
                setupReplyButtons(note);
            } else {
                // No comments - hide count and comments list
                commentCountSection.classList.add('hidden');
                commentsList.innerHTML = '';
                commentsScrollContainer.classList.add('hidden');
                modalSectionStates.comments.visible = false;
            }
        }
        
        function toggleCommentsVisibility() {
            const commentsScrollContainer = document.getElementById('commentsScrollContainer');
            const isCurrentlyVisible = !commentsScrollContainer.classList.contains('hidden');
            
            if (isCurrentlyVisible) {
                // Hide comments list
                commentsScrollContainer.classList.add('hidden');
                modalSectionStates.comments.visible = false;
            } else {
                // Show comments list and set up scrolling behavior
                commentsScrollContainer.classList.remove('hidden');
                modalSectionStates.comments.visible = true;
                
                // Reset to default height when first shown
                commentsScrollContainer.style.height = modalSectionStates.comments.defaultHeight + 'px';
                modalSectionStates.comments.expanded = false;
            }
        }

        function renderCommentWithReplies(comment, replies, noteId) {
            const commentAuthor = users.find(u => u.id === comment.authorId);
            const authorProfilePic = commentAuthor ? getUserProfilePicture(commentAuthor) : getDefaultProfilePicture();
            const timeAgo = getTimeAgo(comment.createdAt);
            const canReply = currentUser !== null;
            
            // Render the main comment
            let commentHTML = `
                <div class="comment-thread">
                    <div class="flex space-x-3">
                        <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600 flex-shrink-0 cursor-pointer hover:border-primary transition-colors" onclick="showUserOptionsDropdown(event.target, '${comment.author}', ${comment.authorId})">
                            <img src="${authorProfilePic}" alt="${comment.author}" class="w-full h-full object-cover bg-gray-200 dark:bg-gray-600 rounded-full">
                        </div>
                        <div class="flex-1">
                            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="font-medium text-sm cursor-pointer hover:text-primary transition-colors" onclick="showUserOptionsDropdown(event.target, '${comment.author}', ${comment.authorId})">${comment.author}</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">${timeAgo}</span>
                                </div>
                                <p class="text-sm whitespace-pre-wrap">${comment.content}</p>
                            </div>
                            ${canReply ? `
                                <button class="reply-btn text-xs text-gray-500 dark:text-gray-400 hover:text-primary mt-1 ml-3" data-comment-id="${comment.id}" data-author="${comment.author}">
                                    <i class="fas fa-reply mr-1"></i>Reply
                                </button>
                            ` : ''}
                            
                            <!-- Reply form (initially hidden) -->
                            <div class="reply-form hidden mt-3 ml-3" id="reply-form-${comment.id}">
                                <div class="flex space-x-2 items-start">
                                    <div class="w-6 h-6 rounded-full overflow-hidden border border-gray-300 dark:border-gray-600 flex-shrink-0">
                                        <img src="${currentUser ? getUserProfilePicture(currentUser) : getDefaultProfilePicture()}" class="w-full h-full object-cover bg-gray-200 dark:bg-gray-600 rounded-full">
                                    </div>
                                    <div class="flex-1 relative">
                                        <div class="flex items-center border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 transition-all duration-200 ease-in-out">
                                            <textarea class="reply-input flex-1 px-3 py-2 text-sm bg-transparent text-gray-900 dark:text-white focus:outline-none resize-none overflow-hidden" 
                                                      placeholder="Reply to ${comment.author}..." 
                                                      rows="1"
                                                      style="min-height: 36px; max-height: 120px;"></textarea>
                                            <div class="flex items-center space-x-1 px-2">
                                                <button class="cancel-reply p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors opacity-0 pointer-events-none" title="Cancel">
                                                    <i class="fas fa-times text-sm"></i>
                                                </button>
                                                <button class="submit-reply p-1 text-gray-400 hover:text-primary transition-colors opacity-50 pointer-events-none" title="Post reply" disabled>
                                                    <i class="fas fa-check text-sm"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            `;
            
            // Render replies with indentation
            if (replies.length > 0) {
                commentHTML += `<div class="ml-11 mt-3 space-y-3 border-l-2 border-gray-200 dark:border-gray-600 pl-4">`;
                replies.forEach(reply => {
                    const replyAuthor = users.find(u => u.id === reply.authorId);
                    const replyAuthorPic = replyAuthor ? getUserProfilePicture(replyAuthor) : getDefaultProfilePicture();
                    const replyTimeAgo = getTimeAgo(reply.createdAt);
                    
                    commentHTML += `
                        <div class="flex space-x-3">
                            <div class="w-6 h-6 rounded-full overflow-hidden border border-gray-300 dark:border-gray-600 flex-shrink-0">
                                <img src="${replyAuthorPic}" alt="${reply.author}" class="w-full h-full object-cover bg-gray-200 dark:bg-gray-600 rounded-full">
                            </div>
                            <div class="flex-1">
                                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <span class="font-medium text-sm">${reply.author}</span>
                                        <span class="text-xs text-gray-500 dark:text-gray-400">${replyTimeAgo}</span>
                                    </div>
                                    <p class="text-sm whitespace-pre-wrap">${reply.content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                commentHTML += `</div>`;
            }
            
            commentHTML += `</div>`;
            return commentHTML;
        }

        function setupReplyButtons(note) {
            // Reply button handlers
            document.querySelectorAll('.reply-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const commentId = btn.dataset.commentId;
                    const replyForm = document.getElementById(`reply-form-${commentId}`);
                    const replyInput = replyForm.querySelector('.reply-input');
                    const submitBtn = replyForm.querySelector('.submit-reply');
                    const cancelBtn = replyForm.querySelector('.cancel-reply');
                    
                    // Hide all other reply forms
                    document.querySelectorAll('.reply-form').forEach(form => {
                        if (form.id !== `reply-form-${commentId}`) {
                            form.classList.add('hidden');
                        }
                    });
                    
                    // Show this reply form
                    replyForm.classList.remove('hidden');
                    replyInput.focus();
                    
                    // Input validation
                    const validateInput = () => {
                        const hasContent = replyInput.value.trim().length > 0;
                        submitBtn.disabled = !hasContent;
                    };
                    
                    replyInput.oninput = validateInput;
                    
                    // Submit reply
                    submitBtn.onclick = () => {
                        const content = replyInput.value.trim();
                        if (content) {
                            const reply = addCommentToNote(note.id, content, commentId);
                            if (reply) {
                                replyForm.classList.add('hidden');
                                replyInput.value = '';
                                renderComments(note);
                                showNotification('Reply added!', 'success');
                            }
                        }
                    };
                    
                    // Cancel reply
                    cancelBtn.onclick = () => {
                        replyForm.classList.add('hidden');
                        replyInput.value = '';
                    };
                    
                    // Handle Enter key
                    replyInput.onkeydown = (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            if (!submitBtn.disabled) {
                                submitBtn.click();
                            }
                        }
                    };
                    
                    validateInput();
                });
            });
        }

        // Progressive comment input management
        // Word search functionality - supports both double-tap/click and selection search on mobile and desktop
        function makeTextInteractive(element) {
            try {
                if (!element || element.hasAttribute('data-interactive')) return;
                element.setAttribute('data-interactive', 'true');
                
                // Add click listener for word search (double-click on desktop, double-tap on mobile)
                element.addEventListener('click', handleTextInteraction);
                
                // Add selection change listener to show search hint (works on both mobile and desktop)
                document.addEventListener('selectionchange', handleSelectionChange);
            } catch (error) {
                // Silently handle any text interaction setup errors
            }
        }
        
        let lastTapTime = 0;
        let lastTapPosition = null;
        let selectionSearchHint = null;
        
        // Track drag operations to avoid immediate search on drag-select
        let isDragging = false;
        let dragStartTime = 0;
        let dragEndTime = 0;
        
        function handleSelectionChange() {
            const selectedText = getSelectedText();
            
            if (selectedText && selectedText.length >= 2) {
                // Show search hint after a short delay to allow selection to stabilize
                setTimeout(() => {
                    const currentSelection = getSelectedText();
                    if (currentSelection === selectedText && currentSelection.length >= 2) {
                        showSelectionSearchHint(currentSelection);
                    }
                }, 300);
            } else {
                hideSelectionSearchHint();
            }
        }
        
        function showSelectionSearchHint(text) {
            hideSelectionSearchHint(); // Remove any existing hint
            
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return;
            
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            // Create search hint overlay
            selectionSearchHint = document.createElement('div');
            selectionSearchHint.className = 'fixed bg-primary text-white px-3 py-2 rounded-lg shadow-lg text-sm z-[2000] transition-all duration-200 cursor-pointer hover:bg-primary/90';
            selectionSearchHint.innerHTML = `<i class="fas fa-search mr-2"></i>Search "${text.length > 20 ? text.substring(0, 20) + '...' : text}"`;
            
            // Position below the selection to avoid conflict with native selection menu
            const top = rect.bottom + window.scrollY + 10;
            const left = rect.left + window.scrollX + (rect.width / 2) - 100; // Center on selection
            
            // Ensure the hint stays within viewport bounds
            const hintWidth = 200; // Approximate width of the hint
            const maxTop = window.innerHeight + window.scrollY - 60; // Leave space at bottom
            const finalTop = Math.min(top, maxTop);
            const finalLeft = Math.max(10, Math.min(window.innerWidth - hintWidth - 10, left));
            
            selectionSearchHint.style.top = `${finalTop}px`;
            selectionSearchHint.style.left = `${finalLeft}px`;
            
            // Add click handler for the hint
            selectionSearchHint.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                searchForWord(text);
                hideSelectionSearchHint();
                // Clear selection after search
                window.getSelection().removeAllRanges();
            });
            
            document.body.appendChild(selectionSearchHint);
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                hideSelectionSearchHint();
            }, 4000);
        }
        
        function hideSelectionSearchHint() {
            if (selectionSearchHint) {
                selectionSearchHint.remove();
                selectionSearchHint = null;
            }
        }
        
        function handleTextInteraction(event) {
            // First check if there's selected text AND if the click is within the selection
            const selectedText = getSelectedText();
            if (selectedText && selectedText.length >= 2) {
                // Check if the click position is within the selected text
                if (isClickWithinSelection(event.clientX, event.clientY)) {
                    // Check if this click was immediately after a drag operation (within 500ms)
                    const timeSinceDragEnd = Date.now() - dragEndTime;
                    if (timeSinceDragEnd < 500) {
                        // This click was likely the end of a drag-select operation, don't search yet
                        return;
                    }
                    
                    // User deliberately clicked on selected text - search for selection
                    event.preventDefault();
                    event.stopPropagation();
                    highlightSelectionBriefly();
                    searchForWord(selectedText);
                    hideSelectionSearchHint();
                    // Clear selection after search
                    setTimeout(() => {
                        window.getSelection().removeAllRanges();
                    }, 200);
                    return;
                }
                // Click was outside selection, let it clear the selection naturally and continue with normal tap handling
            }
            
            // Handle single tap vs double tap
            const currentTime = Date.now();
            const tapPosition = { x: event.clientX, y: event.clientY };
            
            // Check if this is a double-tap (within 500ms and close position)
            const isDoubleTap = (currentTime - lastTapTime) < 500 && 
                lastTapPosition && 
                Math.abs(tapPosition.x - lastTapPosition.x) < 20 && 
                Math.abs(tapPosition.y - lastTapPosition.y) < 20;
            
            if (isDoubleTap) {
                // This is a double-tap, search for the word at position
                const word = getWordAtPosition(event.clientX, event.clientY);
                if (word && word.length >= 2) {
                    searchForWord(word);
                }
                
                // Reset tap tracking
                lastTapTime = 0;
                lastTapPosition = null;
            } else {
                // This is the first tap, highlight the word at position
                const word = getWordAtPosition(event.clientX, event.clientY);
                if (word && word.length >= 2) {
                    highlightWordAtPosition(event.clientX, event.clientY, word);
                }
                
                // Record this tap for potential double-tap
                lastTapTime = currentTime;
                lastTapPosition = tapPosition;
            }
        }
        
        function getSelectedText() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const selectedText = selection.toString().trim();
                // Only return if text is actually selected (not just cursor position)
                if (selectedText.length > 0) {
                    return selectedText;
                }
            }
            return null;
        }
        
        function isClickWithinSelection(x, y) {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return false;
            
            const range = selection.getRangeAt(0);
            const rects = range.getClientRects();
            
            // Check if click coordinates are within any of the selection rectangles
            for (let i = 0; i < rects.length; i++) {
                const rect = rects[i];
                if (x >= rect.left && x <= rect.right && 
                    y >= rect.top && y <= rect.bottom) {
                    return true;
                }
            }
            return false;
        }
        
        function highlightSelectionBriefly() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                
                // Create a temporary span to highlight the selection
                const tempSpan = document.createElement('span');
                tempSpan.style.backgroundColor = 'rgba(93, 92, 222, 0.3)';
                tempSpan.style.color = '#5D5CDE';
                tempSpan.style.borderRadius = '3px';
                tempSpan.style.padding = '1px 2px';
                tempSpan.style.transition = 'all 0.2s ease';
                
                try {
                    // Surround the selection with the highlight span
                    range.surroundContents(tempSpan);
                    
                    // Remove the highlight after animation
                    setTimeout(() => {
                        // Unwrap the span, keeping the content
                        const parent = tempSpan.parentNode;
                        if (parent) {
                            while (tempSpan.firstChild) {
                                parent.insertBefore(tempSpan.firstChild, tempSpan);
                            }
                            parent.removeChild(tempSpan);
                            // Normalize the text nodes
                            parent.normalize();
                        }
                    }, 200);
                } catch (e) {
                    // If surroundContents fails (e.g., selection spans multiple elements),
                    // just clear the selection as visual feedback
                    setTimeout(() => {
                        selection.removeAllRanges();
                    }, 200);
                }
            }
        }
        
        function getWordAtPosition(x, y) {
            // Get the word at the click position
            const range = document.caretRangeFromPoint(x, y);
            if (!range) return null;
            
            const textNode = range.startContainer;
            if (textNode.nodeType !== Node.TEXT_NODE) return null;
            
            const text = textNode.textContent;
            const clickOffset = range.startOffset;
            
            // Find word boundaries
            const wordRegex = /\b\w+\b/g;
            let match;
            
            while ((match = wordRegex.exec(text)) !== null) {
                if (match.index <= clickOffset && clickOffset <= match.index + match[0].length) {
                    return match[0];
                }
            }
            
            return null;
        }
        
        function highlightWordBriefly(element, word) {
            // Create a brief visual feedback
            const originalBg = element.style.backgroundColor;
            const originalColor = element.style.color;
            
            // Flash the element briefly
            element.style.backgroundColor = 'rgba(93, 92, 222, 0.3)';
            element.style.color = '#5D5CDE';
            element.style.transition = 'all 0.2s ease';
            
            setTimeout(() => {
                element.style.backgroundColor = originalBg;
                element.style.color = originalColor;
                setTimeout(() => {
                    element.style.transition = '';
                }, 200);
            }, 200);
        }
        
        function highlightWordAtPosition(x, y, word) {
            // Get the element at the click position
            const range = document.caretRangeFromPoint(x, y);
            if (!range) return;
            
            const textNode = range.startContainer;
            if (textNode.nodeType !== Node.TEXT_NODE) return;
            
            const text = textNode.textContent;
            const clickOffset = range.startOffset;
            
            // Find the exact word position in the text
            const wordRegex = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
            let match;
            
            while ((match = wordRegex.exec(text)) !== null) {
                if (match.index <= clickOffset && clickOffset <= match.index + match[0].length) {
                    // Found the word, create a highlight
                    try {
                        const wordRange = document.createRange();
                        wordRange.setStart(textNode, match.index);
                        wordRange.setEnd(textNode, match.index + match[0].length);
                        
                        // Create temporary highlight span
                        const highlightSpan = document.createElement('span');
                        highlightSpan.style.backgroundColor = 'rgba(93, 92, 222, 0.3)';
                        highlightSpan.style.color = '#5D5CDE';
                        highlightSpan.style.borderRadius = '3px';
                        highlightSpan.style.padding = '1px 2px';
                        highlightSpan.style.transition = 'all 0.3s ease';
                        
                        // Surround the word with highlight
                        wordRange.surroundContents(highlightSpan);
                        
                        // Remove highlight after delay
                        setTimeout(() => {
                            const parent = highlightSpan.parentNode;
                            if (parent) {
                                // Unwrap the span while keeping the text
                                while (highlightSpan.firstChild) {
                                    parent.insertBefore(highlightSpan.firstChild, highlightSpan);
                                }
                                parent.removeChild(highlightSpan);
                                parent.normalize();
                            }
                        }, 1000);
                        
                    } catch (e) {
                        // If highlighting fails, fall back to element-level highlight
                        const element = textNode.parentElement;
                        if (element) {
                            highlightWordBriefly(element, word);
                        }
                    }
                    break;
                }
            }
        }
        
        function searchForWord(word) {
            // Close view modal if open
            document.getElementById('viewModal').classList.add('hidden');
            
            // Perform search
            document.getElementById('searchInput').value = word;
            activeFilters.search = word;
            activeFilters.author = '';
            activeFilters.tag = '';
            applyFilters();
            
            // Show notification
            showNotification(`üîç Searching for "${word}"...`, 'success');
        }

        function setupCommentForm(note) {
            const addCommentForm = document.getElementById('addCommentForm');
            const commentLoginPrompt = document.getElementById('commentLoginPrompt');
            const commentInput = document.getElementById('commentInput');
            const submitCommentBtn = document.getElementById('submitCommentBtn');
            const cancelCommentBtn = document.getElementById('cancelCommentBtn');
            const commentUserPic = document.getElementById('commentUserPic');
            const loginToCommentBtn = document.getElementById('loginToCommentBtn');
            const commentPreview = document.getElementById('commentPreview');
            const commentPreviewText = document.getElementById('commentPreviewText');
            const showLessBtn = document.getElementById('showLessBtn');
            
            if (currentUser) {
                // User is logged in - show comment form
                addCommentForm.classList.remove('hidden');
                commentLoginPrompt.classList.add('hidden');
                commentUserPic.src = getUserProfilePicture(currentUser);
                
                // Clear previous listeners
                submitCommentBtn.onclick = null;
                cancelCommentBtn.onclick = null;
                commentInput.oninput = null;
                commentInput.onfocus = null;
                commentInput.onblur = null;
                
                // Progressive input functionality
                let isExpanded = false;
                
                const resetCommentForm = () => {
                    commentInput.value = '';
                    commentInput.style.height = '40px';
                    commentInput.rows = 1;
                    cancelCommentBtn.classList.add('opacity-0', 'pointer-events-none');
                    submitCommentBtn.classList.add('opacity-50', 'pointer-events-none');
                    submitCommentBtn.disabled = true;
                    commentPreview.classList.add('hidden');
                    isExpanded = false;
                };
                
                const autoExpandTextarea = () => {
                    commentInput.style.height = 'auto';
                    const scrollHeight = commentInput.scrollHeight;
                    const maxHeight = 120; // Max height from CSS
                    commentInput.style.height = Math.min(scrollHeight, maxHeight) + 'px';
                };
                
                const updateCommentState = () => {
                    const content = commentInput.value.trim();
                    const hasContent = content.length > 0;
                    
                    // Auto-expand textarea
                    autoExpandTextarea();
                    
                    // Show/hide action buttons
                    if (hasContent) {
                        cancelCommentBtn.classList.remove('opacity-0', 'pointer-events-none');
                        submitCommentBtn.classList.remove('opacity-50', 'pointer-events-none');
                        submitCommentBtn.disabled = false;
                        
                        // Handle long text with preview
                        if (content.length > 200) {
                            const truncated = content.substring(0, 200);
                            const remaining = content.substring(200);
                            
                            commentPreviewText.innerHTML = `${truncated}<span class="text-gray-500">...more</span>`;
                            commentPreview.classList.remove('hidden');
                        } else {
                            commentPreview.classList.add('hidden');
                        }
                    } else {
                        cancelCommentBtn.classList.add('opacity-0', 'pointer-events-none');
                        submitCommentBtn.classList.add('opacity-50', 'pointer-events-none');
                        submitCommentBtn.disabled = true;
                        commentPreview.classList.add('hidden');
                    }
                };
                
                // Input event listeners
                commentInput.oninput = updateCommentState;
                
                commentInput.onfocus = () => {
                    isExpanded = true;
                    updateCommentState();
                };
                
                commentInput.onblur = (e) => {
                    // Don't collapse if clicking on action buttons
                    if (e.relatedTarget && (e.relatedTarget === submitCommentBtn || e.relatedTarget === cancelCommentBtn)) {
                        return;
                    }
                    
                    // If no content, collapse after a short delay
                    if (!commentInput.value.trim()) {
                        setTimeout(() => {
                            if (!commentInput.value.trim() && document.activeElement !== commentInput) {
                                resetCommentForm();
                            }
                        }, 150);
                    }
                };
                
                // Handle comment submission
                submitCommentBtn.onclick = () => {
                    const content = commentInput.value.trim();
                    if (content) {
                        const comment = addCommentToNote(note.id, content);
                        if (comment) {
                            resetCommentForm();
                            renderComments(note);
                            showNotification('Comment added!', 'success');
                        }
                    }
                };
                
                // Handle cancel
                cancelCommentBtn.onclick = () => {
                    resetCommentForm();
                    commentInput.blur();
                };
                
                // Show less functionality for long text preview
                showLessBtn.onclick = () => {
                    commentPreview.classList.add('hidden');
                };
                
                // Initialize form state
                resetCommentForm();
                
            } else {
                // User is not logged in - show login prompt
                addCommentForm.classList.add('hidden');
                commentLoginPrompt.classList.remove('hidden');
                
                loginToCommentBtn.onclick = () => {
                    document.getElementById('viewModal').classList.add('hidden');
                    showAuthModal(false);
                };
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'just now';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes}m ago`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours}h ago`;
            } else if (diffInSeconds < 604800) {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days}d ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // Media management
        let currentNoteMedia = []; // Store current note's media files

        function addMediaToNote(files) {
            const promises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const mediaItem = {
                            id: Date.now() + Math.random(),
                            type: file.type.startsWith('image/') ? 'image' : 'video',
                            data: e.target.result,
                            name: file.name,
                            size: file.size
                        };
                        resolve(mediaItem);
                    };
                    reader.readAsDataURL(file);
                });
            });

            Promise.all(promises).then(mediaItems => {
                currentNoteMedia.push(...mediaItems);
                updateMediaPreview();
            });
        }

        function removeMediaFromNote(mediaId) {
            currentNoteMedia = currentNoteMedia.filter(item => item.id !== mediaId);
            updateMediaPreview();
        }

        function updateMediaPreview() {
            const gallery = document.getElementById('mediaPreviewGallery');
            const grid = document.getElementById('mediaPreviewGrid');

            if (currentNoteMedia.length === 0) {
                gallery.classList.add('hidden');
                return;
            }

            gallery.classList.remove('hidden');
            grid.innerHTML = currentNoteMedia.map(item => {
                if (item.type === 'image') {
                    return `
                        <div class="relative group flex-shrink-0">
                            <img src="${item.data}" alt="${item.name}" class="w-20 h-16 object-cover rounded-lg">
                            <button type="button" class="media-edit-btn absolute top-1 left-1 w-4 h-4 bg-primary text-white rounded-full text-xs hover:bg-primary/90 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center" data-media-id="${item.id}">
                                <i class="fas fa-edit" style="font-size: 6px;"></i>
                            </button>
                            <button type="button" class="media-remove-btn absolute top-1 right-1 w-4 h-4 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center" data-media-id="${item.id}">
                                <i class="fas fa-times" style="font-size: 8px;"></i>
                            </button>
                            <div class="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 rounded">
                                <i class="fas fa-image"></i>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="relative group flex-shrink-0">
                            <video src="${item.data}" class="w-20 h-16 object-cover rounded-lg" muted></video>
                            <button type="button" class="media-edit-btn absolute top-1 left-1 w-4 h-4 bg-primary text-white rounded-full text-xs hover:bg-primary/90 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center" data-media-id="${item.id}">
                                <i class="fas fa-edit" style="font-size: 6px;"></i>
                            </button>
                            <button type="button" class="media-remove-btn absolute top-1 right-1 w-4 h-4 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center" data-media-id="${item.id}">
                                <i class="fas fa-times" style="font-size: 8px;"></i>
                            </button>
                            <div class="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 rounded">
                                <i class="fas fa-video"></i>
                            </div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <i class="fas fa-play text-white text-sm opacity-70"></i>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            // Add event listeners to remove and edit buttons
            grid.querySelectorAll('.media-remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const mediaId = parseFloat(btn.dataset.mediaId); // Convert string back to number
                    removeMediaFromNote(mediaId);
                });
            });

            grid.querySelectorAll('.media-edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const mediaId = parseFloat(btn.dataset.mediaId);
                    const mediaItem = currentNoteMedia.find(item => item.id === mediaId);
                    if (mediaItem) {
                        showMediaEditModal(mediaItem);
                    }
                });
            });
        }

        function displayPaymentInfo(note) {

            
            // Check if note has payment data
            if (!note.payment) {

                return;
            }
            
            const paymentType = note.payment.type;

            
            // Create payment display section if it doesn't exist
            let paymentSection = document.getElementById('paymentInfoSection');
            if (!paymentSection) {
                // Create payment section after event section
                const eventSection = document.getElementById('eventInfoSection');
                paymentSection = document.createElement('div');
                paymentSection.id = 'paymentInfoSection';
                paymentSection.className = 'hidden mt-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800';
                
                // Insert after event section (or after content if no event section)
                if (eventSection) {
                    eventSection.parentNode.insertBefore(paymentSection, eventSection.nextSibling);
                } else {
                    const contentSection = document.getElementById('contentSection');
                    contentSection.appendChild(paymentSection);
                }
            }
            
            // Handle free payments - only show if there are payment details
            if (paymentType === 'free') {
                if (note.payment.details && note.payment.details.trim()) {
                    paymentSection.classList.remove('hidden');
                    paymentSection.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="text-green-600 dark:text-green-400">
                                <i class="fas fa-hand-holding-heart text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-medium text-green-900 dark:text-green-100 mb-2">Free Event</h4>
                                <div class="text-sm text-green-800 dark:text-green-200">${note.payment.details}</div>
                            </div>
                        </div>
                    `;
                } else {
                    paymentSection.classList.add('hidden');
                }
                return;
            }
            
            // Show payment section for all other payment types
            paymentSection.classList.remove('hidden');
            
            let paymentHTML = '';
            let paymentAmount = null;
            let showPayButton = false;
            let payButtonText = '';
            let payButtonClass = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium';
            
            if (paymentType === 'donation') {
                const amount = note.payment.amount;
                if (amount && amount > 0) {
                    // Fixed donation amount
                    paymentAmount = `$${amount.toFixed(2)}`;
                    payButtonText = `üíù Donate $${amount.toFixed(2)}`;
                    showPayButton = true;
                } else {
                    // User-defined donation amount
                    payButtonText = 'üíù Choose Donation Amount';
                    showPayButton = true;
                }
                
                paymentHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="text-green-600 dark:text-green-400">
                            <i class="fas fa-hand-holding-heart text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-green-900 dark:text-green-100 mb-2">Donation Requested</h4>
                            ${paymentAmount ? `<div class="text-lg font-semibold text-green-800 dark:text-green-200 mb-2">Suggested: ${paymentAmount}</div>` : '<div class="text-sm text-green-800 dark:text-green-200 mb-2">Any amount appreciated</div>'}
                            ${note.payment.details ? `<div class="text-sm text-green-700 dark:text-green-300 mb-3">${note.payment.details}</div>` : ''}
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-green-600 dark:text-green-400">Support this creator</div>
                                ${showPayButton ? `<button class="pay-btn ${payButtonClass}" data-payment-type="donation" data-amount="${note.payment.amount || 0}">${payButtonText}</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else if (paymentType === 'payment') {
                const amount = note.payment.amount;
                if (amount && amount > 0) {
                    // Fixed payment amount
                    paymentAmount = `$${amount.toFixed(2)}`;
                    payButtonText = `üí≥ Pay $${amount.toFixed(2)}`;
                    showPayButton = true;
                } else {
                    // User-defined payment amount
                    payButtonText = 'üí≥ Make Payment';
                    showPayButton = true;
                }
                
                paymentHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="text-green-600 dark:text-green-400">
                            <i class="fas fa-credit-card text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-green-900 dark:text-green-100 mb-2">Payment Required</h4>
                            ${paymentAmount ? `<div class="text-lg font-semibold text-green-800 dark:text-green-200 mb-2">${paymentAmount}</div>` : '<div class="text-sm text-green-800 dark:text-green-200 mb-2">Amount to be determined</div>'}
                            ${note.payment.details ? `<div class="text-sm text-green-700 dark:text-green-300 mb-3">${note.payment.details}</div>` : ''}
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-green-600 dark:text-green-400">Secure payment</div>
                                ${showPayButton ? `<button class="pay-btn ${paymentButtonClass}" data-payment-type="payment" data-amount="${note.payment.amount || 0}">${payButtonText}</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else if (paymentType === 'crowdfund') {
                const goal = note.payment.goal || 0;
                const raised = note.payment.raised || 0;
                const percentage = goal > 0 ? Math.min((raised / goal) * 100, 100) : 0;
                const remaining = Math.max(goal - raised, 0);
                
                // Determine status and colors
                let statusText = '';
                let statusColor = 'text-blue-600 dark:text-blue-400';
                let progressColor = 'bg-blue-500';
                
                if (percentage >= 100) {
                    statusText = 'üéâ Goal Reached!';
                    statusColor = 'text-green-600 dark:text-green-400';
                    progressColor = 'bg-green-500';
                } else if (percentage >= 75) {
                    statusText = 'üî• Almost There!';
                    statusColor = 'text-orange-600 dark:text-orange-400';
                    progressColor = 'bg-orange-500';
                } else if (percentage >= 50) {
                    statusText = 'üí™ Halfway Point!';
                    statusColor = 'text-blue-600 dark:text-blue-400';
                    progressColor = 'bg-blue-500';
                } else if (percentage >= 25) {
                    statusText = 'üöÄ Getting Started!';
                    statusColor = 'text-blue-600 dark:text-blue-400';
                    progressColor = 'bg-blue-500';
                } else {
                    statusText = 'üíù Help Us Reach Our Goal';
                    statusColor = 'text-gray-600 dark:text-gray-400';
                    progressColor = 'bg-gray-400';
                }
                
                paymentHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="text-blue-600 dark:text-blue-400">
                            <i class="fas fa-chart-line text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-blue-900 dark:text-blue-100 mb-2">Crowdfunding Campaign</h4>
                            
                            <!-- Status and amounts -->
                            <div class="mb-3">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-semibold ${statusColor}">${statusText}</div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">${percentage.toFixed(0)}% complete</div>
                                </div>
                                
                                <!-- Progress bar -->
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                                    <div class="${progressColor} h-3 rounded-full transition-all duration-500 ease-out" style="width: ${percentage}%"></div>
                                </div>
                                
                                <!-- Amount details -->
                                <div class="flex items-center justify-between text-sm">
                                    <div class="font-medium text-blue-800 dark:text-blue-200">
                                        $${raised.toFixed(2)} raised of $${goal.toFixed(2)} goal
                                    </div>
                                    ${percentage < 100 ? `<div class="text-gray-600 dark:text-gray-400">$${remaining.toFixed(2)} to go</div>` : '<div class="text-green-600 dark:text-green-400 font-medium">Goal achieved! üéâ</div>'}
                                </div>
                            </div>
                            
                            ${note.payment.details ? `<div class="text-sm text-blue-700 dark:text-blue-300 mb-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">${note.payment.details}</div>` : ''}
                            
                            <!-- Contribute button -->
                            <div class="flex items-center justify-between">
                                <div class="text-sm ${statusColor}">Every contribution helps!</div>
                                <button class="pay-btn px-4 py-2 ${percentage >= 100 ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white rounded-lg transition-colors text-sm font-medium" data-payment-type="crowdfund" data-goal="${goal}" data-raised="${raised}">
                                    <i class="fas fa-heart mr-2"></i>${percentage >= 100 ? 'Still Contribute' : 'Contribute Now'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (paymentType === 'ticket-price') {
                // Ticket pricing is already handled in the event section, but we can show additional payment info here
                const ticketPrice = note.payment.ticketPrice || 0;
                const availableTickets = note.payment.availableTickets;
                
                if (ticketPrice > 0) {
                    paymentHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="text-green-600 dark:text-green-400">
                                <i class="fas fa-ticket-alt text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-medium text-green-900 dark:text-green-100 mb-2">Ticketed Event</h4>
                                <div class="text-lg font-semibold text-green-800 dark:text-green-200 mb-2">$${ticketPrice.toFixed(2)} per ticket</div>
                                ${availableTickets ? `<div class="text-sm text-green-700 dark:text-green-300 mb-2">${availableTickets} tickets available</div>` : '<div class="text-sm text-green-700 dark:text-green-300 mb-2">Limited tickets available</div>'}
                                ${note.payment.details ? `<div class="text-sm text-green-700 dark:text-green-300 mb-3">${note.payment.details}</div>` : ''}
                                <div class="text-xs text-green-600 dark:text-green-400">Purchase tickets using the RSVP button above</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Free tickets but still limited quantity
                    if (availableTickets && availableTickets > 0) {
                        paymentHTML = `
                            <div class="flex items-start space-x-3">
                                <div class="text-green-600 dark:text-green-400">
                                    <i class="fas fa-ticket-alt text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-medium text-green-900 dark:text-green-100 mb-2">Free Tickets Required</h4>
                                    <div class="text-sm text-green-700 dark:text-green-300 mb-2">${availableTickets} free tickets available</div>
                                    ${note.payment.details ? `<div class="text-sm text-green-700 dark:text-green-300 mb-3">${note.payment.details}</div>` : ''}
                                    <div class="text-xs text-green-600 dark:text-green-400">Reserve your free ticket using the RSVP button above</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Unlimited free tickets - handled by event section only
                        paymentSection.classList.add('hidden');
                        return;
                    }
                }
            }
            
            paymentSection.innerHTML = paymentHTML;
            
            // Add payment button handlers
            const payButton = paymentSection.querySelector('.pay-btn');
            if (payButton) {
                payButton.onclick = () => {
                    if (!currentUser) {
                        document.getElementById('viewModal').classList.add('hidden');
                        showAuthModal(false);
                        return;
                    }
                    
                    const paymentType = payButton.dataset.paymentType;
                    const amount = parseFloat(payButton.dataset.amount) || 0;
                    
                    if (paymentType === 'donation') {
                        handleDonationPayment(note, amount);
                    } else if (paymentType === 'payment') {
                        handleGeneralPayment(note, amount);
                    }
                };
            }
        }
        
        function handleDonationPayment(note, suggestedAmount) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">üíù Make a Donation</h3>
                        <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                            <h4 class="font-medium text-green-900 dark:text-green-100 mb-2">${note.title}</h4>
                            <div class="text-sm text-green-800 dark:text-green-200">Supporting: ${note.author}</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Donation Amount</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                <input type="number" id="donationAmount" step="0.01" min="0" value="${suggestedAmount || ''}" placeholder="Enter amount" 
                                       class="w-full pl-8 pr-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            ${suggestedAmount > 0 ? `<div class="text-xs text-gray-500 mt-1">Suggested: $${suggestedAmount.toFixed(2)}</div>` : '<div class="text-xs text-gray-500 mt-1">Any amount is appreciated</div>'}
                        </div>
                        
                        ${note.payment.details ? `
                            <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm font-medium mb-1">Payment Instructions:</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${note.payment.details}</div>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-end space-x-3">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button class="confirm-btn px-4 py-2 bg-green-600 text-white hover:bg-green-700 rounded">
                                <i class="fas fa-heart mr-2"></i>Donate
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.querySelector('.confirm-btn').onclick = () => {
                const amount = parseFloat(document.getElementById('donationAmount').value) || 0;
                if (amount <= 0) {
                    showAlert('Please enter a valid donation amount');
                    return;
                }
                
                // Create transaction
                const transaction = createTransaction('donation', amount, note.authorId, note.payment.details || 'Donation support', note.id);
                
                modal.remove();
                if (transaction) {
                    showNotification(`Donation request sent to ${note.author}!`, 'success');
                } else {
                    showNotification('Failed to send donation request', 'error');
                }
            };
            
            document.body.appendChild(modal);
        }
        
        function handleGeneralPayment(note, fixedAmount) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">üí≥ Make Payment</h3>
                        <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                            <h4 class="font-medium text-blue-900 dark:text-blue-100 mb-2">${note.title}</h4>
                            <div class="text-sm text-blue-800 dark:text-blue-200">Payee: ${note.author}</div>
                        </div>
                        
                        ${fixedAmount > 0 ? `
                            <div>
                                <label class="block text-sm font-medium mb-2">Payment Amount</label>
                                <div class="text-2xl font-bold text-center py-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    $${fixedAmount.toFixed(2)}
                                </div>
                            </div>
                        ` : `
                            <div>
                                <label class="block text-sm font-medium mb-2">Payment Amount</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                    <input type="number" id="paymentAmount" step="0.01" min="0" placeholder="Enter amount" 
                                           class="w-full pl-8 pr-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                        `}
                        
                        ${note.payment.details ? `
                            <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm font-medium mb-1">Payment Instructions:</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">${note.payment.details}</div>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-end space-x-3">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button class="confirm-btn px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded">
                                <i class="fas fa-credit-card mr-2"></i>Pay Now
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.querySelector('.confirm-btn').onclick = () => {
                let amount = fixedAmount;
                if (fixedAmount <= 0) {
                    amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
                    if (amount <= 0) {
                        showAlert('Please enter a valid payment amount');
                        return;
                    }
                }
                
                // Create transaction
                const transaction = createTransaction('payment', amount, note.authorId, note.payment.details || 'Payment', note.id);
                
                modal.remove();
                if (transaction) {
                    showNotification(`Payment request of $${amount.toFixed(2)} sent to ${note.author}!`, 'success');
                } else {
                    showNotification('Failed to send payment request', 'error');
                }
            };
            
            document.body.appendChild(modal);
        }

        function displayEventInfo(note) {
            const eventInfoSection = document.getElementById('eventInfoSection');
            const eventDateTime = document.getElementById('eventDateTime');
            const rsvpCount = document.getElementById('rsvpCount');
            const rsvpButton = document.getElementById('rsvpButton');
            const rsvpListSection = document.getElementById('rsvpListSection');
            const rsvpList = document.getElementById('rsvpList');
            
            // Debug logging
            console.log('=== DISPLAY EVENT INFO DEBUG ===');
            console.log('Note:', note.title);
            console.log('Note object keys:', Object.keys(note));
            console.log('Event data exists:', !!note.event);
            console.log('Event data:', note.event);
            console.log('Payment data:', note.payment);

            
            // Check if note has event data
            if (!note.event || !note.event.startDate || !note.event.startTime) {
                console.log('No valid event data found, hiding event section');
                eventInfoSection.classList.add('hidden');
                return;
            }
            
            console.log('Valid event data found, showing event section');
            
            // Show event section (visible to everyone, including logged-out users)
            eventInfoSection.classList.remove('hidden');
            
            // Format event date/time
            const startDate = new Date(`${note.event.startDate}T${note.event.startTime}`);
            let dateTimeText = `Starts: ${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            
            if (note.event.endDate && note.event.endTime) {
                const endDate = new Date(`${note.event.endDate}T${note.event.endTime}`);
                dateTimeText += `\nEnds: ${endDate.toLocaleDateString()} at ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            }
            
            eventDateTime.textContent = dateTimeText;
            
            // Initialize RSVPs array if it doesn't exist
            if (!note.rsvps) note.rsvps = [];
            
            // Show RSVP count
            const rsvpCountNum = note.rsvps.length;
            rsvpCount.textContent = `${rsvpCountNum} RSVP${rsvpCountNum !== 1 ? 's' : ''}`;
            
            // Show/Hide RSVP list based on visibility setting and if there are RSVPs
            if (note.event.rsvpListVisible && rsvpCountNum > 0) {
                rsvpListSection.classList.remove('hidden');
                
                // Generate list of attendees
                const attendeeElements = note.rsvps.map(rsvpUserId => {
                    const user = users.find(u => u.id === rsvpUserId);
                    if (!user) return '<div class="text-xs text-gray-500">Unknown User</div>';
                    
                    const profilePic = getUserProfilePicture(user);
                    return `
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 rounded-full overflow-hidden border border-blue-300 dark:border-blue-600 cursor-pointer" onclick="showUserProfile('${user.username}', ${user.id})">
                                <img src="${profilePic}" alt="${user.username}" class="w-full h-full object-cover">
                            </div>
                            <span class="text-xs font-medium cursor-pointer hover:text-blue-800 dark:hover:text-blue-200 transition-colors" onclick="showUserProfile('${user.username}', ${user.id})">${user.username}</span>
                        </div>
                    `;
                });
                
                rsvpList.innerHTML = attendeeElements.join('');
            } else {
                rsvpListSection.classList.add('hidden');
            }
            
            // Configure RSVP button - show for everyone, including logged-out users
            if (!currentUser) {
                rsvpButton.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Login to RSVP';
                rsvpButton.className = 'px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm font-medium';
                rsvpButton.onclick = () => {
                    document.getElementById('viewModal').classList.add('hidden');
                    showAuthModal(false);
                };
            } else {
                const hasRSVPd = note.rsvps.includes(currentUser.id);
                const hasTicketPrice = note.payment && note.payment.type === 'ticket-price' && note.payment.ticketPrice > 0;
                
                if (hasRSVPd) {
                    rsvpButton.innerHTML = '<i class="fas fa-check-circle mr-2"></i>RSVP\'d';
                    rsvpButton.className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium';
                    rsvpButton.onclick = () => {
                        showConfirmDialog('Remove your RSVP?', () => {
                            // Remove RSVP
                            note.rsvps = note.rsvps.filter(id => id !== currentUser.id);
                            displayEventInfo(note); // Refresh display
                            showNotification('RSVP removed', 'success');
                        });
                    };
                } else {
                    if (hasTicketPrice) {
                        rsvpButton.innerHTML = `<i class="fas fa-ticket-alt mr-2"></i>Buy Tickets ($${note.payment.ticketPrice})`;
                    } else {
                        rsvpButton.innerHTML = '<i class="fas fa-check mr-2"></i>RSVP';
                    }
                    rsvpButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium';
                    rsvpButton.onclick = () => {
                        if (hasTicketPrice) {
                            handleTicketPurchase(note);
                        } else {
                            handleRSVP(note);
                        }
                    };
                }
            }
        }

        function handleRSVP(note) {
            if (!currentUser) return;
            
            // Add user to RSVP list
            if (!note.rsvps) note.rsvps = [];
            if (!note.rsvps.includes(currentUser.id)) {
                note.rsvps.push(currentUser.id);
                displayEventInfo(note); // Refresh display
                showNotification('RSVP confirmed!', 'success');
            }
        }

        function handleTicketPurchase(note) {
            if (!currentUser) return;
            
            const ticketPrice = note.payment.ticketPrice;
            const paymentDetails = note.payment.details || 'No payment details provided';
            
            // Show ticket purchase modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Purchase Tickets</h3>
                        <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                            <h4 class="font-medium text-blue-900 dark:text-blue-100 mb-2">${note.title}</h4>
                            <div class="text-sm text-blue-800 dark:text-blue-200">
                                <div>Price: $${ticketPrice} per ticket</div>
                                <div class="mt-2">Available: ${note.payment.availableTickets || 'Unlimited'}</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Number of Tickets</label>
                            <input type="number" id="ticketQuantity" min="1" max="${note.payment.availableTickets || 10}" value="1" 
                                   class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                            <div class="text-sm font-medium mb-1">Payment Instructions:</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">${paymentDetails}</div>
                        </div>
                        
                        <div class="text-lg font-semibold">
                            Total: $<span id="totalPrice">${ticketPrice}</span>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button class="confirm-btn px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded">
                                <i class="fas fa-credit-card mr-2"></i>Purchase
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Update total price when quantity changes
            const quantityInput = modal.querySelector('#ticketQuantity');
            const totalPriceSpan = modal.querySelector('#totalPrice');
            
            quantityInput.oninput = () => {
                const quantity = parseInt(quantityInput.value) || 1;
                totalPriceSpan.textContent = (ticketPrice * quantity).toFixed(2);
            };
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.querySelector('.confirm-btn').onclick = () => {
                const quantity = parseInt(quantityInput.value) || 1;
                const total = ticketPrice * quantity;
                
                // Simulate purchase and add RSVP
                if (!note.rsvps) note.rsvps = [];
                if (!note.rsvps.includes(currentUser.id)) {
                    note.rsvps.push(currentUser.id);
                }
                
                // Update available tickets if limited
                if (note.payment.availableTickets) {
                    note.payment.availableTickets = Math.max(0, note.payment.availableTickets - quantity);
                }
                
                modal.remove();
                displayEventInfo(note); // Refresh display
                showNotification(`Tickets purchased! Total: $${total.toFixed(2)}`, 'success');
            };
            
            document.body.appendChild(modal);
        }

        function renderMediaGallery(note) {
            const gallery = document.getElementById('viewMediaGallery');
            const grid = document.getElementById('viewMediaGrid');

            if (!note.media || note.media.length === 0) {
                gallery.classList.add('hidden');
                return;
            }

            gallery.classList.remove('hidden');
            
            // Generate media HTML with dynamic sizing based on expansion state
            const updateMediaHTML = (isExpanded = false) => {
                const imageWidth = isExpanded ? 'w-64' : 'w-32';
                const imageHeight = isExpanded ? 'h-48' : 'h-24';
                
                return note.media.map((item, index) => {
                    // Get the title, description, and price for the media item
                    const title = item.title || '';
                    const description = item.description || '';
                    const price = item.price && item.price > 0 ? `${getCurrencySymbol(item.currency)}${item.price}` : '';
                    
                    // Create overlay info
                    let overlayInfo = '';
                    if (title || price) {
                        overlayInfo = `
                            <div class="absolute top-1 left-1 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded max-w-full">
                                ${title ? `<div class="font-medium truncate">${title}</div>` : ''}
                                ${price ? `<div class="text-green-400">${price}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    if (item.type === 'image') {
                        return `
                            <div class="relative cursor-pointer flex-shrink-0 ${imageWidth}" onclick="showMediaModal(${JSON.stringify(item).replace(/"/g, '&quot;')}, ${JSON.stringify(note.media).replace(/"/g, '&quot;')}, ${index})">
                                <img src="${item.data}" alt="${item.name}" class="${imageWidth} ${imageHeight} object-cover rounded-lg hover:opacity-90 transition-all duration-300">
                                ${overlayInfo}
                                <div class="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 py-0.5 rounded">
                                    <i class="fas fa-image mr-1"></i>${isExpanded ? 'Image' : ''}
                                </div>
                                ${description && isExpanded ? `
                                    <div class="absolute bottom-8 left-1 right-1 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                        <div class="truncate">${description}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        return `
                            <div class="relative cursor-pointer flex-shrink-0 ${imageWidth}" onclick="showMediaModal(${JSON.stringify(item).replace(/"/g, '&quot;')}, ${JSON.stringify(note.media).replace(/"/g, '&quot;')}, ${index})">
                                <video src="${item.data}" class="${imageWidth} ${imageHeight} object-cover rounded-lg hover:opacity-90 transition-all duration-300" muted></video>
                                ${overlayInfo}
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="${isExpanded ? 'w-12 h-12' : 'w-6 h-6'} bg-black bg-opacity-60 rounded-full flex items-center justify-center transition-all duration-300">
                                        <i class="fas fa-play text-white ${isExpanded ? 'text-lg' : 'text-xs'}"></i>
                                    </div>
                                </div>
                                <div class="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 py-0.5 rounded">
                                    <i class="fas fa-video mr-1"></i>${isExpanded ? 'Video' : ''}
                                </div>
                                ${description && isExpanded ? `
                                    <div class="absolute bottom-8 left-1 right-1 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                        <div class="truncate">${description}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                }).join('');
            };
            
            // Set initial collapsed state
            grid.innerHTML = updateMediaHTML(false);
            
            // Store the update function for use by expansion logic
            grid.updateMediaHTML = updateMediaHTML;
        }

        function showMediaModal(mediaItem, allMediaItems = null, currentIndex = 0) {
            // Handle backwards compatibility - if passed string, treat as src
            if (typeof mediaItem === 'string') {
                const src = mediaItem;
                const type = arguments[1] || 'image';
                mediaItem = { data: src, type: type };
                allMediaItems = [mediaItem];
                currentIndex = 0;
            }
            
            // If no allMediaItems provided, create array with single item
            if (!allMediaItems) {
                allMediaItems = [mediaItem];
                currentIndex = 0;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[3000] p-4';
            
            // Store navigation data on modal
            modal.allMediaItems = allMediaItems;
            modal.currentIndex = currentIndex;
            
            function updateModalContent() {
                const currentItem = allMediaItems[modal.currentIndex];
                
                // Create info panel HTML if there's title, description, or price
                const hasInfo = currentItem.title || currentItem.description || (currentItem.price && currentItem.price > 0);
                const priceText = currentItem.price && currentItem.price > 0 ? `${getCurrencySymbol(currentItem.currency)}${currentItem.price}` : '';
                
                let infoPanelHTML = '';
                if (hasInfo) {
                    infoPanelHTML = `
                        <div class="absolute bottom-4 left-4 right-4 bg-black bg-opacity-75 text-white p-4 rounded-lg max-w-lg">
                            ${currentItem.title ? `<h3 class="text-lg font-semibold mb-2">${currentItem.title}</h3>` : ''}
                            ${currentItem.description ? `<p class="text-sm text-gray-200 mb-3">${currentItem.description}</p>` : ''}
                            ${priceText ? `
                                <div class="flex items-center justify-between">
                                    <div class="text-xl font-bold text-green-400">${priceText}</div>
                                    <button class="buy-btn px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                        <i class="fas fa-shopping-cart mr-2"></i>Buy Now
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Navigation indicators (only show if more than 1 item)
                let navigationHTML = '';
                if (allMediaItems.length > 1) {
                    const dots = allMediaItems.map((_, index) => 
                        `<div class="w-2 h-2 rounded-full mx-1 transition-all duration-200 ${index === modal.currentIndex ? 'bg-white' : 'bg-white bg-opacity-50'}"></div>`
                    ).join('');
                    
                    navigationHTML = `
                        <!-- Navigation Arrows -->
                        ${modal.currentIndex > 0 ? `
                            <button class="nav-btn nav-prev absolute left-4 top-1/2 transform -translate-y-1/2 w-12 h-12 bg-black bg-opacity-50 text-white hover:bg-opacity-75 rounded-full flex items-center justify-center text-xl transition-all duration-200">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        ` : ''}
                        
                        ${modal.currentIndex < allMediaItems.length - 1 ? `
                            <button class="nav-btn nav-next absolute right-4 top-1/2 transform -translate-y-1/2 w-12 h-12 bg-black bg-opacity-50 text-white hover:bg-opacity-75 rounded-full flex items-center justify-center text-xl transition-all duration-200">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        ` : ''}
                        
                        <!-- Dots Indicator -->
                        <div class="absolute top-4 left-1/2 transform -translate-x-1/2 flex items-center bg-black bg-opacity-50 px-3 py-2 rounded-full">
                            ${dots}
                        </div>
                        
                        <!-- Counter -->
                        <div class="absolute top-4 left-4 bg-black bg-opacity-50 text-white px-3 py-2 rounded-lg text-sm">
                            ${modal.currentIndex + 1} / ${allMediaItems.length}
                        </div>
                    `;
                }
                
                if (currentItem.type === 'image') {
                    modal.innerHTML = `
                        <div class="media-container relative w-full h-full flex items-center justify-center">
                            <img src="${currentItem.data}" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl transition-opacity duration-300">
                            <button class="close-btn absolute top-4 right-4 w-10 h-10 bg-black bg-opacity-50 text-white hover:bg-opacity-75 rounded-full flex items-center justify-center text-xl transition-all duration-200">
                                <i class="fas fa-times"></i>
                            </button>
                            ${navigationHTML}
                            ${!hasInfo && allMediaItems.length === 1 ? `<div class="absolute bottom-4 left-4 bg-black bg-opacity-50 text-white px-3 py-2 rounded-lg text-sm">
                                <i class="fas fa-image mr-2"></i>Click outside to close
                            </div>` : ''}
                            ${infoPanelHTML}
                        </div>
                    `;
                } else {
                    modal.innerHTML = `
                        <div class="media-container relative w-full h-full flex items-center justify-center">
                            <video src="${currentItem.data}" controls class="max-w-full max-h-full rounded-lg shadow-2xl transition-opacity duration-300" autoplay>
                                Your browser does not support the video tag.
                            </video>
                            <button class="close-btn absolute top-4 right-4 w-10 h-10 bg-black bg-opacity-50 text-white hover:bg-opacity-75 rounded-full flex items-center justify-center text-xl transition-all duration-200">
                                <i class="fas fa-times"></i>
                            </button>
                            ${navigationHTML}
                            ${!hasInfo && allMediaItems.length === 1 ? `<div class="absolute bottom-4 left-4 bg-black bg-opacity-50 text-white px-3 py-2 rounded-lg text-sm">
                                <i class="fas fa-video mr-2"></i>Click outside to close
                            </div>` : ''}
                            ${infoPanelHTML}
                        </div>
                    `;
                }
                
                // Add buy button handler if there's a price
                if (priceText) {
                    const buyBtn = modal.querySelector('.buy-btn');
                    if (buyBtn) {
                        buyBtn.onclick = (e) => {
                            e.stopPropagation();
                            handleMediaPurchase(currentItem);
                        };
                    }
                }
                
                // Add navigation button handlers
                const prevBtn = modal.querySelector('.nav-prev');
                const nextBtn = modal.querySelector('.nav-next');
                
                if (prevBtn) {
                    prevBtn.onclick = (e) => {
                        e.stopPropagation();
                        navigateMedia(-1);
                    };
                }
                
                if (nextBtn) {
                    nextBtn.onclick = (e) => {
                        e.stopPropagation();
                        navigateMedia(1);
                    };
                }
            }
            
            function navigateMedia(direction) {
                const newIndex = modal.currentIndex + direction;
                if (newIndex >= 0 && newIndex < allMediaItems.length) {
                    modal.currentIndex = newIndex;
                    updateModalContent();
                }
            }
            
            // Initial content setup
            updateModalContent();
            
            // Swipe and drag detection
            let startX = 0;
            let startY = 0;
            let currentX = 0;
            let currentY = 0;
            let isDragging = false;
            let isHorizontalSwipe = false;
            let touchStartTime = 0;
            
            // Get the media container for better touch targeting
            const getMediaElement = () => {
                return modal.querySelector('img, video');
            };
            
            // Touch events for mobile - attach to the modal but check for media area
            const handleTouchStart = (e) => {
                if (allMediaItems.length <= 1) return;
                
                // Only handle touches on the media area, not on buttons
                if (e.target.closest('button')) return;
                
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                currentX = startX;
                currentY = startY;
                isDragging = true;
                isHorizontalSwipe = false;
                touchStartTime = Date.now();
                
                // Prevent text selection on the media
                const mediaElement = getMediaElement();
                if (mediaElement) {
                    mediaElement.style.userSelect = 'none';
                    mediaElement.style.webkitUserSelect = 'none';
                }
            };
            
            const handleTouchMove = (e) => {
                if (!isDragging || allMediaItems.length <= 1) return;
                
                const touch = e.touches[0];
                currentX = touch.clientX;
                currentY = touch.clientY;
                
                const deltaX = Math.abs(currentX - startX);
                const deltaY = Math.abs(currentY - startY);
                
                // Determine if this is a horizontal swipe (more horizontal than vertical movement)
                if (deltaX > deltaY && deltaX > 15) {
                    isHorizontalSwipe = true;
                    // Prevent scrolling and other touch behaviors
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Add visual feedback
                    const mediaElement = getMediaElement();
                    if (mediaElement) {
                        const direction = currentX > startX ? 'right' : 'left';
                        mediaElement.style.transform = `translateX(${(currentX - startX) * 0.2}px)`;
                        mediaElement.style.transition = 'none';
                    }
                }
            };
            
            const handleTouchEnd = (e) => {
                if (!isDragging) return;
                
                const touchDuration = Date.now() - touchStartTime;
                const deltaX = currentX - startX;
                const deltaY = Math.abs(currentY - startY);
                const isQuickSwipe = touchDuration < 300;
                const threshold = isQuickSwipe ? 30 : 60; // Lower threshold for quick swipes
                
                // Reset media element transform
                const mediaElement = getMediaElement();
                if (mediaElement) {
                    mediaElement.style.transform = '';
                    mediaElement.style.transition = 'transform 0.3s ease';
                    mediaElement.style.userSelect = '';
                    mediaElement.style.webkitUserSelect = '';
                    
                    // Reset transition after animation
                    setTimeout(() => {
                        if (mediaElement) {
                            mediaElement.style.transition = '';
                        }
                    }, 300);
                }
                
                // Check if this was a horizontal swipe with sufficient distance
                if (isHorizontalSwipe && allMediaItems.length > 1 && Math.abs(deltaX) > threshold) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (deltaX > 0) {
                        // Swipe right - go to previous
                        navigateMedia(-1);
                    } else {
                        // Swipe left - go to next
                        navigateMedia(1);
                    }
                }
                
                // Reset state
                isDragging = false;
                isHorizontalSwipe = false;
                touchStartTime = 0;
            };
            
            // Add touch event listeners
            modal.addEventListener('touchstart', handleTouchStart, { passive: true });
            modal.addEventListener('touchmove', handleTouchMove, { passive: false });
            modal.addEventListener('touchend', handleTouchEnd, { passive: false });
            modal.addEventListener('touchcancel', handleTouchEnd, { passive: false });
            
            // Mouse events for desktop drag
            const handleMouseDown = (e) => {
                if (allMediaItems.length <= 1 || e.target.closest('button')) return;
                
                startX = e.clientX;
                startY = e.clientY;
                currentX = startX;
                currentY = startY;
                isDragging = true;
                isHorizontalSwipe = false;
                e.preventDefault();
                
                modal.style.cursor = 'grab';
            };
            
            const handleMouseMove = (e) => {
                if (!isDragging || allMediaItems.length <= 1) return;
                
                currentX = e.clientX;
                currentY = e.clientY;
                
                const deltaX = Math.abs(currentX - startX);
                const deltaY = Math.abs(currentY - startY);
                
                // Determine if this is a horizontal drag
                if (deltaX > deltaY && deltaX > 20) {
                    isHorizontalSwipe = true;
                    modal.style.cursor = 'grabbing';
                    
                    // Add visual feedback for desktop too
                    const mediaElement = getMediaElement();
                    if (mediaElement) {
                        mediaElement.style.transform = `translateX(${(currentX - startX) * 0.1}px)`;
                        mediaElement.style.transition = 'none';
                    }
                }
            };
            
            const handleMouseUp = (e) => {
                if (!isDragging) return;
                
                const deltaX = currentX - startX;
                const threshold = 80; // Minimum drag distance for mouse
                
                // Reset media element transform
                const mediaElement = getMediaElement();
                if (mediaElement) {
                    mediaElement.style.transform = '';
                    mediaElement.style.transition = 'transform 0.3s ease';
                    setTimeout(() => {
                        if (mediaElement) {
                            mediaElement.style.transition = '';
                        }
                    }, 300);
                }
                
                if (isHorizontalSwipe && allMediaItems.length > 1 && Math.abs(deltaX) > threshold) {
                    if (deltaX > 0) {
                        // Drag right - go to previous
                        navigateMedia(-1);
                    } else {
                        // Drag left - go to next
                        navigateMedia(1);
                    }
                }
                
                isDragging = false;
                isHorizontalSwipe = false;
                modal.style.cursor = 'default';
            };
            
            // Add mouse event listeners
            modal.addEventListener('mousedown', handleMouseDown);
            modal.addEventListener('mousemove', handleMouseMove);
            modal.addEventListener('mouseup', handleMouseUp);
            modal.addEventListener('mouseleave', handleMouseUp);

            modal.onclick = (e) => {
                // Check if clicked on modal background or close button (or its child)
                if (e.target === modal || e.target.closest('.close-btn')) {
                    modal.remove();
                }
            };

            // Add click handler to the inner container to close when clicking outside the image
            const innerContainer = modal.querySelector('.media-container');
            if (innerContainer) {
                innerContainer.onclick = (e) => {
                    // If the click is on the container itself (not the image, video, or button), close modal
                    if (e.target === innerContainer) {
                        modal.remove();
                    }
                };
            }

            // Keyboard navigation
            const handleKeydown = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleKeydown);
                } else if (e.key === 'ArrowLeft' && allMediaItems.length > 1) {
                    e.preventDefault();
                    navigateMedia(-1);
                } else if (e.key === 'ArrowRight' && allMediaItems.length > 1) {
                    e.preventDefault();
                    navigateMedia(1);
                }
            };
            document.addEventListener('keydown', handleKeydown);

            document.body.appendChild(modal);
        }
        
        function handleMediaPurchase(mediaItem) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Purchase Media</h3>
                        <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                            <h4 class="font-medium text-blue-900 dark:text-blue-100 mb-2">${mediaItem.title || 'Media Item'}</h4>
                            <div class="text-sm text-blue-800 dark:text-blue-200">
                                ${mediaItem.description ? `<div class="mb-2">${mediaItem.description}</div>` : ''}
                                <div class="text-lg font-bold">${getCurrencySymbol(mediaItem.currency)}${mediaItem.price} each</div>
                            </div>
                        </div>
                        
                        ${mediaItem.quantity && mediaItem.quantity > 1 ? `
                            <div>
                                <label class="block text-sm font-medium mb-2">Quantity</label>
                                <div class="flex items-center space-x-3">
                                    <button type="button" id="decreaseQty" class="w-8 h-8 flex items-center justify-center border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <i class="fas fa-minus text-sm"></i>
                                    </button>
                                    <input type="number" id="purchaseQuantity" min="1" max="${mediaItem.quantity}" value="1" 
                                           class="w-20 px-3 py-2 text-base text-center border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <button type="button" id="increaseQty" class="w-8 h-8 flex items-center justify-center border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <i class="fas fa-plus text-sm"></i>
                                    </button>
                                    <span class="text-sm text-gray-500 dark:text-gray-400">of ${mediaItem.quantity} available</span>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium">Total:</span>
                                    <span id="totalPrice" class="text-lg font-bold">${getCurrencySymbol(mediaItem.currency)}${mediaItem.price}</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                            <div class="text-sm font-medium mb-1">Payment Instructions:</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Contact the creator for payment details and to complete your purchase.</div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button class="confirm-btn px-4 py-2 bg-green-600 text-white hover:bg-green-700 rounded">
                                <i class="fas fa-shopping-cart mr-2"></i>Purchase
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Set up quantity controls if multiple items available
            if (mediaItem.quantity && mediaItem.quantity > 1) {
                const quantityInput = modal.querySelector('#purchaseQuantity');
                const decreaseBtn = modal.querySelector('#decreaseQty');
                const increaseBtn = modal.querySelector('#increaseQty');
                const totalPriceSpan = modal.querySelector('#totalPrice');
                
                const updateTotal = () => {
                    const quantity = parseInt(quantityInput.value) || 1;
                    const total = (mediaItem.price * quantity).toFixed(2);
                    totalPriceSpan.textContent = `${getCurrencySymbol(mediaItem.currency)}${total}`;
                };
                
                decreaseBtn.onclick = () => {
                    const current = parseInt(quantityInput.value) || 1;
                    if (current > 1) {
                        quantityInput.value = current - 1;
                        updateTotal();
                    }
                };
                
                increaseBtn.onclick = () => {
                    const current = parseInt(quantityInput.value) || 1;
                    if (current < mediaItem.quantity) {
                        quantityInput.value = current + 1;
                        updateTotal();
                    }
                };
                
                quantityInput.oninput = () => {
                    let value = parseInt(quantityInput.value) || 1;
                    if (value < 1) value = 1;
                    if (value > mediaItem.quantity) value = mediaItem.quantity;
                    quantityInput.value = value;
                    updateTotal();
                };
            }
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.querySelector('.confirm-btn').onclick = () => {
                const quantity = mediaItem.quantity && mediaItem.quantity > 1 ? 
                    parseInt(modal.querySelector('#purchaseQuantity')?.value || 1) : 1;
                const total = (mediaItem.price * quantity).toFixed(2);
                
                modal.remove();
                showNotification(`Purchase request sent for ${quantity}x "${mediaItem.title || 'media item'}" (${getCurrencySymbol(mediaItem.currency)}${total})!`, 'success');
            };
            
            document.body.appendChild(modal);
        }

        function renderObjectsGallery(note) {
            const gallery = document.getElementById('viewObjectsGallery');
            const grid = document.getElementById('viewObjectsGrid');

            if (!note.objects || note.objects.length === 0) {
                gallery.classList.add('hidden');
                return;
            }

            gallery.classList.remove('hidden');
            
            grid.innerHTML = note.objects.map(item => {
                const hasPrice = item.price && item.price > 0;
                const priceText = hasPrice ? `${getCurrencySymbol(item.currency)}${item.price}` : '';
                const descriptionSnippet = item.description ? 
                    (item.description.length > 50 ? item.description.substring(0, 50) + '...' : item.description) : '';
                
                return `
                    <div class="relative cursor-pointer flex-shrink-0 w-48 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-3 hover:shadow-lg transition-all duration-200" onclick="showObjectDetailModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                        ${item.image ? 
                            `<img src="${item.image}" alt="${item.title}" class="w-full h-32 object-cover rounded-lg mb-3">` :
                            `<div class="w-full h-32 bg-gray-200 dark:bg-gray-600 rounded-lg mb-3 flex items-center justify-center">
                                <i class="fas fa-cube text-gray-400 text-2xl"></i>
                            </div>`
                        }
                        <div class="space-y-1">
                            <h4 class="font-medium text-gray-900 dark:text-white text-sm line-clamp-2">${item.title}</h4>
                            ${descriptionSnippet ? `<p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2">${descriptionSnippet}</p>` : ''}
                            ${priceText ? `<div class="text-sm text-green-600 dark:text-green-400 font-medium">${priceText}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showObjectDetailModal(objectData) {
            const hasPrice = objectData.price && objectData.price > 0;
            const priceText = hasPrice ? `${getCurrencySymbol(objectData.currency)}${objectData.price}` : '';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] flex flex-col">
                    <div class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-start">
                            <h2 class="text-xl font-semibold pr-4">${objectData.title}</h2>
                            <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-6">
                        ${objectData.image ? 
                            `<div class="mb-4">
                                <img src="${objectData.image}" alt="${objectData.title}" class="w-full h-64 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity" onclick="showMediaModal('${objectData.image}', 'image')">
                            </div>` : 
                            `<div class="mb-4">
                                <div class="w-full h-64 bg-gray-200 dark:bg-gray-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-cube text-gray-400 text-4xl"></i>
                                </div>
                            </div>`
                        }
                        
                        ${priceText ? 
                            `<div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="text-lg font-semibold text-green-600 dark:text-green-400">${priceText}</div>
                            </div>` : ''
                        }
                        
                        ${objectData.description ? 
                            `<div class="prose dark:prose-invert max-w-none">
                                <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Description</h3>
                                <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${objectData.description}</p>
                            </div>` : 
                            '<p class="text-gray-500 dark:text-gray-400 italic">No description provided</p>'
                        }
                    </div>
                    
                    <div class="flex-shrink-0 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-750">
                        <button class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" onclick="this.closest('.fixed').remove();">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        function clearNoteMedia() {
            currentNoteMedia = [];
            updateMediaPreview();
        }

        // Objects management functions
        function addObjectToNote(objectData) {
            const objectItem = {
                id: Date.now() + Math.random(),
                ...objectData,
                createdAt: new Date()
            };
            currentNoteObjects.push(objectItem);
            updateObjectsPreview();
            return objectItem;
        }

        function removeObjectFromNote(objectId) {
            currentNoteObjects = currentNoteObjects.filter(item => item.id !== objectId);
            updateObjectsPreview();
        }

        function updateObjectsPreview() {
            const preview = document.getElementById('objectsPreview');
            const grid = document.getElementById('objectsPreviewGrid');

            if (currentNoteObjects.length === 0) {
                preview.classList.add('hidden');
                return;
            }

            preview.classList.remove('hidden');
            grid.innerHTML = currentNoteObjects.map(item => {
                const hasPrice = item.price && item.price > 0;
                const priceText = hasPrice ? `${getCurrencySymbol(item.currency)}${item.price}` : '';
                
                return `
                    <div class="relative group flex-shrink-0 w-24">
                        <div class="bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-lg p-2">
                            ${item.image ? 
                                `<img src="${item.image}" alt="${item.title}" class="w-full h-16 object-cover rounded mb-2">` :
                                `<div class="w-full h-16 bg-gray-200 dark:bg-gray-500 rounded mb-2 flex items-center justify-center">
                                    <i class="fas fa-cube text-gray-400 text-lg"></i>
                                </div>`
                            }
                            <div class="text-xs font-medium text-gray-900 dark:text-white truncate" title="${item.title}">${item.title}</div>
                            ${priceText ? `<div class="text-xs text-green-600 dark:text-green-400 font-medium">${priceText}</div>` : ''}
                        </div>
                        <button type="button" class="object-remove-btn absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center" data-object-id="${item.id}">
                            <i class="fas fa-times" style="font-size: 8px;"></i>
                        </button>
                        <button type="button" class="object-edit-btn absolute bottom-1 right-1 w-4 h-4 bg-primary text-white rounded-full text-xs hover:bg-primary/90 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center" data-object-id="${item.id}">
                            <i class="fas fa-edit" style="font-size: 6px;"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            // Add event listeners to remove and edit buttons
            grid.querySelectorAll('.object-remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const objectId = parseFloat(btn.dataset.objectId);
                    removeObjectFromNote(objectId);
                });
            });

            grid.querySelectorAll('.object-edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const objectId = parseFloat(btn.dataset.objectId);
                    const objectItem = currentNoteObjects.find(obj => obj.id === objectId);
                    if (objectItem) {
                        showObjectModal(objectItem);
                    }
                });
            });
        }

        function clearNoteObjects() {
            currentNoteObjects = [];
            updateObjectsPreview();
        }

        function getCurrencySymbol(currency) {
            const symbols = {
                'USD': '$',
                'EUR': '‚Ç¨',
                'GBP': '¬£',
                'JPY': '¬•',
                'CAD': 'C$',
                'AUD': 'A$',
                'CHF': 'Fr',
                'CNY': '¬•',
                'KRW': '‚Ç©',
                'INR': '‚Çπ',
                'BRL': 'R$',
                'MXN': '$',
                'RUB': '‚ÇΩ',
                'ZAR': 'R',
                'SEK': 'kr',
                'NOK': 'kr',
                'DKK': 'kr',
                'PLN': 'z≈Ç',
                'CZK': 'Kƒç',
                'HUF': 'Ft',
                'TRY': '‚Ç∫',
                'ILS': '‚Ç™',
                'AED': 'ÿØ.ÿ•',
                'SAR': 'Ô∑º',
                'THB': '‡∏ø',
                'SGD': 'S$',
                'MYR': 'RM',
                'IDR': 'Rp',
                'PHP': '‚Ç±',
                'VND': '‚Ç´',
                'NZD': 'NZ$',
                'HKD': 'HK$',
                'TWD': 'NT$'
            };
            return symbols[currency] || currency + ' ';
        }

        function showObjectModal(existingObject = null) {
            const isEditing = !!existingObject;
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">${isEditing ? 'Edit Object' : 'Add Object'}</h3>
                            <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form class="space-y-4">
                            <!-- Object Image -->
                            <div>
                                <label class="block text-sm font-medium mb-2 text-center">Image</label>
                                <div class="flex flex-col items-center space-y-3">
                                    <div id="objectImagePreview" class="w-48 h-36 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg flex items-center justify-center ${existingObject?.image ? 'bg-white dark:bg-gray-700' : 'bg-gray-50 dark:bg-gray-700'}">
                                        ${existingObject?.image ? 
                                            `<img src="${existingObject.image}" class="w-full h-full object-cover rounded-lg" alt="Object">` :
                                            '<i class="fas fa-camera text-gray-400 text-2xl"></i>'
                                        }
                                    </div>
                                    <div class="flex space-x-2">
                                        <label for="objectImageUpload" class="px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                            <i class="fas fa-upload mr-2"></i>Choose Image
                                        </label>
                                        <input type="file" id="objectImageUpload" class="hidden" accept="image/*">
                                        ${existingObject?.image ? 
                                            '<button type="button" id="removeObjectImage" class="px-4 py-2 text-sm text-red-500 hover:text-red-700 border border-red-300 dark:border-red-600 rounded-lg transition-colors">Remove Image</button>' : 
                                            ''
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Title -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Title <span class="text-red-500">*</span></label>
                                <input type="text" id="objectTitle" required value="${existingObject?.title || ''}" 
                                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                       placeholder="e.g., Vintage Camera">
                            </div>
                            
                            <!-- Description -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Description</label>
                                <textarea id="objectDescription" rows="3" 
                                          class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                          placeholder="Describe the object...">${existingObject?.description || ''}</textarea>
                            </div>
                            
                            <!-- Price (Optional) -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Price <span class="text-gray-500 text-xs">(Optional)</span></label>
                                <div class="grid grid-cols-3 gap-2">
                                    <select id="objectCurrency" class="px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="USD">üá∫üá∏ USD</option>
                                        <option value="EUR">üá™üá∫ EUR</option>
                                        <option value="GBP">üá¨üáß GBP</option>
                                        <option value="JPY">üáØüáµ JPY</option>
                                        <option value="CAD">üá®üá¶ CAD</option>
                                        <option value="AUD">üá¶üá∫ AUD</option>
                                        <option value="CHF">üá®üá≠ CHF</option>
                                        <option value="CNY">üá®üá≥ CNY</option>
                                        <option value="KRW">üá∞üá∑ KRW</option>
                                        <option value="INR">üáÆüá≥ INR</option>
                                        <option value="BRL">üáßüá∑ BRL</option>
                                        <option value="MXN">üá≤üáΩ MXN</option>
                                        <option value="RUB">üá∑üá∫ RUB</option>
                                        <option value="ZAR">üáøüá¶ ZAR</option>
                                        <option value="SEK">üá∏üá™ SEK</option>
                                        <option value="NOK">üá≥üá¥ NOK</option>
                                        <option value="DKK">üá©üá∞ DKK</option>
                                        <option value="PLN">üáµüá± PLN</option>
                                        <option value="CZK">üá®üáø CZK</option>
                                        <option value="HUF">üá≠üá∫ HUF</option>
                                        <option value="TRY">üáπüá∑ TRY</option>
                                        <option value="ILS">üáÆüá± ILS</option>
                                        <option value="AED">üá¶üá™ AED</option>
                                        <option value="SAR">üá∏üá¶ SAR</option>
                                        <option value="THB">üáπüá≠ THB</option>
                                        <option value="SGD">üá∏üá¨ SGD</option>
                                        <option value="MYR">üá≤üáæ MYR</option>
                                        <option value="IDR">üáÆüá© IDR</option>
                                        <option value="PHP">üáµüá≠ PHP</option>
                                        <option value="VND">üáªüá≥ VND</option>
                                        <option value="NZD">üá≥üáø NZD</option>
                                        <option value="HKD">üá≠üá∞ HKD</option>
                                        <option value="TWD">üáπüáº TWD</option>
                                    </select>
                                    <input type="number" id="objectPrice" step="0.01" min="0" value="${existingObject?.price || ''}" 
                                           class="col-span-2 px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                           placeholder="0.00">
                                </div>
                            </div>
                        </form>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">Cancel</button>
                            <button class="save-btn px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded transition-colors">
                                <i class="fas fa-save mr-2"></i>${isEditing ? 'Update' : 'Add'} Object
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Set default currency to last used
            modal.querySelector('#objectCurrency').value = existingObject?.currency || lastUsedCurrency;
            
            let selectedImage = existingObject?.image || null;
            
            // Image upload handler
            modal.querySelector('#objectImageUpload').addEventListener('change', async (e) => {
                if (e.target.files[0]) {
                    const file = e.target.files[0];
                    if (file.type.startsWith('image/')) {
                        const dataUrl = await createImageDataUrl(file);
                        selectedImage = dataUrl;
                        const preview = modal.querySelector('#objectImagePreview');
                        preview.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover rounded-lg" alt="Object">`;
                        preview.className = preview.className.replace('bg-gray-50 dark:bg-gray-700', 'bg-white dark:bg-gray-700');
                        
                        // Add remove button if it doesn't exist
                        const removeBtn = modal.querySelector('#removeObjectImage');
                        if (!removeBtn) {
                            const removeButton = document.createElement('button');
                            removeButton.type = 'button';
                            removeButton.id = 'removeObjectImage';
                            removeButton.className = 'block w-full mt-2 px-3 py-1 text-xs text-red-500 hover:text-red-700 transition-colors';
                            removeButton.textContent = 'Remove Image';
                            removeButton.onclick = () => {
                                selectedImage = null;
                                preview.innerHTML = '<i class="fas fa-camera text-gray-400 text-lg"></i>';
                                preview.className = preview.className.replace('bg-white dark:bg-gray-700', 'bg-gray-50 dark:bg-gray-700');
                                removeButton.remove();
                            };
                            modal.querySelector('#objectImageUpload').parentElement.appendChild(removeButton);
                        }
                    }
                }
            });
            
            // Remove image handler (if editing)
            const removeImageBtn = modal.querySelector('#removeObjectImage');
            if (removeImageBtn) {
                removeImageBtn.onclick = () => {
                    selectedImage = null;
                    const preview = modal.querySelector('#objectImagePreview');
                    preview.innerHTML = '<i class="fas fa-camera text-gray-400 text-lg"></i>';
                    preview.className = preview.className.replace('bg-white dark:bg-gray-700', 'bg-gray-50 dark:bg-gray-700');
                    removeImageBtn.remove();
                };
            }
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.querySelector('.save-btn').onclick = () => {
                const title = modal.querySelector('#objectTitle').value.trim();
                const description = modal.querySelector('#objectDescription').value.trim();
                const currency = modal.querySelector('#objectCurrency').value;
                const price = parseFloat(modal.querySelector('#objectPrice').value) || 0;
                
                if (!title) {
                    showAlert('Please enter a title for the object');
                    return;
                }
                
                // Remember last used currency
                lastUsedCurrency = currency;
                
                const objectData = {
                    title,
                    description,
                    currency,
                    price,
                    image: selectedImage
                };
                
                if (isEditing) {
                    // Update existing object
                    const objectIndex = currentNoteObjects.findIndex(obj => obj.id === existingObject.id);
                    if (objectIndex !== -1) {
                        currentNoteObjects[objectIndex] = { ...existingObject, ...objectData };
                        updateObjectsPreview();
                    }
                } else {
                    // Add new object
                    addObjectToNote(objectData);
                }
                
                modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        function clearNoteForm() {
            // Clear form fields
            document.getElementById('noteForm').reset();
            
            // Reset privacy toggle state
            privacyEnabled = false;
            updatePrivacyToggle();
            
            // Reset event toggle state and clear event data
            eventEnabled = false;
            updateEventToggle();
            clearEventData();
            
            // Reset payment toggle state and clear payment data
            paymentEnabled = false;
            updatePaymentToggle();
            clearPaymentData();
            
            // Reset pin style
            selectedPinStyle = { type: 'emoji', value: 'üìç' };
            document.getElementById('selectedEmojiDisplay').textContent = 'üìç';
            document.getElementById('customPinPreview').classList.add('hidden');
            
            // Clear media and objects
            clearNoteMedia();
            clearNoteObjects();
            
            // Reset template selector
            document.getElementById('templateSelector').value = '';
            
            // Clear current note tracking
            currentNoteId = null;
            currentNoteLat = null;
            currentNoteLng = null;
        }

        // Note management
        function createNote(lat, lng, title, content, tags, pinStyle, privacy) {
            if (!currentUser) return null;

            // Collect event data if event section is open
            const eventData = collectEventData();
            
            // Collect payment data if payment section is open
            const paymentData = collectPaymentData();

            const note = {
                id: Date.now() + Math.random(),
                lat,
                lng,
                title,
                authorId: currentUser.id,
                author: currentUser.username,
                content,
                tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                pinStyle,
                privacy: privacy || 'public', // Default to public if not specified
                media: [...currentNoteMedia], // Copy current media
                event: eventData,
                payment: paymentData,
                rsvps: [], // Array to store RSVPs
                comments: [],
                createdAt: new Date()
            };
            
            notes.push(note);
            addNoteToMap(note, true); // Mark as new note for glow effect
            updateNoteCount();
            clearNoteMedia(); // Clear media after saving
            return note;
        }

        function collectEventData() {
            console.log('=== COLLECT EVENT DATA DEBUG ===');
            console.log('eventEnabled variable:', eventEnabled);
            console.log('Event toggle button classes:', document.getElementById('eventToggleBtn').className);
            console.log('Event toggle icon classes:', document.getElementById('eventToggleIcon').className);
            
            // Check if event toggle is enabled
            if (!eventEnabled) {
                console.log('Event toggle disabled, returning null');
                return null; // No event data if toggle is disabled
            }
            
            const startDateElement = document.getElementById('eventStartDate');
            const startTimeElement = document.getElementById('eventStartTime');
            const endDateElement = document.getElementById('eventEndDate');
            const endTimeElement = document.getElementById('eventEndTime');
            const rsvpListVisibleElement = document.getElementById('rsvpListVisible');
            
            console.log('Event form elements found:', {
                startDate: !!startDateElement,
                startTime: !!startTimeElement,
                rsvpListVisible: !!rsvpListVisibleElement
            });
            
            if (!startDateElement || !startTimeElement || !rsvpListVisibleElement) {
                console.log('Missing event form elements');
                return null; // Elements don't exist
            }
            
            const startDate = startDateElement.value;
            const startTime = startTimeElement.value;
            const endDate = endDateElement ? endDateElement.value : '';
            const endTime = endTimeElement ? endTimeElement.value : '';
            // For hidden input, use .value instead of .checked
            const rsvpListVisible = rsvpListVisibleElement.value === 'true';
            
            console.log('Event data values:', {
                startDate,
                startTime,
                endDate,
                endTime,
                rsvpListVisible: rsvpListVisibleElement.value,
                rsvpListVisibleParsed: rsvpListVisible
            });
            
            if (!startDate || !startTime) {
                console.log('Missing required event data (start date/time)');
                return null; // No event data if start date/time not provided
            }
            
            const eventData = {
                startDate,
                startTime,
                rsvpListVisible
            };
            
            if (endDate && endTime) {
                eventData.endDate = endDate;
                eventData.endTime = endTime;
            }
            
            console.log('Collected event data:', eventData);
            return eventData;
        }
        
        function collectPaymentData() {
            console.log('=== COLLECT PAYMENT DATA DEBUG ===');
            console.log('paymentEnabled variable:', paymentEnabled);
            console.log('Payment toggle button classes:', document.getElementById('paymentToggleBtn').className);
            console.log('Payment toggle icon classes:', document.getElementById('paymentToggleIcon').className);
            
            // Check if payment toggle is enabled
            if (!paymentEnabled) {
                console.log('Payment toggle disabled, returning null');
                return null; // No payment data if toggle is disabled
            }
            
            const paymentTypeElement = document.getElementById('paymentType');
            const paymentDetailsElement = document.getElementById('paymentDetails');
            
            console.log('Payment form elements found:', {
                paymentType: !!paymentTypeElement,
                paymentDetails: !!paymentDetailsElement
            });
            
            if (!paymentTypeElement || !paymentDetailsElement) {
                console.log('Missing payment form elements');
                return null; // Elements don't exist, return null
            }
            
            const paymentType = paymentTypeElement.value;
            const paymentDetails = paymentDetailsElement.value.trim();
            
            console.log('Payment data values:', {
                paymentType,
                paymentDetails
            });
            
            if (paymentType === 'free') {
                const paymentData = {
                    type: 'free',
                    details: paymentDetails
                };
                console.log('Collected free payment data:', paymentData);
                return paymentData;
            }
            
            const paymentData = {
                type: paymentType,
                details: paymentDetails
            };
            
            if (paymentType === 'ticket-price') {
                const ticketPriceElement = document.getElementById('ticketPrice');
                const ticketQuantityElement = document.getElementById('ticketQuantityAlt');
                
                const ticketPrice = ticketPriceElement ? parseFloat(ticketPriceElement.value) || 0 : 0;
                const ticketQuantity = ticketQuantityElement ? parseInt(ticketQuantityElement.value) || 0 : 0;
                
                paymentData.ticketPrice = ticketPrice;
                paymentData.availableTickets = ticketQuantity;
                
                console.log('Collected ticket-price payment data:', paymentData);
            } else if (paymentType === 'crowdfund') {
                const goalElement = document.getElementById('crowdfundGoal');
                const raisedElement = document.getElementById('crowdfundRaised');
                
                const goal = goalElement ? parseFloat(goalElement.value) || 0 : 0;
                const raised = raisedElement ? parseFloat(raisedElement.value) || 0 : 0;
                
                paymentData.goal = goal;
                paymentData.raised = raised;
                
                console.log('Collected crowdfund payment data:', paymentData);
            } else if (paymentType === 'donation' || paymentType === 'payment') {
                const amountElement = document.getElementById('paymentAmount');
                const amount = amountElement ? parseFloat(amountElement.value) || 0 : 0;
                paymentData.amount = amount;
                
                console.log('Collected donation/payment data:', paymentData);
            }
            
            console.log('Final collected payment data:', paymentData);
            return paymentData;
        }

        function updateNote(id, title, content, tags, pinStyle, privacy) {
            const noteIndex = notes.findIndex(note => note.id === id);
            if (noteIndex !== -1 && canEditNote(notes[noteIndex])) {
                removeNoteFromMap(id);
                
                // Collect event and payment data (these can be null if toggles are disabled)
                const eventData = collectEventData();
                const paymentData = collectPaymentData();
                
                console.log('=== UPDATE NOTE DEBUG ===');
                console.log('Collected event data during update:', eventData);
                console.log('Collected payment data during update:', paymentData);
                console.log('eventEnabled during update:', eventEnabled);
                console.log('paymentEnabled during update:', paymentEnabled);
                
                notes[noteIndex] = {
                    ...notes[noteIndex],
                    title,
                    content,
                    tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                    pinStyle,
                    privacy: privacy || notes[noteIndex].privacy || 'public', // Keep existing privacy if not specified
                    media: [...currentNoteMedia], // Update media
                    event: eventData, // Update event data (null if event toggle is off)
                    payment: paymentData, // Update payment data (null if payment toggle is off)
                    updatedAt: new Date()
                };
                
                console.log('Updated note payment field:', notes[noteIndex].payment);
                
                addNoteToMap(notes[noteIndex]);
                updateNoteCount();
                clearNoteMedia(); // Clear media after saving
                return notes[noteIndex];
            }
            return null;
        }

        function deleteNote(id) {
            const note = notes.find(n => n.id === id);
            if (note && canEditNote(note)) {
                notes = notes.filter(note => note.id !== id);
                refreshMap();
                updateNoteCount();
                return true;
            }
            return false;
        }

        function createCustomPinIcon(pinStyle, size = 30) {
            let pinContent;
            
            if (pinStyle.type === 'custom' && pinStyle.value.startsWith('data:image/')) {
                // Custom image pin
                pinContent = `<img src="${pinStyle.value}" style="width: ${size * 0.8}px; height: ${size * 0.8}px; border-radius: 50%; object-fit: cover;" alt="Custom pin">`;
            } else {
                // Emoji pin (fallback for any other type)
                pinContent = `<span style="font-size: ${size * 0.6}px;">${pinStyle.value}</span>`;
            }
            
            return L.divIcon({
                className: 'custom-pin',
                html: `<div style="width: ${size}px; height: ${size}px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); background: white; display: flex; align-items: center; justify-content: center; position: relative;">
                        ${pinContent}
                        <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 8px solid white; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));"></div>
                       </div>`,
                iconSize: [size, size + 8],
                iconAnchor: [size/2, size + 8]
            });
        }

        function addNoteToMap(note, isNewNote = false) {
            const icon = createCustomPinIcon(note.pinStyle);
            const marker = L.marker([note.lat, note.lng], { icon: icon }).addTo(map);

            marker.on('click', (e) => {
                // Get the marker's screen position for animation
                const markerElement = marker.getElement();
                let animationOrigin = null;
                
                if (markerElement) {
                    const rect = markerElement.getBoundingClientRect();
                    animationOrigin = {
                        x: rect.left + rect.width / 2,
                        y: rect.top + rect.height / 2
                    };
                }
                
                // Highlight this pin when viewing its note
                highlightPin(marker);
                showViewModal(note, animationOrigin);
            });
            marker.noteId = note.id;
            
            if (!mapMarkers) mapMarkers = [];
            mapMarkers.push(marker);
            
            // Add glow effect for new notes that the user can see
            if (isNewNote) {
                // Wait for marker to be rendered, then add effects
                setTimeout(() => {
                    const markerElement = marker.getElement();
                    if (markerElement) {
                        // Add both glow and pulse effects
                        markerElement.classList.add('new-note-glow');
                        markerElement.classList.add('new-note-pulse');
                        
                        // Remove the pulse effect after 3 seconds (3 pulses)
                        setTimeout(() => {
                            if (markerElement) {
                                markerElement.classList.remove('new-note-pulse');
                            }
                        }, 3000);
                        
                        // Remove the glow effect after the animation completes
                        setTimeout(() => {
                            if (markerElement) {
                                markerElement.classList.remove('new-note-glow');
                            }
                        }, 3000);
                    }
                }, 100);
            }
        }

        function removeNoteFromMap(noteId) {
            if (!mapMarkers) return;
            const markerIndex = mapMarkers.findIndex(m => m.noteId === noteId);
            if (markerIndex !== -1) {
                const marker = mapMarkers[markerIndex];
                map.removeLayer(marker);
                mapMarkers.splice(markerIndex, 1);
            }
        }

        function highlightPin(marker) {
            // Clear any previously highlighted pin
            if (highlightedMarker) {
                // Reset to normal style  
                const prevElement = highlightedMarker.getElement();
                if (prevElement) {
                    prevElement.style.filter = '';
                }
            }
            
            // Highlight the new pin
            highlightedMarker = marker;
            const element = marker.getElement();
            if (element) {
                element.style.filter = 'drop-shadow(0 0 10px #5D5CDE) drop-shadow(0 0 20px #5D5CDE)';
            }
        }
        
        function clearPinHighlight() {
            if (highlightedMarker) {
                const element = highlightedMarker.getElement();
                if (element) {
                    element.style.filter = '';
                }
                highlightedMarker = null;
            }
        }

        function refreshMap() {
            if (mapMarkers) {
                mapMarkers.forEach(marker => map.removeLayer(marker));
                mapMarkers = [];
            }
            notes.filter(note => canViewNote(note)).forEach(note => addNoteToMap(note));
        }

        function refreshMapWithNewNoteDetection(lastLoginTime) {
            if (mapMarkers) {
                mapMarkers.forEach(marker => map.removeLayer(marker));
                mapMarkers = [];
            }
            
            let newNotesCount = 0;
            notes.filter(note => canViewNote(note)).forEach(note => {
                // Check if this note was created after the user's last login
                const isNewNote = note.createdAt > lastLoginTime && note.authorId !== currentUser.id;
                addNoteToMap(note, isNewNote);
                if (isNewNote) {
                    newNotesCount++;
                }
            });
            
            // New notes will show with glow effect on the pins themselves
        }

        function updateNoteCount() {
            document.getElementById('noteCount').textContent = notes.length;
        }

        // Search and filtering functions
        function searchNotes(query) {
            if (!query.trim()) {
                return notes;
            }
            
            const searchTerm = query.toLowerCase();
            return notes.filter(note => {
                return (
                    note.title.toLowerCase().includes(searchTerm) ||
                    note.content.toLowerCase().includes(searchTerm) ||
                    note.author.toLowerCase().includes(searchTerm) ||
                    note.tags.some(tag => tag.toLowerCase().includes(searchTerm))
                );
            });
        }

        function filterByAuthor(authorName) {
            if (!authorName) {
                return notes;
            }
            return notes.filter(note => note.author === authorName);
        }

        function filterByTag(tagName) {
            if (!tagName) {
                return notes;
            }
            return notes.filter(note => note.tags.includes(tagName));
        }

        function applyFilters() {
            let filtered = [...notes];
            
            // Apply search filter
            if (activeFilters.search) {
                filtered = searchNotes(activeFilters.search);
            }
            
            // Apply author filter
            if (activeFilters.author) {
                filtered = filtered.filter(note => note.author === activeFilters.author);
            }
            
            // Apply tag filter
            if (activeFilters.tag) {
                filtered = filtered.filter(note => note.tags.includes(activeFilters.tag));
            }
            
            filteredNotes = filtered;
            updateMapDisplay();
            updateFilterIndicators();
        }

        function updateMapDisplay() {
            // Clear existing markers
            if (mapMarkers) {
                mapMarkers.forEach(marker => map.removeLayer(marker));
                mapMarkers = [];
            }
            
            // Add markers for filtered notes that respect privacy settings
            const notesToShow = filteredNotes.length > 0 || hasActiveFilters() ? filteredNotes : notes;
            notesToShow.filter(note => canViewNote(note)).forEach(note => addNoteToMap(note));
        }

        function hasActiveFilters() {
            return activeFilters.search || activeFilters.author || activeFilters.tag;
        }

        function updateFilterIndicators() {
            const searchInput = document.getElementById('searchInput');
            
            // Update search input styling if there are active filters
            if (hasActiveFilters()) {
                searchInput.classList.add('ring-2', 'ring-primary');
                
                // Show filter count
                const totalFiltered = filteredNotes.length;
                const totalNotes = notes.length;
                
                if (totalFiltered < totalNotes) {
                    showFilterStatus(`Showing ${totalFiltered} of ${totalNotes} notes`);
                }
            } else {
                searchInput.classList.remove('ring-2', 'ring-primary');
                clearFilterStatus();
            }
        }

        function showFilterStatus(message) {
            let statusDiv = document.getElementById('filterStatus');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'filterStatus';
                statusDiv.className = 'absolute top-20 left-4 bg-primary text-white px-3 py-2 rounded-lg shadow-lg text-sm z-[1000] flex items-center space-x-2';
                
                statusDiv.innerHTML = `
                    <span id="filterStatusText">${message}</span>
                    <button id="clearFiltersBtn" class="text-white hover:text-gray-200 font-medium" title="Clear all filters">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                document.body.appendChild(statusDiv);
                
                // Clear filters button
                document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);
            } else {
                document.getElementById('filterStatusText').textContent = message;
                statusDiv.classList.remove('hidden');
            }
        }

        function clearFilterStatus() {
            const statusDiv = document.getElementById('filterStatus');
            if (statusDiv) {
                statusDiv.classList.add('hidden');
            }
        }

        function clearAllFilters() {
            activeFilters.search = '';
            activeFilters.author = '';
            activeFilters.tag = '';
            
            // Clear search input
            document.getElementById('searchInput').value = '';
            
            // Reapply filters (which will show all notes)
            applyFilters();
        }

        function setAuthorFilter(authorName) {
            activeFilters.author = authorName;
            activeFilters.tag = ''; // Clear tag filter when setting author filter
            document.getElementById('searchInput').value = `by:${authorName}`;
            applyFilters();
        }

        function setTagFilter(tagName) {
            activeFilters.tag = tagName;
            activeFilters.author = ''; // Clear author filter when setting tag filter
            document.getElementById('searchInput').value = `#${tagName}`;
            applyFilters();
        }

        // Privacy field initialization
        function initializePrivacyField() {
            if (!document.getElementById('notePrivacy')) {
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.id = 'notePrivacy';
                hiddenField.value = 'public';
                document.getElementById('noteForm').appendChild(hiddenField);
            }
        }

        // Modal functions
        function showAuthModal(isRegister = false) {
            const title = document.getElementById('authTitle');
            const emailField = document.getElementById('authEmailField');
            const switchBtn = document.getElementById('authSwitchBtn');
            const submitBtn = document.getElementById('authSubmitBtn');
            
            if (isRegister) {
                title.textContent = 'Register';
                emailField.classList.remove('hidden');
                emailField.querySelector('input').required = true;
                switchBtn.textContent = 'Already have an account? Login';
                submitBtn.textContent = 'Register';
            } else {
                title.textContent = 'Login';
                emailField.classList.add('hidden');
                emailField.querySelector('input').required = false;
                switchBtn.textContent = 'Need an account? Register';
                submitBtn.textContent = 'Login';
            }
            
            document.getElementById('authForm').dataset.mode = isRegister ? 'register' : 'login';
            document.getElementById('authModal').classList.remove('hidden');
        }

        function showNoteModal(lat, lng, noteToEdit = null) {
            console.log('=== SHOW NOTE MODAL DEBUG ===');
            console.log('Called with:', { lat, lng, noteToEdit: !!noteToEdit });
            console.log('currentUser:', !!currentUser);
            
            if (!currentUser && !noteToEdit) {
                showAlert('Please login to create notes');
                return;
            }
            
            if (!currentUser && noteToEdit) {
                showViewModal(noteToEdit);
                return;
            }

            currentNoteId = noteToEdit ? noteToEdit.id : null;
            currentNoteLat = lat;
            currentNoteLng = lng;
            
            document.getElementById('modalTitle').textContent = noteToEdit ? 'Edit Note' : 'New Note';
            document.getElementById('deleteNoteBtn').classList.toggle('hidden', !noteToEdit);
            
            if (noteToEdit) {
                try {
                    // Basic form fields
                    document.getElementById('noteTitle').value = noteToEdit.title || '';
                    document.getElementById('noteContent').value = noteToEdit.content || '';
                    
                    // Ensure privacy field exists before setting value
                    initializePrivacyField();
                    document.getElementById('notePrivacy').value = noteToEdit.privacy || 'public';
                    
                    // Pin style
                    selectedPinStyle = noteToEdit.pinStyle || { type: 'emoji', value: 'üìç' };
                    
                    // Load existing media for editing
                    currentNoteMedia = noteToEdit.media ? [...noteToEdit.media] : [];
                    updateMediaPreview();
                    
                    // Restore privacy toggle state
                    privacyEnabled = noteToEdit.privacy && noteToEdit.privacy !== 'public';
                    updatePrivacyToggle();
                    
                    // Load event data if available
                    if (noteToEdit.event && noteToEdit.event.startDate && noteToEdit.event.startTime) {
                        eventEnabled = true;
                        try {
                            document.getElementById('eventStartDate').value = noteToEdit.event.startDate;
                            document.getElementById('eventStartTime').value = noteToEdit.event.startTime;
                            document.getElementById('eventEndDate').value = noteToEdit.event.endDate || '';
                            document.getElementById('eventEndTime').value = noteToEdit.event.endTime || '';
                            document.getElementById('rsvpListVisible').value = noteToEdit.event.rsvpListVisible ? 'true' : 'false';
                        } catch (eventError) {
                            console.log('Error loading event data:', eventError);
                        }
                    } else {
                        eventEnabled = false;
                    }
                    updateEventToggle();
                    
                    // Load payment data
                    if (noteToEdit.payment) {
                        paymentEnabled = true;
                        try {
                            document.getElementById('paymentType').value = noteToEdit.payment.type || 'free';
                            document.getElementById('paymentDetails').value = noteToEdit.payment.details || '';
                            
                            if (noteToEdit.payment.type === 'ticket-price') {
                                document.getElementById('ticketPrice').value = noteToEdit.payment.ticketPrice || '';
                                document.getElementById('ticketQuantityAlt').value = noteToEdit.payment.availableTickets || '';
                            } else if (noteToEdit.payment.type === 'donation' || noteToEdit.payment.type === 'payment') {
                                document.getElementById('paymentAmount').value = noteToEdit.payment.amount || '';
                            } else if (noteToEdit.payment.type === 'crowdfund') {
                                document.getElementById('crowdfundGoal').value = noteToEdit.payment.goal || '';
                                document.getElementById('crowdfundRaised').value = noteToEdit.payment.raised || '0';
                            }
                            
                            // Update payment toggle text
                            const paymentTypeOptions = {
                                'free': 'Payment',
                                'donation': 'Donation', 
                                'ticket-price': 'Ticket Price',
                                'crowdfund': 'Crowdfund',
                                'payment': 'Payment'
                            };
                            document.getElementById('paymentToggleText').textContent = paymentTypeOptions[noteToEdit.payment.type] || 'Payment';
                        } catch (paymentError) {
                            console.log('Error loading payment data:', paymentError);
                        }
                    } else {
                        paymentEnabled = false;
                        document.getElementById('paymentType').value = 'free';
                        document.getElementById('paymentDetails').value = '';
                        document.getElementById('paymentToggleText').textContent = 'Payment';
                    }
                    updatePaymentToggle();
                    
                } catch (error) {
                    console.error('Error populating edit form:', error);
                    // Continue anyway - the modal should still open
                }
            } else {
                document.getElementById('noteForm').reset();
                selectedPinStyle = { type: 'emoji', value: 'üìç' };
                clearNoteMedia();
                
                // Set default date/time to current date/time
                setDefaultEventDateTime();
            }
            
            updatePinStyleSelection();
            populateTemplateSelector();
            document.getElementById('noteModal').classList.remove('hidden');
        }

        function setDefaultEventDateTime() {
            const now = new Date();
            
            // Format date as YYYY-MM-DD
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateString = `${year}-${month}-${day}`;
            
            // Format time as HH:MM
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            
            document.getElementById('eventStartDate').value = dateString;
            document.getElementById('eventStartTime').value = timeString;
        }

        // Dynamic layout management for view modal
        let modalSectionStates = {
            content: { expanded: false, defaultHeight: 0 },
            media: { expanded: false, defaultHeight: 0 },
            comments: { expanded: false, defaultHeight: 0 }
        };

        function initializeAdaptiveLayout(note) {
            const contentSection = document.getElementById('contentSection');
            const mediaSection = document.getElementById('mediaSection');
            const commentsSection = document.getElementById('commentsSection');
            const mediaScrollContainer = document.getElementById('mediaScrollContainer');
            const commentsScrollContainer = document.getElementById('commentsScrollContainer');

            // Determine optimal content height based on text length
            const contentLength = note.content.length;
            let contentHeight;
            if (contentLength < 100) {
                contentHeight = '200px'; // Larger for short content
            } else if (contentLength < 300) {
                contentHeight = '150px'; // Medium
            } else {
                contentHeight = '120px'; // Default for longer content
            }

            // Set initial heights
            contentSection.style.height = contentHeight;
            modalSectionStates.content.defaultHeight = parseInt(contentHeight);

            // Media section - small by default, expandable
            if (note.media && note.media.length > 0) {
                mediaScrollContainer.style.height = '120px'; // Small initial height
                modalSectionStates.media.defaultHeight = 120;
            }

            // Comments section - much smaller by default, expandable  
            commentsScrollContainer.style.height = '60px'; // Smaller initial height
            modalSectionStates.comments.defaultHeight = 60;

            // Add scroll listeners for dynamic expansion
            setupDynamicScrolling();
        }

        function setupDynamicScrolling() {
            const contentSection = document.getElementById('contentSection');
            const mediaScrollContainer = document.getElementById('mediaScrollContainer');
            const viewMediaGrid = document.getElementById('viewMediaGrid'); // The actual scrolling element for media
            const commentsScrollContainer = document.getElementById('commentsScrollContainer');
            const viewTags = document.getElementById('viewTags'); // Tags scroll container

            let activeSection = null;

            // Content section scroll handler
            contentSection.addEventListener('scroll', () => {
                if (activeSection !== 'content') {
                    activeSection = 'content';
                    expandSection('content');
                    collapseOtherSections('content');
                }
            });

            // Media section scroll handler - attach to the actual horizontal scrolling element
            if (viewMediaGrid) {
                viewMediaGrid.addEventListener('scroll', () => {
                    if (activeSection !== 'media') {
                        activeSection = 'media';
                        expandSection('media');
                        collapseOtherSections('media');
                    }
                });

                // Add scroll/drag attempt detection even when content doesn't overflow
                let startX = 0;
                let startScrollLeft = 0;
                let isDragging = false;

                // Mouse events for desktop
                viewMediaGrid.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.pageX;
                    startScrollLeft = viewMediaGrid.scrollLeft;
                });

                viewMediaGrid.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const x = e.pageX;
                    const walk = (x - startX) * 2; // Scroll speed multiplier
                    
                    // If user attempts to scroll horizontally, expand media section
                    if (Math.abs(walk) > 10 && activeSection !== 'media') {
                        activeSection = 'media';
                        expandSection('media');
                        collapseOtherSections('media');
                    }
                    
                    viewMediaGrid.scrollLeft = startScrollLeft - walk;
                });

                viewMediaGrid.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                viewMediaGrid.addEventListener('mouseleave', () => {
                    isDragging = false;
                });

                // Touch events for mobile
                viewMediaGrid.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].pageX;
                    startScrollLeft = viewMediaGrid.scrollLeft;
                }, { passive: true });

                viewMediaGrid.addEventListener('touchmove', (e) => {
                    const x = e.touches[0].pageX;
                    const walk = (x - startX) * 2;
                    
                    // If user attempts to scroll horizontally, expand media section
                    if (Math.abs(walk) > 10 && activeSection !== 'media') {
                        activeSection = 'media';
                        expandSection('media');
                        collapseOtherSections('media');
                    }
                }, { passive: true });

                // Wheel event for mouse wheel horizontal scrolling
                viewMediaGrid.addEventListener('wheel', (e) => {
                    if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                        // Horizontal wheel movement detected
                        if (activeSection !== 'media') {
                            activeSection = 'media';
                            expandSection('media');
                            collapseOtherSections('media');
                        }
                    }
                }, { passive: true });
            }

            // Tags section scroll handler
            if (viewTags) {
                viewTags.parentElement.addEventListener('scroll', () => {
                    // Tags can expand on scroll but only collapse other sections
                    if (activeSection !== 'tags') {
                        activeSection = 'tags';
                        collapseOtherSections('tags');
                    }
                });
            }

            // Comments section scroll handler - only when comments are visible
            commentsScrollContainer.addEventListener('scroll', () => {
                if (modalSectionStates.comments.visible && activeSection !== 'comments') {
                    activeSection = 'comments';
                    expandSection('comments');
                    collapseOtherSections('comments');
                }
            });

            // No auto-collapse functionality - sections only change when user actively interacts
        }

        function getScrollElement(sectionName) {
            switch (sectionName) {
                case 'content': return document.getElementById('contentSection');
                case 'media': return document.getElementById('mediaScrollContainer');
                case 'comments': return document.getElementById('commentsScrollContainer');
                default: return null;
            }
        }

        function getSectionElement(sectionName) {
            switch (sectionName) {
                case 'content': return document.getElementById('contentSection');
                case 'media': return document.getElementById('mediaSection');
                case 'comments': return document.getElementById('commentsSection');
                default: return null;
            }
        }

        function expandSection(sectionName) {
            const element = getSectionElement(sectionName);
            const scrollElement = getScrollElement(sectionName);
            
            if (!element) return;

            modalSectionStates[sectionName].expanded = true;

            switch (sectionName) {
                case 'content':
                    element.style.height = '300px';
                    break;
                case 'media':
                    if (scrollElement) scrollElement.style.height = '250px';
                    // Update media HTML to show larger images
                    const grid = document.getElementById('viewMediaGrid');
                    if (grid && grid.updateMediaHTML) {
                        grid.innerHTML = grid.updateMediaHTML(true);
                    }
                    break;
                case 'comments':
                    scrollElement.style.height = '200px';
                    break;
            }

            // Update hint text
            updateHintText(sectionName, true);
        }

        function collapseSection(sectionName) {
            const element = getSectionElement(sectionName);
            const scrollElement = getScrollElement(sectionName);
            
            if (!element) return;

            modalSectionStates[sectionName].expanded = false;

            switch (sectionName) {
                case 'content':
                    element.style.height = modalSectionStates.content.defaultHeight + 'px';
                    break;
                case 'media':
                    if (scrollElement) scrollElement.style.height = modalSectionStates.media.defaultHeight + 'px';
                    // Update media HTML to show smaller images
                    const grid = document.getElementById('viewMediaGrid');
                    if (grid && grid.updateMediaHTML) {
                        grid.innerHTML = grid.updateMediaHTML(false);
                    }
                    break;
                case 'comments':
                    scrollElement.style.height = modalSectionStates.comments.defaultHeight + 'px';
                    break;
            }

            // Update hint text
            updateHintText(sectionName, false);
        }

        function collapseOtherSections(activeSectionName) {
            Object.keys(modalSectionStates).forEach(sectionName => {
                if (sectionName !== activeSectionName && modalSectionStates[sectionName].expanded) {
                    collapseSection(sectionName);
                }
            });
        }

        function updateHintText(sectionName, isExpanded) {
            let hintElement;
            switch (sectionName) {
                case 'media':
                    hintElement = document.getElementById('mediaScrollHint');
                    break;
                case 'comments':
                    hintElement = document.getElementById('commentScrollHint');
                    break;
            }

            if (hintElement) {
                hintElement.textContent = isExpanded ? 'Scroll to top to collapse' : 'Scroll to expand';
                hintElement.style.opacity = isExpanded ? '0.6' : '1';
            }
        }

        function showViewModal(note, animationOrigin = null) {
            document.getElementById('instructionsOverlay').classList.add('hidden');
            
            // Apply the animation based on whether we have an origin point
            const modal = document.getElementById('viewModal');
            
            if (animationOrigin) {
                // Calculate animation origin as percentages of viewport
                const originX = (animationOrigin.x / window.innerWidth) * 100;
                const originY = (animationOrigin.y / window.innerHeight) * 100;
                
                // Set CSS custom properties for the animation origin
                modal.style.setProperty('--animation-origin-x', `${originX}%`);
                modal.style.setProperty('--animation-origin-y', `${originY}%`);
                
                // Add fade overlay class and show modal
                modal.classList.add('modal-overlay-fade');
                modal.classList.remove('hidden');
                
                // Start overlay fade animation
                setTimeout(() => {
                    modal.classList.add('modal-overlay-fade-active');
                }, 10);
                
                // Find the modal content and add zoom animation
                const modalContent = modal.querySelector('.bg-white');
                if (modalContent) {
                    modalContent.classList.add('modal-content-zoom');
                    
                    // Trigger content zoom animation
                    setTimeout(() => {
                        modalContent.classList.add('modal-content-zoom-active');
                    }, 50);
                    
                    // Clean up content animation classes
                    setTimeout(() => {
                        modalContent.classList.remove('modal-content-zoom', 'modal-content-zoom-active');
                    }, 350);
                }
                
                // Clean up overlay animation classes
                setTimeout(() => {
                    modal.classList.remove('modal-overlay-fade', 'modal-overlay-fade-active');
                }, 350);
            } else {
                // Fallback fade animation for modal content
                modal.classList.remove('hidden');
                const modalContent = modal.querySelector('.bg-white');
                
                if (modalContent) {
                    modalContent.classList.add('modal-content-fade');
                    
                    setTimeout(() => {
                        modalContent.classList.add('modal-content-fade-active');
                    }, 10);
                    
                    setTimeout(() => {
                        modalContent.classList.remove('modal-content-fade', 'modal-content-fade-active');
                    }, 350);
                }
            }
            
            // Add pin icon and privacy icon to title
            const pinIcon = note.pinStyle?.type === 'custom' && note.pinStyle?.value ? 
                `<img src="${note.pinStyle.value}" class="w-5 h-5 rounded-full object-cover inline mr-2" alt="Pin">` :
                `<span class="mr-2">${note.pinStyle?.value || 'üìç'}</span>`;
            const privacyIcon = getPrivacyIcon(note.privacy || 'public');
            const privacyLabel = getPrivacyLabel(note.privacy || 'public');
            document.getElementById('viewTitle').innerHTML = `${pinIcon}${note.title} <span class="text-sm text-gray-500 dark:text-gray-400 font-normal" title="${privacyLabel}">${privacyIcon}</span>`;
            document.getElementById('viewAuthor').textContent = note.author;
            
            // Format creation date with time
            const createdDate = new Date(note.createdAt);
            const formatOptions = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            document.getElementById('viewDate').textContent = `Posted ${createdDate.toLocaleDateString('en-US', formatOptions)}`;
            
            // Show modification date if note was updated
            const modifiedSection = document.getElementById('viewModified');
            const modifiedDateSpan = document.getElementById('viewModifiedDate');
            if (note.updatedAt) {
                const updatedDate = new Date(note.updatedAt);
                modifiedDateSpan.textContent = `Modified ${updatedDate.toLocaleDateString('en-US', formatOptions)}`;
                modifiedSection.classList.remove('hidden');
            } else {
                modifiedSection.classList.add('hidden');
            }
            
            document.getElementById('viewContent').textContent = note.content;
            
            // Make note content and title interactive for word highlighting
            makeTextInteractive(document.getElementById('viewContent'));
            makeTextInteractive(document.getElementById('viewTitle'));
            
            // Also make author name interactive for search
            makeTextInteractive(document.getElementById('viewAuthor'));

            const author = users.find(u => u.id === note.authorId);
            const authorProfilePic = author ? getUserProfilePicture(author) : getDefaultProfilePicture();
            document.getElementById('viewAuthorPic').src = authorProfilePic;

            const editBtn = document.getElementById('editNoteBtn');
            editBtn.classList.toggle('hidden', !canEditNote(note));

            // Tags section removed
            
            // Make author name and profile pic clickable for profile
            const authorContainer = document.querySelector('#viewAuthorPic').parentElement;
            const authorNameElement = document.getElementById('viewAuthor');
            
            // Add clickable styles and event handlers
            authorContainer.classList.add('cursor-pointer', 'hover:bg-gray-100', 'dark:hover:bg-gray-700', 'rounded-lg', 'p-1', '-m-1', 'transition-colors');
            authorNameElement.className = 'font-medium cursor-pointer hover:text-primary transition-colors';
            
            // User profile handler
            const showUserProfileHandler = (e) => {
                e.stopPropagation();
                showUserProfile(note.author, note.authorId);
            };
            
            authorContainer.onclick = showUserProfileHandler;
            authorNameElement.onclick = showUserProfileHandler;
            
            editBtn.onclick = () => {
                document.getElementById('viewModal').classList.add('hidden');
                showNoteModal(note.lat, note.lng, note);
            };

            // Display event information if available
            displayEventInfo(note);

            // Display payment information if available
            displayPaymentInfo(note);

            // Setup comment system
            setupCommentForm(note);
            renderComments(note);

            // Render media gallery
            renderMediaGallery(note);

            // Initialize adaptive layout after content is rendered
            document.getElementById('viewModal').classList.remove('hidden');
            
            // Wait for modal to be visible, then initialize layout
            setTimeout(() => {
                initializeAdaptiveLayout(note);
            }, 100);
        }

        function hideModals() {
            document.getElementById('noteModal').classList.add('hidden');
            document.getElementById('viewModal').classList.add('hidden');
            document.getElementById('authModal').classList.add('hidden');
            // Clear pin highlight with a small delay after modals close
            setTimeout(clearPinHighlight, 300);
        }

        function updatePinStyleSelection() {
            document.querySelectorAll('.pin-style-btn').forEach(btn => {
                const isSelected = btn.dataset.emoji === selectedPinStyle.value;
                btn.classList.toggle('ring-4', isSelected);
                btn.classList.toggle('ring-primary', isSelected);
            });
        }

        // User options dropdown
        function showUserOptionsDropdown(triggerElement, username, userId) {
            // Remove any existing dropdown
            const existingDropdown = document.getElementById('userOptionsDropdown');
            if (existingDropdown) {
                existingDropdown.remove();
            }
            
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // Check if this is the current user
            const isCurrentUser = currentUser && userId === currentUser.id;
            
            // Get user notes count
            const userNotesCount = notes.filter(note => note.authorId === userId).length;
            const profilePic = getUserProfilePicture(user);
            
            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.id = 'userOptionsDropdown';
            dropdown.className = 'fixed bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-[3000] py-2 min-w-64';
            
            if (isCurrentUser) {
                // Quick edit dropdown for current user
                dropdown.innerHTML = `
                    <div class="px-3 py-3 border-b border-gray-200 dark:border-gray-600">
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600">
                                    <img src="${profilePic}" alt="${username}" class="w-full h-full object-cover">
                                </div>
                                <label for="quickProfilePicUpload" class="absolute bottom-0 right-0 w-4 h-4 bg-primary text-white rounded-full flex items-center justify-center cursor-pointer hover:bg-primary/90 transition-colors">
                                    <i class="fas fa-camera text-xs"></i>
                                    <input type="file" id="quickProfilePicUpload" class="hidden" accept="image/*">
                                </label>
                            </div>
                            <div class="flex-1">
                                <div class="font-medium text-sm">${username}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${userNotesCount} note${userNotesCount !== 1 ? 's' : ''}</div>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 space-y-3">
                        <!-- GPS Visibility Settings -->
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <label class="text-xs font-medium text-gray-600 dark:text-gray-400">GPS Visibility</label>
                                <span id="quickVisibilityHint" class="text-xs text-gray-500">Everyone can see</span>
                            </div>
                            <select id="quickVisibilitySelect" class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="public">üåç Public</option>
                                <option value="friends">üë• Friends Only</option>
                                <option value="invisible">üëª Invisible</option>
                            </select>
                        </div>
                        
                        <!-- Quick Status Update -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Status</label>
                            <select id="quickStatusSelect" class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                                <option value="Available">üü¢ Available</option>
                                <option value="Busy">üî¥ Busy</option>
                                <option value="Away">üü° Away</option>
                                <option value="Invisible">‚ö´ Invisible</option>
                                <option value="Custom">‚úèÔ∏è Custom...</option>
                            </select>
                            <input type="text" id="quickCustomStatusInput" placeholder="Enter custom status..." maxlength="50" 
                                   class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary mt-1 hidden">
                        </div>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-600 py-1">
                        <button class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-2" onclick="showProfileSettingsModal('profile'); document.getElementById('userOptionsDropdown').remove();">
                            <i class="fas fa-cog text-gray-400"></i>
                            <span>Full Profile Settings</span>
                        </button>
                        <button class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-2" onclick="viewUserNotes('${username}', ${userId})">
                            <i class="fas fa-map-marked-alt text-gray-400"></i>
                            <span>View My Notes</span>
                        </button>
                    </div>
                `;
            } else {
                // Regular dropdown for other users
                dropdown.innerHTML = `
                    <div class="px-3 py-2 border-b border-gray-200 dark:border-gray-600">
                        <div class="font-medium text-sm">${username}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${userNotesCount} note${userNotesCount !== 1 ? 's' : ''}</div>
                    </div>
                    <div class="py-1">
                        <button class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-2" onclick="showUserProfile('${username}', ${userId})">
                            <i class="fas fa-user text-gray-400"></i>
                            <span>View Profile</span>
                        </button>
                        <button class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center space-x-2" onclick="viewUserNotes('${username}', ${userId})">
                            <i class="fas fa-map-marked-alt text-gray-400"></i>
                            <span>View Their Notes</span>
                        </button>
                    </div>
                `;
            }
            
            document.body.appendChild(dropdown);
            
            // Position dropdown
            const rect = triggerElement.getBoundingClientRect();
            const dropdownRect = dropdown.getBoundingClientRect();
            
            // Calculate position
            let top = rect.bottom + window.scrollY + 5;
            let left = rect.left + window.scrollX;
            
            // Adjust if dropdown would go off screen
            if (left + dropdownRect.width > window.innerWidth) {
                left = window.innerWidth - dropdownRect.width - 10;
            }
            
            if (top + dropdownRect.height > window.innerHeight + window.scrollY) {
                top = rect.top + window.scrollY - dropdownRect.height - 5;
            }
            
            dropdown.style.top = `${top}px`;
            dropdown.style.left = `${left}px`;
            
            // Setup quick edit functionality for current user
            if (isCurrentUser) {
                setupQuickEditHandlers(dropdown);
            }
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                const closeHandler = (e) => {
                    if (!dropdown.contains(e.target)) {
                        dropdown.remove();
                        document.removeEventListener('click', closeHandler);
                    }
                };
                document.addEventListener('click', closeHandler);
            }, 100);
        }
        
        function updateVisibilityHint(hintElement, visibility) {
            const hints = {
                'public': 'Everyone can see',
                'friends': 'Friends only',
                'invisible': 'Hidden from others'
            };
            hintElement.textContent = hints[visibility] || 'Everyone can see';
        }

        function setupQuickEditHandlers(dropdown) {
            // Set current values
            const quickStatusSelect = dropdown.querySelector('#quickStatusSelect');
            const quickCustomStatusInput = dropdown.querySelector('#quickCustomStatusInput');
            const quickVisibilitySelect = dropdown.querySelector('#quickVisibilitySelect');
            const quickProfilePicUpload = dropdown.querySelector('#quickProfilePicUpload');
            
            // Set current status - fix the "always custom" issue
            const userStatus = currentUser.status || 'Available';
            const isCustomStatus = !['Available', 'Busy', 'Away', 'Invisible'].includes(userStatus);
            
            if (isCustomStatus) {
                quickStatusSelect.value = 'Custom';
                quickCustomStatusInput.classList.remove('hidden');
                quickCustomStatusInput.value = userStatus;
            } else {
                quickStatusSelect.value = userStatus;
                quickCustomStatusInput.classList.add('hidden');
            }
            
            // Set current visibility and update hint
            const currentVisibility = currentUser.visibility || 'public';
            quickVisibilitySelect.value = currentVisibility;
            updateVisibilityHint(dropdown.querySelector('#quickVisibilityHint'), currentVisibility);
            
            // Status change handler
            quickStatusSelect.addEventListener('change', () => {
                if (quickStatusSelect.value === 'Custom') {
                    quickCustomStatusInput.classList.remove('hidden');
                    quickCustomStatusInput.focus();
                    quickCustomStatusInput.value = currentUser.customStatus || '';
                } else {
                    quickCustomStatusInput.classList.add('hidden');
                    // Update status immediately
                    currentUser.status = quickStatusSelect.value;
                    currentUser.customStatus = null;
                    updateProfilePictures();
                    showNotification('Status updated!', 'success');
                }
            });
            
            // Custom status handler
            quickCustomStatusInput.addEventListener('blur', () => {
                const customStatus = quickCustomStatusInput.value.trim();
                if (customStatus) {
                    currentUser.status = customStatus;
                    currentUser.customStatus = customStatus;
                    updateProfilePictures();
                    showNotification('Custom status updated!', 'success');
                } else {
                    currentUser.status = 'Available';
                    currentUser.customStatus = null;
                    quickStatusSelect.value = 'Available';
                    quickCustomStatusInput.classList.add('hidden');
                    updateProfilePictures();
                }
            });
            
            quickCustomStatusInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    quickCustomStatusInput.blur();
                }
            });
            
            // Visibility change handler
            quickVisibilitySelect.addEventListener('change', () => {
                currentUser.visibility = quickVisibilitySelect.value;
                updateVisibilityHint(dropdown.querySelector('#quickVisibilityHint'), quickVisibilitySelect.value);
                showNotification(`GPS visibility set to ${quickVisibilitySelect.value}`, 'success');
            });
            
            // Profile picture upload handler
            quickProfilePicUpload.addEventListener('change', async (e) => {
                if (e.target.files[0]) {
                    const file = e.target.files[0];
                    if (file.type.startsWith('image/')) {
                        const dataUrl = await createImageDataUrl(file);
                        currentUser.profilePicture = dataUrl;
                        
                        // Update the dropdown image immediately
                        const dropdownImg = dropdown.querySelector('img');
                        dropdownImg.src = dataUrl;
                        
                        // Update all profile pictures
                        updateProfilePictures();
                        showNotification('Profile picture updated!', 'success');
                    }
                    e.target.value = ''; // Reset file input
                }
            });
        }
        
        function showUserProfile(username, userId) {
            // Remove dropdown
            const dropdown = document.getElementById('userOptionsDropdown');
            if (dropdown) dropdown.remove();
            
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const userNotesCount = notes.filter(note => note.authorId === userId).length;
            const memberSince = new Date(user.createdAt).toLocaleDateString();
            const profilePic = getUserProfilePicture(user);
            
            // Generate media gallery HTML if user has media
            let mediaHTML = '';
            if (user.media && user.media.length > 0) {
                mediaHTML = `
                    <div class="mt-4">
                        <div class="flex space-x-3 overflow-x-auto pb-2" style="scrollbar-width: thin;">
                            ${user.media.map(item => {
                                if (item.type === 'image') {
                                    return `
                                        <div class="relative cursor-pointer flex-shrink-0 w-32" onclick="showMediaModal('${item.data}', 'image')">
                                            <img src="${item.data}" alt="${item.name}" class="w-32 h-24 object-cover rounded-lg hover:opacity-90 transition-opacity">
                                            <div class="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 py-0.5 rounded">
                                                <i class="fas fa-image"></i>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div class="relative cursor-pointer flex-shrink-0 w-32" onclick="showMediaModal('${item.data}', 'video')">
                                            <video src="${item.data}" class="w-32 h-24 object-cover rounded-lg hover:opacity-90 transition-opacity" muted></video>
                                            <div class="absolute inset-0 flex items-center justify-center">
                                                <div class="w-6 h-6 bg-black bg-opacity-60 rounded-full flex items-center justify-center">
                                                    <i class="fas fa-play text-white text-xs"></i>
                                                </div>
                                            </div>
                                            <div class="absolute bottom-1 left-1 bg-black bg-opacity-60 text-white text-xs px-1 py-0.5 rounded">
                                                <i class="fas fa-video"></i>
                                            </div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Generate tags HTML if user has tags
            let tagsHTML = '';
            if (user.tags && user.tags.length > 0) {
                tagsHTML = `
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <div class="flex flex-wrap gap-2">
                            ${user.tags.map(tag => 
                                `<span class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full text-sm cursor-pointer hover:bg-primary hover:text-white transition-colors" onclick="setTagFilter('${tag}'); this.closest('.fixed').remove();">
                                    #${tag}
                                </span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Determine friendship status and button details
            const friendshipStatus = getFriendshipStatus(userId);
            let friendButtonHTML = '';
            
            if (friendshipStatus === 'none') {
                friendButtonHTML = `<button class="friend-action-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" onclick="sendFriendRequest(${userId}); updateFriendButton(this, ${userId});">
                    <i class="fas fa-user-plus mr-2"></i>Add Friend
                </button>`;
            } else if (friendshipStatus === 'pending') {
                friendButtonHTML = `<button class="friend-action-btn px-4 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed" disabled>
                    <i class="fas fa-clock mr-2"></i>Request Sent
                </button>`;
            } else if (friendshipStatus === 'received') {
                friendButtonHTML = `<button class="friend-action-btn px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" onclick="acceptFriendRequest(${userId}); updateFriendButton(this, ${userId});">
                    <i class="fas fa-check mr-2"></i>Accept Request
                </button>`;
            } else if (friendshipStatus === 'friends') {
                friendButtonHTML = `<button class="friend-action-btn px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors" onclick="showUnfriendConfirm(${userId}, this);">
                    <i class="fas fa-check mr-2"></i>Friends
                </button>`;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] flex flex-col">
                    <!-- Header -->
                    <div class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 pr-4">
                                <h2 class="text-xl font-semibold mb-3">${username}</h2>
                                <div class="flex items-center space-x-4 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-gray-300 dark:border-gray-600">
                                            <img src="${profilePic}" alt="${username}" class="w-full h-full object-cover bg-gray-200 dark:bg-gray-600">
                                        </div>
                                        <span class="font-medium">${user.status || 'Available'}</span>
                                    </div>
                                    <div class="text-gray-500 dark:text-gray-400">
                                        <div class="flex items-center space-x-1">
                                            <i class="fas fa-calendar text-xs"></i>
                                            <span>Member since ${memberSince}</span>
                                        </div>
                                        <div class="flex items-center space-x-1 mt-1">
                                            <i class="fas fa-map-marked-alt text-xs"></i>
                                            <span>${userNotesCount} note${userNotesCount !== 1 ? 's' : ''}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto px-6 pt-6">
                        ${user.bio ? `<div class="prose dark:prose-invert max-w-none whitespace-pre-wrap text-gray-700 dark:text-gray-300">${user.bio}</div>` : '<div class="text-gray-500 dark:text-gray-400 italic">No bio available</div>'}
                        
                        ${mediaHTML}
                        ${tagsHTML}
                    </div>
                    
                    <!-- Footer -->
                    <div class="flex-shrink-0 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-750">
                        <div class="flex space-x-3">
                            ${currentUser ? friendButtonHTML : ''}
                            <button class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" onclick="viewUserNotes('${username}', ${userId}); this.closest('.fixed').remove();">
                                <i class="fas fa-map-marked-alt mr-2"></i>View Notes
                            </button>
                            <button class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" onclick="this.closest('.fixed').remove();">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }
        
        function viewUserNotes(username, userId) {
            // Remove dropdown
            const dropdown = document.getElementById('userOptionsDropdown');
            if (dropdown) dropdown.remove();
            
            // Close any open modals
            hideModals();
            
            // Filter to show only this user's notes
            setAuthorFilter(username);
            
            // Show notification
            showNotification(`Now showing notes by ${username}`, 'success');
        }

        // Utility functions
        function showMediaEditModal(mediaItem) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] flex flex-col">
                    <!-- Header -->
                    <div class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-semibold">Edit Media</h2>
                            <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <!-- Media Preview -->
                        <div class="mb-6">
                            <div class="flex justify-center">
                                ${mediaItem.type === 'image' ? 
                                    `<img src="${mediaItem.data}" alt="${mediaItem.name}" class="max-w-full max-h-64 object-contain rounded-lg border border-gray-200 dark:border-gray-600">` :
                                    `<video src="${mediaItem.data}" controls class="max-w-full max-h-64 rounded-lg border border-gray-200 dark:border-gray-600" muted>
                                        Your browser does not support the video tag.
                                    </video>`
                                }
                            </div>
                        </div>
                        
                        <!-- Edit Form -->
                        <form class="space-y-4">
                            <!-- Title -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Title</label>
                                <input type="text" id="mediaTitle" value="${mediaItem.title || ''}" 
                                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                       placeholder="Enter a title for this ${mediaItem.type}...">
                            </div>
                            
                            <!-- Description -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Description</label>
                                <textarea id="mediaDescription" rows="3" 
                                          class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                          placeholder="Describe this ${mediaItem.type}...">${mediaItem.description || ''}</textarea>
                            </div>
                            
                            <!-- Price (Optional) -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Price <span class="text-gray-500 text-xs">(Optional)</span></label>
                                <div class="grid grid-cols-4 gap-2">
                                    <select id="mediaCurrency" class="px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="USD">üá∫üá∏ USD</option>
                                        <option value="EUR">üá™üá∫ EUR</option>
                                        <option value="GBP">üá¨üáß GBP</option>
                                        <option value="JPY">üáØüáµ JPY</option>
                                        <option value="CAD">üá®üá¶ CAD</option>
                                        <option value="AUD">üá¶üá∫ AUD</option>
                                        <option value="CHF">üá®üá≠ CHF</option>
                                        <option value="CNY">üá®üá≥ CNY</option>
                                        <option value="KRW">üá∞üá∑ KRW</option>
                                        <option value="INR">üáÆüá≥ INR</option>
                                        <option value="BRL">üáßüá∑ BRL</option>
                                        <option value="MXN">üá≤üáΩ MXN</option>
                                        <option value="RUB">üá∑üá∫ RUB</option>
                                        <option value="ZAR">üáøüá¶ ZAR</option>
                                        <option value="SEK">üá∏üá™ SEK</option>
                                        <option value="NOK">üá≥üá¥ NOK</option>
                                        <option value="DKK">üá©üá∞ DKK</option>
                                        <option value="PLN">üáµüá± PLN</option>
                                        <option value="CZK">üá®üáø CZK</option>
                                        <option value="HUF">üá≠üá∫ HUF</option>
                                        <option value="TRY">üáπüá∑ TRY</option>
                                        <option value="ILS">üáÆüá± ILS</option>
                                        <option value="AED">üá¶üá™ AED</option>
                                        <option value="SAR">üá∏üá¶ SAR</option>
                                        <option value="THB">üáπüá≠ THB</option>
                                        <option value="SGD">üá∏üá¨ SGD</option>
                                        <option value="MYR">üá≤üáæ MYR</option>
                                        <option value="IDR">üáÆüá© IDR</option>
                                        <option value="PHP">üáµüá≠ PHP</option>
                                        <option value="VND">üáªüá≥ VND</option>
                                        <option value="NZD">üá≥üáø NZD</option>
                                        <option value="HKD">üá≠üá∞ HKD</option>
                                        <option value="TWD">üáπüáº TWD</option>
                                    </select>
                                    <input type="number" id="mediaPrice" step="0.01" min="0" value="${mediaItem.price || ''}" 
                                           class="px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                           placeholder="0.00">
                                </div>
                                
                                <!-- Quantity -->
                                <div>
                                    <label class="block text-sm font-medium mb-2">Quantity</label>
                                    <input type="number" id="mediaQuantity" min="0" value="${mediaItem.quantity || 1}" 
                                           class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                           placeholder="quantity">
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Footer -->
                    <div class="flex-shrink-0 p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-750">
                        <div class="flex justify-end space-x-3">
                            <button class="cancel-btn px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                Cancel
                            </button>
                            <button class="save-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Set current currency to last used or default
            modal.querySelector('#mediaCurrency').value = mediaItem.currency || lastUsedCurrency;
            
            // Event handlers
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.querySelector('.save-btn').onclick = () => {
                const title = modal.querySelector('#mediaTitle').value.trim();
                const description = modal.querySelector('#mediaDescription').value.trim();
                const currency = modal.querySelector('#mediaCurrency').value;
                const price = parseFloat(modal.querySelector('#mediaPrice').value) || 0;
                const quantity = parseInt(modal.querySelector('#mediaQuantity').value) || 1;
                
                // Remember last used currency
                lastUsedCurrency = currency;
                
                // Update the media item
                mediaItem.title = title;
                mediaItem.description = description;
                mediaItem.currency = currency;
                mediaItem.price = price;
                mediaItem.quantity = quantity;
                
                // Refresh the media preview to show updated info
                updateMediaPreview();
                
                modal.remove();
                showNotification('Media updated successfully!', 'success');
            };
            
            document.body.appendChild(modal);
        }

        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded">OK</button>
                    </div>
                </div>
            `;
            modal.querySelector('button').onclick = () => modal.remove();
            document.body.appendChild(modal);
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                        <button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">Confirm</button>
                    </div>
                </div>
            `;
            
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = () => {
                modal.remove();
                onConfirm();
            };
            
            document.body.appendChild(modal);
        }

        function showCrowdfundSetupModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">‚ö†Ô∏è Payment Method Required</h3>
                        <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                            <div class="text-sm text-yellow-800 dark:text-yellow-200">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                To create crowdfund notes, you need to set up a payment method in your Account Settings first.
                            </div>
                        </div>
                        
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            This ensures contributors can actually send you money when they support your campaign.
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                Back to Note
                            </button>
                            <button class="setup-btn px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded">
                                <i class="fas fa-cog mr-2"></i>Account Settings
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.querySelector('.setup-btn').onclick = () => {
                modal.remove();
                document.getElementById('noteModal').classList.add('hidden');
                showProfileSettingsModal('account');
            };
            
            document.body.appendChild(modal);
        }

        function showNotification(message, type = 'default') {
            try {
                const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-primary';
                
                const notification = document.createElement('div');
                notification.className = `fixed top-20 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-[2000] transform translate-x-full transition-transform duration-300`;
                notification.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span>${message}</span>
                        <button class="ml-2 hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">√ó</button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, 5000);
            } catch (error) {
                console.error('Notification error:', error);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Track drag operations globally
            document.addEventListener('mousedown', () => {
                dragStartTime = Date.now();
                isDragging = false;
            });
            
            document.addEventListener('mousemove', () => {
                if (dragStartTime > 0) {
                    isDragging = true;
                }
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    dragEndTime = Date.now();
                }
                dragStartTime = 0;
                isDragging = false;
            });
            
            initMap();

            // Generate sample profile pictures
            function generateProfilePicture(bgColor, emoji) {
                const canvas = document.createElement('canvas');
                canvas.width = 120;
                canvas.height = 120;
                const ctx = canvas.getContext('2d');
                
                // Create gradient background
                const gradient = ctx.createLinearGradient(0, 0, 120, 120);
                gradient.addColorStop(0, bgColor);
                gradient.addColorStop(1, adjustBrightness(bgColor, -20));
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 120, 120);
                
                // Add emoji
                ctx.font = 'bold 60px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(emoji, 60, 60);
                
                return canvas.toDataURL();
            }
            
            function adjustBrightness(hex, percent) {
                const num = parseInt(hex.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            }

            // Create simple test users for easy login testing
            users.push({
                id: 1,
                username: 'l',
                password: 'l',
                email: 'l@l.l',
                profilePicture: generateProfilePicture('#FF6B6B', 'üî•'),
                status: 'Testing the app',
                bio: 'Test user L - easy login for testing',
                tags: ['tester', 'developer'],
                visibility: 'public',
                friends: [],
                sentFriendRequests: [],
                receivedFriendRequests: [],
                transactions: [],
                createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000)
            });

            users.push({
                id: 2,
                username: 'm',
                password: 'm',
                email: 'm@m.m',
                profilePicture: generateProfilePicture('#4ECDC4', '‚ö°'),
                status: 'Ready to connect',
                bio: 'Test user M - ready for friend requests',
                tags: ['friendly', 'social'],
                visibility: 'public',
                friends: [],
                sentFriendRequests: [],
                receivedFriendRequests: [],
                createdAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000)
            });

            users.push({
                id: 3,
                username: 'n',
                password: 'n',
                email: 'n@n.n',
                profilePicture: generateProfilePicture('#9B59B6', 'üíé'),
                status: 'Exploring connections',
                bio: 'Test user N - loves making new friends',
                tags: ['explorer', 'connector'],
                visibility: 'public',
                friends: [],
                sentFriendRequests: [],
                receivedFriendRequests: [],
                createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000)
            });

            users.push({
                id: 4,
                username: 'o',
                password: 'o',
                email: 'o@o.o',
                profilePicture: generateProfilePicture('#F39C12', 'üåü'),
                status: 'Building networks',
                bio: 'Test user O - networking enthusiast',
                tags: ['networker', 'enthusiast'],
                visibility: 'public',
                friends: [],
                sentFriendRequests: [],
                receivedFriendRequests: [],
                createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000)
            });

            // Create demo user with rich content
            users.push({
                id: 5,
                username: 'demo',
                password: 'demo',
                email: 'demo@example.com',
                profilePicture: generateProfilePicture('#5D5CDE', 'üéØ'),
                status: 'Exploring the city',
                bio: 'Urban explorer and food enthusiast! Always looking for hidden gems and amazing experiences around the city. Love discovering new places and sharing them with fellow adventurers.',
                tags: ['urban-explorer', 'foodie', 'traveler', 'photography'],
                visibility: 'public',
                media: [
                    { id: 'demo1', type: 'image', data: generateSampleImage('#ff6b6b', 'City Views'), name: 'cityscape.jpg' },
                    { id: 'demo2', type: 'image', data: generateSampleImage('#4ecdc4', 'Food Adventures'), name: 'food.jpg' },
                    { id: 'demo3', type: 'image', data: generateSampleImage('#45b7d1', 'Coffee Moments'), name: 'coffee.jpg' }
                ],
                customEmojis: ['üéØ', 'üöÄ', '‚ö°'],
                customPins: [
                    {
                        id: 'demo-pin-1',
                        type: 'custom',
                        value: generateCustomPinArt('#5D5CDE', 'üéØ'),
                        createdAt: new Date()
                    }
                ],
                templates: [
                    {
                        id: 'demo-template-1',
                        name: 'üèôÔ∏è City Discovery',
                        title: '',
                        content: 'Location type: \nWhat caught my attention: \nBest time to visit: \nAccessibility: \nWould I return? \n\nPersonal notes:',
                        tags: 'discovery, city, exploration',
                        pinStyle: { type: 'emoji', value: 'üéØ' },
                        createdAt: new Date()
                    }
                ],
                createdAt: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000) // 2 weeks ago
            });

            // Create foodie explorer with rich content
            users.push({
                id: 6,
                username: 'foodie_explorer',
                password: 'pass123',
                email: 'foodie@example.com',
                profilePicture: generateProfilePicture('#FF6B6B', 'üçï'),
                status: 'Always hungry for new flavors!',
                bio: 'Professional food critic and culinary adventurer üç¥\n\nSpecializing in authentic local cuisine and hidden food gems. I believe every meal tells a story, and I\'m here to discover and share those delicious narratives.\n\nüìç Based in NYC\nüåü Featured in Food & Wine Magazine\nü•ò 1000+ restaurants reviewed',
                tags: ['food-critic', 'culinary', 'restaurant-reviewer', 'chef', 'foodie'],
                visibility: 'public',
                media: [
                    { id: 'foodie1', type: 'image', data: generateSampleImage('#FF6B6B', 'Gourmet Pizza'), name: 'pizza-review.jpg' },
                    { id: 'foodie2', type: 'image', data: generateSampleImage('#FFA726', 'Pasta Paradise'), name: 'pasta.jpg' },
                    { id: 'foodie3', type: 'image', data: generateSampleImage('#66BB6A', 'Fresh Salads'), name: 'healthy.jpg' },
                    { id: 'foodie4', type: 'image', data: generateSampleImage('#AB47BC', 'Dessert Heaven'), name: 'desserts.jpg' },
                    { id: 'foodie5', type: 'image', data: generateSampleImage('#FF7043', 'Street Food'), name: 'street-food.jpg' }
                ],
                customEmojis: ['üçï', 'ü•ò', 'üçú', 'üßÄ', 'ü•ê'],
                customPins: [
                    {
                        id: 'foodie-pin-1',
                        type: 'custom',
                        value: generateCustomPinArt('#FF6B6B', 'üçï'),
                        createdAt: new Date()
                    },
                    {
                        id: 'foodie-pin-2',
                        type: 'custom',
                        value: generateCustomPinArt('#FFA726', 'ü•ò'),
                        createdAt: new Date()
                    }
                ],
                templates: [
                    {
                        id: 'foodie-template-1',
                        name: 'üçΩÔ∏è Fine Dining Review',
                        title: '',
                        content: 'Rating: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê\n\nAmbiance: \nService: \nFood Quality: \nPresentation: \nValue for Money: \n\nStandout Dishes:\n\nWine Pairing: \n\nOverall Experience:\n\nWould I return? \nRecommend for:',
                        tags: 'fine-dining, restaurant, review, gourmet',
                        pinStyle: { type: 'custom', value: generateCustomPinArt('#FF6B6B', 'üçï') },
                        createdAt: new Date()
                    }
                ],
                createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) // 1 week ago
            });

            // Create photographer with rich content  
            users.push({
                id: 7,
                username: 'photographer',
                password: 'pass123',
                email: 'photo@example.com',
                profilePicture: generateProfilePicture('#9C27B0', 'üì∏'),
                status: 'Chasing golden hour',
                bio: 'Professional photographer & visual storyteller üì∑\n\nSpecializing in urban landscapes, street photography, and architectural details. Always seeking that perfect light and unique perspective.\n\nüèÜ Award-winning photographer\nüìö Photography workshops instructor\nüåç Traveled to 40+ countries\nüì∏ 10+ years experience\n\n"Photography is about finding beauty in unexpected places"',
                tags: ['photographer', 'visual-artist', 'workshop-instructor', 'travel-photographer', 'urban-explorer'],
                visibility: 'public',
                media: [
                    { id: 'photo1', type: 'image', data: generateSampleImage('#9C27B0', 'Golden Hour'), name: 'golden-hour.jpg' },
                    { id: 'photo2', type: 'image', data: generateSampleImage('#FF9800', 'Street Art'), name: 'street-art.jpg' },
                    { id: 'photo3', type: 'image', data: generateSampleImage('#607D8B', 'Architecture'), name: 'buildings.jpg' },
                    { id: 'photo4', type: 'image', data: generateSampleImage('#4CAF50', 'Nature in City'), name: 'urban-nature.jpg' },
                    { id: 'photo5', type: 'image', data: generateSampleImage('#F44336', 'Night Lights'), name: 'night-photography.jpg' },
                    { id: 'photo6', type: 'image', data: generateSampleImage('#2196F3', 'Reflections'), name: 'reflections.jpg' }
                ],
                customEmojis: ['üì∏', 'üåÖ', 'üèôÔ∏è', 'üé®', '‚ú®'],
                customPins: [
                    {
                        id: 'photo-pin-1',
                        type: 'custom',
                        value: generateCustomPinArt('#9C27B0', 'üì∏'),
                        createdAt: new Date()
                    },
                    {
                        id: 'photo-pin-2',
                        type: 'custom',
                        value: generateCustomPinArt('#FF9800', 'üåÖ'),
                        createdAt: new Date()
                    },
                    {
                        id: 'photo-pin-3',
                        type: 'custom',
                        value: generateCustomPinArt('#607D8B', 'üèôÔ∏è'),
                        createdAt: new Date()
                    }
                ],
                templates: [
                    {
                        id: 'photo-template-1',
                        name: 'üì∑ Photography Location',
                        title: '',
                        content: 'Best time for photos: \nLighting conditions: \nCamera settings used: \nAccessibility: \nCrowd level: \nPermits required: \n\nWhat makes this spot special:\n\nComposition tips:\n\nGear recommendations:\n\nSafety notes:',
                        tags: 'photography, location, camera-settings, lighting',
                        pinStyle: { type: 'custom', value: generateCustomPinArt('#9C27B0', 'üì∏') },
                        createdAt: new Date()
                    },
                    {
                        id: 'photo-template-2',
                        name: 'üåÖ Golden Hour Spot',
                        title: '',
                        content: 'Sunrise time: \nSunset time: \nDirection of light: \nForeground elements: \nBackground options: \nWeather considerations: \n\nBest angles:\n\nSeasonal variations:\n\nReturn visit notes:',
                        tags: 'golden-hour, sunrise, sunset, lighting',
                        pinStyle: { type: 'custom', value: generateCustomPinArt('#FF9800', 'üåÖ') },
                        createdAt: new Date()
                    }
                ],
                createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000) // 3 days ago
            });

            // Generate sample custom pin art (simple colored circles)
            function generateCustomPinArt(color, symbol) {
                const canvas = document.createElement('canvas');
                canvas.width = 40;
                canvas.height = 40;
                const ctx = canvas.getContext('2d');
                
                // Draw circle background
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(20, 20, 18, 0, 2 * Math.PI);
                ctx.fill();
                
                // Add border
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Add symbol
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(symbol, 20, 20);
                
                return canvas.toDataURL();
            }

            // Generate sample media (simple colored rectangles with labels)
            function generateSampleImage(color, label, width = 300, height = 200) {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                // Background
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, width, height);
                
                // Label
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(label, width/2, height/2);
                
                return canvas.toDataURL();
            }

            // Create sample notes with varied content
            const sampleNotes = [
                {
                    lat: 40.7589, lng: -73.9851, // Times Square area
                    title: "Amazing Pizza Joint",
                    content: "Rating: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê\n\nDiscovered this incredible hole-in-the-wall pizza place! The crust is perfectly crispy, sauce has just the right amount of tang, and the cheese... don't get me started on the cheese. \n\nHighlights:\n- Wood-fired oven gives amazing flavor\n- Super friendly staff\n- Great value for money\n\nPrice range: $$\nWould I return? Absolutely!\n\nPro tip: Try the margherita - it's perfection.",
                    tags: ['restaurant', 'pizza', 'italian', 'budget-friendly', 'must-try'],
                    authorId: 2,
                    author: 'foodie_explorer',
                    pinStyle: { type: 'emoji', value: 'üçï' },
                    media: [
                        { id: 1, type: 'image', data: generateSampleImage('#ff6b6b', 'Delicious Pizza'), name: 'pizza.jpg' },
                        { id: 2, type: 'image', data: generateSampleImage('#4ecdc4', 'Cozy Interior'), name: 'interior.jpg' }
                    ],
                    createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000)
                },
                {
                    lat: 40.7614, lng: -73.9776, // Bryant Park
                    title: "Perfect Coffee Spot",
                    content: "Great for work!",
                    tags: ['coffee', 'wifi', 'work'],
                    authorId: 1,
                    author: 'demo',
                    pinStyle: { type: 'emoji', value: '‚òï' },
                    media: [],
                    createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000)
                },
                {
                    lat: 40.7505, lng: -73.9934, // High Line area
                    title: "Stunning Sunset Photography Spot",
                    content: "This elevated park offers incredible views of the Hudson River and Manhattan skyline. Perfect golden hour lighting between 6-7 PM.\n\nBest time to visit: Late afternoon\nLighting: Western exposure, great for sunsets\nCrowd level: Moderate\nAccessibility: Elevator access available\n\nWhat makes it special:\nThe contrast between the old railway structure and modern city creates unique compositions.\n\nTips for photographers:\n- Bring a wide-angle lens\n- Visit on weekdays for fewer crowds\n- The benches make great foreground elements",
                    tags: ['photography', 'sunset', 'park', 'views', 'instagram'],
                    authorId: 3,
                    author: 'photographer',
                    pinStyle: { type: 'custom', value: generateCustomPinArt('#ff9500', 'üì∏') },
                    media: [
                        { id: 3, type: 'image', data: generateSampleImage('#ff9500', 'Sunset View'), name: 'sunset.jpg' },
                        { id: 4, type: 'image', data: generateSampleImage('#6c5ce7', 'City Skyline'), name: 'skyline.jpg' },
                        { id: 5, type: 'image', data: generateSampleImage('#fd79a8', 'Railway Detail'), name: 'detail.jpg' }
                    ],
                    createdAt: new Date(Date.now() - 5 * 60 * 60 * 1000)
                },
                {
                    lat: 40.7282, lng: -74.0776, // Brooklyn Bridge
                    title: "Historic Walk",
                    content: "Beautiful bridge with amazing city views. Walked the entire span - took about 30 minutes. Best views are from the center pedestrian walkway.",
                    tags: ['historic', 'walking', 'views', 'bridge', 'tourist'],
                    authorId: 1,
                    author: 'demo',
                    pinStyle: { type: 'emoji', value: 'üåâ' },
                    media: [
                        { id: 6, type: 'image', data: generateSampleImage('#00b894', 'Bridge View'), name: 'bridge.jpg' }
                    ],
                    createdAt: new Date(Date.now() - 6 * 60 * 60 * 1000)
                },
                {
                    lat: 40.7505, lng: -73.9810, // Near High Line
                    title: "Community Photography Workshop",
                    content: "Join us for an outdoor photography workshop! We'll explore composition techniques, lighting, and street photography. All skill levels welcome. Bring your camera (phone cameras work too!).\n\nWhat we'll cover:\n- Basic composition rules\n- Working with natural light\n- Street photography ethics\n- Photo editing tips\n\nMeet at the High Line entrance. Workshop includes coffee and pastries!",
                    tags: ['photography', 'workshop', 'community', 'learning', 'outdoor'],
                    authorId: 3,
                    author: 'photographer',
                    pinStyle: { type: 'custom', value: generateCustomPinArt('#9C27B0', 'üì∏') },
                    media: [
                        { id: 8, type: 'image', data: generateSampleImage('#9C27B0', 'Workshop Preview'), name: 'workshop.jpg' }
                    ],
                    event: {
                        startDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 3 days from now
                        startTime: '14:00',
                        endDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        endTime: '17:00',
                        rsvpListVisible: true
                    },
                    payment: {
                        type: 'ticket-price',
                        ticketPrice: 25.00,
                        availableTickets: 12,
                        details: 'Payment accepted via Venmo @photographer or cash at the event. Tickets include materials and refreshments.'
                    },
                    rsvps: [2, 5], // foodie_explorer and demo have already RSVP'd
                    createdAt: new Date(Date.now() - 4 * 60 * 60 * 1000)
                },
                {
                    lat: 40.7614, lng: -73.9790, // Bryant Park
                    title: "Food Truck Festival Meetup",
                    content: "Calling all foodies! Let's explore the amazing food trucks gathering in Bryant Park this weekend. We'll try different cuisines and share our favorites.\n\nPlan:\n- Meet at the main entrance\n- Sample 3-4 different food trucks\n- Share photos and reviews\n- Optional: grab drinks after\n\nThis is a casual meetup - just come hungry and ready to explore! Great opportunity to meet fellow food lovers.",
                    tags: ['food', 'festival', 'meetup', 'social', 'food-trucks'],
                    authorId: 2,
                    author: 'foodie_explorer',
                    pinStyle: { type: 'emoji', value: 'üöö' },
                    media: [],
                    event: {
                        startDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 5 days from now
                        startTime: '12:00',
                        endDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        endTime: '15:00',
                        rsvpListVisible: true
                    },
                    payment: {
                        type: 'free',
                        details: 'This is a free meetup! Just bring money for your own food purchases from the trucks.'
                    },
                    rsvps: [1, 3, 5], // demo, photographer, and demo user have RSVP'd
                    createdAt: new Date(Date.now() - 8 * 60 * 60 * 1000)
                },
                {
                    lat: 40.7829, lng: -73.9654, // Central Park
                    title: "Central Park Jogging",
                    content: "Perfect morning run! The loop around the reservoir is exactly 1.58 miles. Beautiful fall foliage right now.\n\nRoute details:\n- Start at 90th St entrance\n- Counter-clockwise is less crowded\n- Great views of the city skyline\n- Water fountains every half mile\n\nBest time: Early morning (7-8 AM) before it gets busy.",
                    tags: ['running', 'exercise', 'park', 'nature', 'fitness'],
                    authorId: 2,
                    author: 'foodie_explorer',
                    pinStyle: { type: 'custom', value: generateCustomPinArt('#00a085', 'üèÉ') },
                    media: [],
                    createdAt: new Date(Date.now() - 12 * 60 * 60 * 1000)
                },
                {
                    lat: 40.7484, lng: -73.9857, // Empire State Building area
                    title: "Late Night Diner",
                    content: "Classic 24-hour diner. Nothing fancy but hits the spot at 2 AM. Great pancakes and friendly service.",
                    tags: ['diner', '24-hours', 'comfort-food', 'late-night'],
                    authorId: 3,
                    author: 'photographer',
                    pinStyle: { type: 'emoji', value: 'ü•û' },
                    media: [
                        { id: 7, type: 'image', data: generateSampleImage('#fdcb6e', 'Classic Diner'), name: 'diner.jpg' }
                    ],
                    createdAt: new Date(Date.now() - 18 * 60 * 60 * 1000)
                },
                {
                    lat: 40.7411, lng: -74.0040, // SoHo area
                    title: "Vintage Shopping Find",
                    content: "Incredible vintage clothing store! Found a perfect 1960s leather jacket. Owner is super knowledgeable about fashion history.",
                    tags: ['shopping', 'vintage', 'fashion', 'soho', 'unique'],
                    authorId: 1,
                    author: 'demo',
                    pinStyle: { type: 'custom', value: generateCustomPinArt('#e17055', 'üëó') },
                    media: [],
                    createdAt: new Date(Date.now() - 36 * 60 * 60 * 1000)
                }
            ];

            // Add sample notes to the notes array and map
            sampleNotes.forEach((noteData, index) => {
                const note = {
                    id: Date.now() + index,
                    ...noteData,
                    comments: []
                };
                notes.push(note);
                addNoteToMap(note);
            });

            // Add some sample comments with nested replies to demonstrate threading
            const sampleComments = [
                {
                    noteIndex: 0, // Pizza place
                    comments: [
                        {
                            id: Date.now() + 1000,
                            content: "I went here last week based on your recommendation - absolutely amazing! The margherita was perfect.",
                            authorId: 1,
                            author: 'demo',
                            parentId: null,
                            createdAt: new Date(Date.now() - 20 * 60 * 60 * 1000)
                        },
                        {
                            id: Date.now() + 1001,
                            content: "So glad you enjoyed it! Did you try the garlic knots too?",
                            authorId: 2,
                            author: 'foodie_explorer',
                            parentId: Date.now() + 1000, // Reply to first comment
                            createdAt: new Date(Date.now() - 19 * 60 * 60 * 1000)
                        },
                        {
                            id: Date.now() + 1002,
                            content: "Oh yes! The garlic knots were incredible too. Going back this weekend üòä",
                            authorId: 1,
                            author: 'demo',
                            parentId: Date.now() + 1000, // Another reply to first comment
                            createdAt: new Date(Date.now() - 18 * 60 * 60 * 1000)
                        },
                        {
                            id: Date.now() + 1003,
                            content: "Thanks for sharing! Can't wait to try it üçï",
                            authorId: 3,
                            author: 'photographer',
                            parentId: null, // Top-level comment
                            createdAt: new Date(Date.now() - 16 * 60 * 60 * 1000)
                        }
                    ]
                },
                {
                    noteIndex: 2, // Photography spot
                    comments: [
                        {
                            id: Date.now() + 1004,
                            content: "Beautiful shots! What camera settings did you use for the sunset?",
                            authorId: 1,
                            author: 'demo',
                            parentId: null,
                            createdAt: new Date(Date.now() - 4 * 60 * 60 * 1000)
                        },
                        {
                            id: Date.now() + 1005,
                            content: "Thanks! I used f/8, ISO 100, and bracketed exposures for HDR. The key is timing - arrive 30 minutes before sunset.",
                            authorId: 3,
                            author: 'photographer',
                            parentId: Date.now() + 1004, // Reply to camera settings question
                            createdAt: new Date(Date.now() - 3 * 60 * 60 * 1000)
                        }
                    ]
                }
            ];

            // Add comments to notes
            sampleComments.forEach(({ noteIndex, comments: noteComments }) => {
                if (notes[noteIndex]) {
                    notes[noteIndex].comments = noteComments;
                }
            });

            // Set up cross-friend requests between test users for testing
            const userL = users.find(u => u.username === 'l');
            const userM = users.find(u => u.username === 'm');
            const userN = users.find(u => u.username === 'n');
            const userO = users.find(u => u.username === 'o');
            
            if (userL && userM && userN && userO) {
                // User L receives requests from M and N (2 notifications when logged in as L)
                userM.sentFriendRequests.push(userL.id);
                userL.receivedFriendRequests.push(userM.id);
                userN.sentFriendRequests.push(userL.id);
                userL.receivedFriendRequests.push(userN.id);
                
                // User M receives request from O (1 notification when logged in as M)
                userO.sentFriendRequests.push(userM.id);
                userM.receivedFriendRequests.push(userO.id);
                
                // User N receives requests from L and O (2 notifications when logged in as N)
                userL.sentFriendRequests.push(userN.id);
                userN.receivedFriendRequests.push(userL.id);
                userO.sentFriendRequests.push(userN.id);
                userN.receivedFriendRequests.push(userO.id);
                
                // User O receives request from M (1 notification when logged in as O)
                userM.sentFriendRequests.push(userO.id);
                userO.receivedFriendRequests.push(userM.id);
            }

            // Instructions
            document.getElementById('closeInstructions').addEventListener('click', () => {
                document.getElementById('instructionsOverlay').classList.add('hidden');
            });

            document.getElementById('instructionsLoginBtn').addEventListener('click', () => {
                showAuthModal(false);
            });

            document.getElementById('instructionsRegisterBtn').addEventListener('click', () => {
                showAuthModal(true);
            });

            // Auth
            document.getElementById('loginBtn').addEventListener('click', () => showAuthModal(false));
            document.getElementById('registerBtn').addEventListener('click', () => showAuthModal(true));
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
            document.getElementById('closeAuthModal').addEventListener('click', hideModals);

            document.getElementById('authSwitchBtn').addEventListener('click', () => {
                // Check what mode to switch TO by looking at button text
                const switchBtn = document.getElementById('authSwitchBtn');
                const shouldShowRegister = switchBtn.textContent.includes('Register');
                
                // Clear form fields when switching
                document.getElementById('authUsername').value = '';
                document.getElementById('authPassword').value = '';
                document.getElementById('authEmail').value = '';
                
                // Switch to the mode the button is asking for
                showAuthModal(shouldShowRegister);
            });

            document.getElementById('authForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const mode = e.target.dataset.mode;
                const username = document.getElementById('authUsername').value;
                const password = document.getElementById('authPassword').value;
                const email = document.getElementById('authEmail').value;

                if (mode === 'register') {
                    if (registerUser(username, password, email)) {
                        if (loginUser(username, password)) {
                            hideModals();
                            showAlert('Registration successful! You are now logged in.');
                        }
                    }
                } else {
                    if (loginUser(username, password)) {
                        hideModals();
                    } else {
                        showAlert('Invalid username or password');
                    }
                }
            });

            // Profile dropdown
            document.getElementById('profileBtn').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Profile button clicked');
                const dropdown = document.getElementById('profileDropdown');
                console.log('Dropdown element:', dropdown);
                console.log('Dropdown classes before toggle:', dropdown.className);
                dropdown.classList.toggle('hidden');
                console.log('Dropdown classes after toggle:', dropdown.className);
            });

            document.addEventListener('click', (e) => {
                const profileBtn = document.getElementById('profileBtn');
                const dropdown = document.getElementById('profileDropdown');
                if (!profileBtn.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Modal controls
            document.getElementById('closeModal').addEventListener('click', hideModals);
            document.getElementById('closeViewModal').addEventListener('click', () => {
                hideModals();
                // Clear pin highlight with a small delay after modal closes
                setTimeout(clearPinHighlight, 300);
            });
            document.getElementById('cancelBtn').addEventListener('click', hideModals);

            // Pin style selection
            document.querySelectorAll('.pin-style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedPinStyle = { type: 'emoji', value: btn.dataset.emoji };
                    updatePinStyleSelection();
                });
            });

            // Template functionality
            document.getElementById('templateSelector').addEventListener('change', (e) => {
                applyTemplate(e.target.value);
            });

            document.getElementById('saveAsTemplateBtn').addEventListener('click', saveAsTemplate);
            document.getElementById('manageTemplatesBtn').addEventListener('click', showManageTemplatesModal);

            // Delete note
            document.getElementById('deleteNoteBtn').addEventListener('click', () => {
                showConfirmDialog("Are you sure you want to delete this note?", () => {
                    if (deleteNote(currentNoteId)) {
                        hideModals();
                    } else {
                        showAlert('You can only delete your own notes');
                    }
                });
            });

            // Note form submission
            document.getElementById('noteForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const title = document.getElementById('noteTitle').value.trim();
                const content = document.getElementById('noteContent').value.trim();
                const tags = ''; // Tags field removed
                
                // Validate that at least one field (title or content) has content
                if (!title && !content) {
                    showAlert('Please enter either a title or content for your note');
                    return;
                }
                
                // Safely get privacy value, default to 'public' if element doesn't exist
                const privacyElement = document.getElementById('notePrivacy');
                const privacy = privacyElement ? privacyElement.value : 'public';
                
                console.log('=== NOTE FORM SUBMISSION DEBUG ===');
                console.log('Form values:', { title, content, tags, privacy });
                console.log('eventEnabled at submission:', eventEnabled);
                console.log('Event toggle classes:', document.getElementById('eventToggleBtn').className);

                // Validate crowdfund payment setup
                if (paymentEnabled && document.getElementById('paymentType').value === 'crowdfund') {
                    if (!currentUser.paymentMethod || !currentUser.paymentDetails) {
                        showCrowdfundSetupModal();
                        return; // Don't save the note
                    }
                }

                if (currentNoteId) {
                    const updated = updateNote(currentNoteId, title, content, tags, selectedPinStyle, privacy);
                    if (updated) {
                        hideModals();
                        clearNoteForm();
                    } else {
                        showAlert('You can only edit your own notes');
                    }
                } else {
                    createNote(currentNoteLat, currentNoteLng, title, content, tags, selectedPinStyle, privacy);
                    hideModals();
                    clearNoteForm();
                }
            });

            // Emoji dropdown functionality
            const emojiDropdownBtn = document.getElementById('emojiDropdownBtn');
            const emojiDropdown = document.getElementById('emojiDropdown');

            emojiDropdownBtn.addEventListener('click', () => {
                emojiDropdown.classList.toggle('hidden');
                // Update grids when dropdown opens
                if (!emojiDropdown.classList.contains('hidden')) {
                    updatePinGrids();
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!emojiDropdownBtn.contains(e.target) && !emojiDropdown.contains(e.target)) {
                    emojiDropdown.classList.add('hidden');
                }
            });

            // Add emoji functionality
            document.getElementById('addEmojiBtn').addEventListener('click', () => {
                document.getElementById('addEmojiSection').classList.remove('hidden');
                document.getElementById('newEmojiInput').focus();
            });

            document.getElementById('cancelAddEmoji').addEventListener('click', () => {
                document.getElementById('addEmojiSection').classList.add('hidden');
                document.getElementById('newEmojiInput').value = '';
            });

            document.getElementById('saveEmojiBtn').addEventListener('click', () => {
                const emoji = document.getElementById('newEmojiInput').value.trim();
                if (emoji) {
                    if (emoji.length > 2) {
                        showAlert('Please enter a single emoji character');
                        return;
                    }
                    addEmojiToCollection(emoji);
                    document.getElementById('addEmojiSection').classList.add('hidden');
                    document.getElementById('newEmojiInput').value = '';
                }
            });

            // Add custom art functionality
            document.getElementById('addCustomArtBtn').addEventListener('click', () => {
                // Trigger file upload directly
                document.getElementById('newCustomPinUpload').click();
            });

            document.getElementById('cancelAddCustomArt').addEventListener('click', () => {
                document.getElementById('addCustomArtSection').classList.add('hidden');
            });

            document.getElementById('newCustomPinUpload').addEventListener('change', async (e) => {
                if (e.target.files[0]) {
                    const file = e.target.files[0];
                    if (file.type.startsWith('image/')) {
                        const dataUrl = await createImageDataUrl(file);
                        addCustomPinToCollection(dataUrl);
                        e.target.value = ''; // Reset file input
                        document.getElementById('addCustomArtSection').classList.add('hidden');
                    }
                }
            });

            // Quick custom pin upload
            document.getElementById('pinArtUpload').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    handleCustomPinUpload(e.target.files[0]);
                }
            });

            document.getElementById('removeCustomPin').addEventListener('click', removeCustomPin);

            // Media upload functionality
            document.getElementById('mediaUpload').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    addMediaToNote(e.target.files);
                    e.target.value = ''; // Reset file input
                }
            });

            // Add media button functionality (element doesn't exist, removing)

            // Objects functionality (removed - no objectsBtn element)

            // Click outside modal to close (for view modal only)
            document.getElementById('viewModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('viewModal')) {
                    hideModals();
                }
            });

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Check if it's a special filter command
                if (query.startsWith('by:')) {
                    // Author filter
                    const author = query.substring(3).trim();
                    activeFilters.search = '';
                    activeFilters.author = author;
                    activeFilters.tag = '';
                } else if (query.startsWith('#')) {
                    // Tag filter
                    const tag = query.substring(1).trim();
                    activeFilters.search = '';
                    activeFilters.author = '';
                    activeFilters.tag = tag;
                } else {
                    // Regular search
                    activeFilters.search = query;
                    activeFilters.author = '';
                    activeFilters.tag = '';
                }
                
                applyFilters();
            });

            // Clear search on ESC key
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    clearAllFilters();
                }
            });

            // Profile settings functionality - direct event listeners with null checks
            const editProfileBtn = document.getElementById('editProfileBtn');
            const accountSettingsBtn = document.getElementById('accountSettingsBtn');
            const friendsBtn = document.getElementById('friendsBtn');
            
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', function(e) {
                    console.log('Edit Profile button clicked directly');
                    e.preventDefault();
                    e.stopPropagation();
                    document.getElementById('profileDropdown').classList.add('hidden');
                    showProfileSettingsModal('profile');
                });
            }
            
            if (accountSettingsBtn) {
                accountSettingsBtn.addEventListener('click', function(e) {
                    console.log('Account Settings button clicked directly');
                    e.preventDefault();
                    e.stopPropagation();
                    document.getElementById('profileDropdown').classList.add('hidden');
                    showProfileSettingsModal('account');
                });
            }
            
            if (friendsBtn) {
                friendsBtn.addEventListener('click', function(e) {
                    console.log('Friends button clicked directly');
                    e.preventDefault();
                    e.stopPropagation();
                    document.getElementById('profileDropdown').classList.add('hidden');
                    showProfileSettingsModal('friends');
                });
            }

            // Header profile/status click handlers
            document.getElementById('headerProfilePicContainer').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent dropdown from opening
                if (currentUser) {
                    showProfileSettingsModal('profile');
                }
            });

            document.getElementById('headerUserInfo').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent dropdown from opening
                if (currentUser) {
                    showProfileSettingsModal('profile');
                }
            });

            // Profile settings modal controls
            document.getElementById('closeSettingsModal').addEventListener('click', () => {
                document.getElementById('profileSettingsModal').classList.add('hidden');
            });

            document.getElementById('cancelSettingsBtn').addEventListener('click', () => {
                document.getElementById('profileSettingsModal').classList.add('hidden');
            });

            document.getElementById('saveSettingsBtn').addEventListener('click', saveProfileSettings);

            // Tab switching
            document.getElementById('profileTab').addEventListener('click', () => switchSettingsTab('profile'));
            document.getElementById('accountTab').addEventListener('click', () => switchSettingsTab('account'));
            document.getElementById('friendsTab').addEventListener('click', () => {
                switchSettingsTab('friends');
                console.log('=== FRIENDS TAB CLICKED ===');
                console.log('Current user when clicking friends tab:', currentUser?.username);
                console.log('Friend requests before render:', currentUser?.receivedFriendRequests);
                renderFriendsSection();
                // Clear notifications when friends section is accessed
                clearFriendNotifications();
            });
            
            document.getElementById('eventsTab').addEventListener('click', () => switchSettingsTab('events'));
            
            const transactionsTab = document.getElementById('transactionsTab');
            if (transactionsTab) {
                transactionsTab.addEventListener('click', () => {
                    switchSettingsTab('transactions');
                    renderTransactionsSection();
                });
            }

            // Profile picture upload
            document.getElementById('profilePicUpload').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    handleProfilePicUpload(e.target.files[0]);
                }
            });

            document.getElementById('removeProfilePicBtn').addEventListener('click', removeProfilePicture);

            // These elements no longer exist - removed

            // Profile media upload functionality
            document.getElementById('profileMediaUpload').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    addMediaToProfile(e.target.files);
                    e.target.value = ''; // Reset file input
                }
            });

            // Privacy, Event, and Payment toggle functionality with null checks
            // (using global variables declared at top)
            
            const privacyToggleBtn = document.getElementById('privacyToggleBtn');
            const eventToggleBtn = document.getElementById('eventToggleBtn');
            const paymentToggleBtn = document.getElementById('paymentToggleBtn');
            
            if (privacyToggleBtn) {
                privacyToggleBtn.addEventListener('click', () => {
                    initializePrivacyField(); // Ensure field exists
                    privacyEnabled = !privacyEnabled;
                    updatePrivacyToggle();
                    
                    if (privacyEnabled) {
                        // Show privacy options popup
                        showPrivacyPopup();
                    } else {
                        // Reset to public when disabled
                        const privacyField = document.getElementById('notePrivacy');
                        if (privacyField) {
                            privacyField.value = 'public';
                        }
                    }
                });
            }

            if (eventToggleBtn) {
                eventToggleBtn.addEventListener('click', () => {
                    console.log('=== EVENT TOGGLE CLICKED ===');
                    console.log('eventEnabled before toggle:', eventEnabled);
                    eventEnabled = !eventEnabled;
                    console.log('eventEnabled after toggle:', eventEnabled);
                    updateEventToggle();
                    
                    if (eventEnabled) {
                        // Show event options popup
                        showEventPopup();
                    } else {
                        // Clear event data when disabled
                        clearEventData();
                    }
                });
            }

            if (paymentToggleBtn) {
                paymentToggleBtn.addEventListener('click', () => {
                    paymentEnabled = !paymentEnabled;
                    updatePaymentToggle();
                    
                    if (paymentEnabled) {
                        // If event is already enabled, default to ticket-price
                        if (eventEnabled) {
                            const paymentTypeField = document.getElementById('paymentType');
                            if (paymentTypeField) {
                                paymentTypeField.value = 'ticket-price';
                            }
                        }
                        // Show payment options popup
                        showPaymentPopup();
                    } else {
                        // Clear payment data and reset toggle text when disabled
                        clearPaymentData();
                        const paymentToggleText = document.getElementById('paymentToggleText');
                        if (paymentToggleText) {
                            paymentToggleText.textContent = 'Payment';
                        }
                    }
                });
            }





            // Event time change handlers to auto-set payment type
            document.getElementById('eventStartDate').addEventListener('change', checkEventTimeAndUpdatePayment);
            document.getElementById('eventStartTime').addEventListener('change', checkEventTimeAndUpdatePayment);

            function checkEventTimeAndUpdatePayment() {
                const startDate = document.getElementById('eventStartDate').value;
                const startTime = document.getElementById('eventStartTime').value;
                
                // If both date and time are set and payment options are visible, default to "Ticket Price"
                if (startDate && startTime) {
                    const paymentOptions = document.getElementById('paymentOptions');
                    if (!paymentOptions.classList.contains('hidden')) {
                        document.getElementById('paymentType').value = 'ticket-price';
                        updatePaymentFields();
                    }
                }
            }

            function updatePaymentFields() {
                // This function handles showing/hiding payment fields based on type
                // Since we're using hidden fields and popups, we don't need to do anything here
                // The popup handles the field visibility internally
                console.log('updatePaymentFields called - payment type:', document.getElementById('paymentType').value);
            }

            // Privacy popup function
            function showPrivacyPopup() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Privacy Settings</h3>
                            <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <label class="block text-sm font-medium mb-2">Who can see this note?</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                    <input type="radio" name="privacy" value="public" class="text-primary" checked>
                                    <div>
                                        <div class="font-medium">üåç Public</div>
                                        <div class="text-sm text-gray-500">Everyone can see this note</div>
                                    </div>
                                </label>
                                <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                    <input type="radio" name="privacy" value="friends" class="text-primary">
                                    <div>
                                        <div class="font-medium">üë• Friends Only</div>
                                        <div class="text-sm text-gray-500">Only your friends can see this</div>
                                    </div>
                                </label>
                                <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                    <input type="radio" name="privacy" value="friends-of-friends" class="text-primary">
                                    <div>
                                        <div class="font-medium">ü§ù Friends of Friends</div>
                                        <div class="text-sm text-gray-500">Friends and their friends can see this</div>
                                    </div>
                                </label>
                                <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                    <input type="radio" name="privacy" value="self" class="text-primary">
                                    <div>
                                        <div class="font-medium">üîí Private</div>
                                        <div class="text-sm text-gray-500">Only you can see this note</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button class="save-btn px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded">Save</button>
                        </div>
                    </div>
                `;
                
                // Set current privacy value
                const currentPrivacy = document.getElementById('notePrivacy').value || 'public';
                const radioBtn = modal.querySelector(`input[value="${currentPrivacy}"]`);
                if (radioBtn) radioBtn.checked = true;
                
                modal.querySelector('.close-btn').onclick = () => modal.remove();
                modal.querySelector('.cancel-btn').onclick = () => modal.remove();
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.querySelector('.save-btn').onclick = () => {
                    const selectedPrivacy = modal.querySelector('input[name="privacy"]:checked').value;
                    document.getElementById('notePrivacy').value = selectedPrivacy;
                    
                    // Update privacy toggle text to show selected option
                    const privacyText = modal.querySelector(`input[value="${selectedPrivacy}"]`).parentElement.querySelector('.font-medium').textContent;
                    document.getElementById('privacyToggleText').textContent = privacyText.substring(2); // Remove emoji
                    
                    modal.remove();
                };
                
                document.body.appendChild(modal);
            }

            // Event popup function
            function showEventPopup() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg w-full mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold flex items-center">
                                <i class="fas fa-calendar-alt mr-2 text-primary"></i>
                                Event Configuration
                            </h3>
                            <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Start Date/Time -->
                                <div>
                                    <label class="block text-sm font-medium mb-2">Start Date & Time</label>
                                    <div class="space-y-2">
                                        <input type="date" id="popupEventStartDate" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <input type="time" id="popupEventStartTime" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>
                                
                                <!-- End Date/Time (Optional) -->
                                <div>
                                    <label class="block text-sm font-medium mb-2">End Date & Time <span class="text-xs text-gray-500">(Optional)</span></label>
                                    <div class="space-y-2">
                                        <input type="date" id="popupEventEndDate" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <input type="time" id="popupEventEndTime" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RSVP Settings -->
                            <div>
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" id="popupRsvpListVisible" class="w-4 h-4 text-primary border-gray-300 dark:border-gray-600 rounded focus:ring-primary focus:ring-2">
                                    <span class="text-sm font-medium">Make RSVP list visible to others</span>
                                </label>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">When checked, people can see who else has RSVP'd to this event</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button class="save-btn px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded">Save</button>
                        </div>
                    </div>
                `;
                
                // Set current event values
                const currentStartDate = document.getElementById('eventStartDate').value;
                const currentStartTime = document.getElementById('eventStartTime').value;
                const currentEndDate = document.getElementById('eventEndDate').value;
                const currentEndTime = document.getElementById('eventEndTime').value;
                const currentRsvpVisible = document.getElementById('rsvpListVisible').checked;
                
                // If no current values, set defaults
                if (!currentStartDate || !currentStartTime) {
                    setDefaultEventDateTime();
                }
                
                modal.querySelector('#popupEventStartDate').value = document.getElementById('eventStartDate').value;
                modal.querySelector('#popupEventStartTime').value = document.getElementById('eventStartTime').value;
                modal.querySelector('#popupEventEndDate').value = currentEndDate;
                modal.querySelector('#popupEventEndTime').value = currentEndTime;
                modal.querySelector('#popupRsvpListVisible').checked = currentRsvpVisible;
                
                modal.querySelector('.close-btn').onclick = () => modal.remove();
                modal.querySelector('.cancel-btn').onclick = () => modal.remove();
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.querySelector('.save-btn').onclick = () => {
                    // Save values back to the hidden form fields
                    document.getElementById('eventStartDate').value = modal.querySelector('#popupEventStartDate').value;
                    document.getElementById('eventStartTime').value = modal.querySelector('#popupEventStartTime').value;
                    document.getElementById('eventEndDate').value = modal.querySelector('#popupEventEndDate').value;
                    document.getElementById('eventEndTime').value = modal.querySelector('#popupEventEndTime').value;
                    document.getElementById('rsvpListVisible').value = modal.querySelector('#popupRsvpListVisible').checked;
                    
                    modal.remove();
                };
                
                document.body.appendChild(modal);
            }

            // Payment popup function
            function showPaymentPopup() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[3000]';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg w-full mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold flex items-center">
                                <i class="fas fa-credit-card mr-2 text-primary"></i>
                                Payment Configuration
                            </h3>
                            <button class="close-btn text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Payment Type -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Payment Type</label>
                                <select id="popupPaymentType" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="free">üí∞ Free</option>
                                    <option value="donation">üéÅ Donation</option>
                                    <option value="ticket-price">üé´ Ticket Price</option>
                                    <option value="crowdfund">üìä Crowdfund</option>
                                    <option value="payment">üí≥ Payment</option>
                                </select>
                            </div>
                            
                            <!-- Amount Field (for donation/payment) -->
                            <div id="popupAmountField">
                                <label class="block text-sm font-medium mb-2">Amount</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                    <input type="number" id="popupPaymentAmount" step="0.01" min="0" placeholder="0.00" class="w-full pl-8 pr-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Ticket Price Fields -->
                            <div id="popupTicketFields" class="hidden grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ticket Price</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                        <input type="number" id="popupTicketPrice" step="0.01" min="0" placeholder="25.00" class="w-full pl-8 pr-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Available Tickets</label>
                                    <input type="number" id="popupTicketQuantity" min="1" placeholder="50" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Crowdfund Fields -->
                            <div id="popupCrowdfundFields" class="hidden">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Goal Amount <span class="text-red-500">*</span></label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                            <input type="number" id="popupCrowdfundGoal" step="0.01" min="1" placeholder="500.00" required class="w-full pl-8 pr-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Current Amount</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                            <input type="number" id="popupCrowdfundRaised" step="0.01" min="0" placeholder="0.00" readonly class="w-full pl-8 pr-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-400 cursor-not-allowed">
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">Automatically updated as donations come in</div>
                                    </div>
                                </div>
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg mb-4">
                                    <div class="text-sm text-yellow-800 dark:text-yellow-200">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        Crowdfund requires payment method in Account Settings. Other payment types can use custom instructions.
                                    </div>
                                </div>
                                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                                    <div class="text-sm text-blue-800 dark:text-blue-200">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Your progress will be preserved even if you toggle this option off and on again.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payment Details -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Payment Details</label>
                                <textarea id="popupPaymentDetails" rows="3" placeholder="Payment instructions, Venmo handle, etc..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                            <button class="save-btn px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded">Save</button>
                        </div>
                    </div>
                `;
                
                // Set current payment values
                const currentPaymentType = document.getElementById('paymentType').value;
                const currentPaymentAmount = document.getElementById('paymentAmount').value;
                const currentPaymentDetails = document.getElementById('paymentDetails').value;
                const currentTicketPrice = document.getElementById('ticketPrice').value;
                const currentTicketQuantity = document.getElementById('ticketQuantityAlt').value;
                
                modal.querySelector('#popupPaymentType').value = currentPaymentType;
                modal.querySelector('#popupPaymentAmount').value = currentPaymentAmount;
                modal.querySelector('#popupPaymentDetails').value = currentPaymentDetails;
                modal.querySelector('#popupTicketPrice').value = currentTicketPrice;
                modal.querySelector('#popupTicketQuantity').value = currentTicketQuantity;
                
                // Handle payment type changes
                const updatePopupPaymentFields = () => {
                    const paymentType = modal.querySelector('#popupPaymentType').value;
                    const amountField = modal.querySelector('#popupAmountField');
                    const ticketFields = modal.querySelector('#popupTicketFields');
                    const crowdfundFields = modal.querySelector('#popupCrowdfundFields');
                    
                    // Hide all fields first
                    amountField.classList.add('hidden');
                    ticketFields.classList.add('hidden');
                    crowdfundFields.classList.add('hidden');
                    
                    if (paymentType === 'free') {
                        // All fields hidden
                    } else if (paymentType === 'ticket-price') {
                        ticketFields.classList.remove('hidden');
                    } else if (paymentType === 'crowdfund') {
                        crowdfundFields.classList.remove('hidden');
                    } else {
                        // donation or payment
                        amountField.classList.remove('hidden');
                    }
                };
                
                modal.querySelector('#popupPaymentType').addEventListener('change', updatePopupPaymentFields);
                updatePopupPaymentFields(); // Initial update
                
                modal.querySelector('.close-btn').onclick = () => modal.remove();
                modal.querySelector('.cancel-btn').onclick = () => modal.remove();
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.querySelector('.save-btn').onclick = () => {
                    // Save values back to the hidden form fields
                    document.getElementById('paymentType').value = modal.querySelector('#popupPaymentType').value;
                    document.getElementById('paymentAmount').value = modal.querySelector('#popupPaymentAmount').value;
                    document.getElementById('paymentDetails').value = modal.querySelector('#popupPaymentDetails').value;
                    document.getElementById('ticketPrice').value = modal.querySelector('#popupTicketPrice').value;
                    document.getElementById('ticketQuantityAlt').value = modal.querySelector('#popupTicketQuantity').value;
                    
                    // Update payment toggle text
                    const paymentType = modal.querySelector('#popupPaymentType').value;
                    const paymentTypeText = modal.querySelector('#popupPaymentType option:checked').textContent;
                    document.getElementById('paymentToggleText').textContent = paymentTypeText.substring(2); // Remove emoji
                    
                    modal.remove();
                };
                
                document.body.appendChild(modal);
            }



            function clearPaymentData() {
                document.getElementById('paymentType').value = 'free';
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentDetails').value = '';
                document.getElementById('ticketPrice').value = '';
                document.getElementById('ticketQuantityAlt').value = '';
                document.getElementById('crowdfundGoal').value = '';
                document.getElementById('crowdfundRaised').value = '0';
                document.getElementById('paymentToggleText').textContent = 'Payment';
            }

            // Add a hidden field to track the privacy setting
            function initializePrivacyField() {
                if (!document.getElementById('notePrivacy')) {
                    const hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.id = 'notePrivacy';
                    hiddenField.value = 'public';
                    document.getElementById('noteForm').appendChild(hiddenField);
                }
            }

            updateUserInterface();
            updateNoteCount();
            
            // Auto-login 'l' user for testing efficiency
            if (loginUser('l', 'l')) {
                console.log('Auto-logged in as user "l" for testing');
            }
            
            // Demo: Generate some notes automatically to show the glow effect
            startDemoNoteGeneration();
        });
        
        // Modal transparency system for background map interaction
        function setupModalTransparency(modal, note) {
            console.log('Setting up modal transparency for:', note.title);
            
            let isTransparent = false;
            let isHoldActive = false;
            let holdTimer = null;
            let startCoords = null;
            
            // Get modal content to check if clicks are on background
            const modalContent = modal.querySelector('.bg-white, .bg-gray-800');
            console.log('Modal content found:', !!modalContent);
            
            // Mouse events with better target detection
            modal.addEventListener('mousedown', (e) => {
                console.log('Mousedown on:', e.target.className, 'Modal content:', modalContent && modalContent.contains(e.target));
                
                // Check if click is on the modal content area (white background) or its children
                // But exclude interactive elements like buttons, inputs, links, etc.
                const isInteractiveElement = e.target.closest('button, input, textarea, select, a, [contenteditable]');
                const isOnModalContent = modalContent && (e.target === modalContent || modalContent.contains(e.target));
                
                console.log('Is on modal content:', isOnModalContent, 'Is interactive:', !!isInteractiveElement);
                
                if (isOnModalContent && !isInteractiveElement && currentUser) {
                    console.log('Starting hold timer...');
                    startCoords = { x: e.clientX, y: e.clientY };
                    isHoldActive = true;
                    
                    // Start hold timer (600ms for testing)
                    holdTimer = setTimeout(() => {
                        console.log('Hold timer expired, activating transparency');
                        if (isHoldActive) {
                            activateTransparency(modal, note);
                        }
                    }, 600);
                }
            });
            
            // Global mouse events to handle movement and release
            const mouseMoveHandler = (e) => {
                if (isHoldActive && startCoords) {
                    const distance = Math.sqrt(
                        Math.pow(e.clientX - startCoords.x, 2) + 
                        Math.pow(e.clientY - startCoords.y, 2)
                    );
                    
                    // If mouse moved more than 10 pixels, cancel hold
                    if (distance > 10) {
                        console.log('Mouse moved too much, canceling hold');
                        cancelHold();
                    }
                }
            };
            
            const mouseUpHandler = (e) => {
                if (isTransparent) {
                    console.log('Mouse up - deactivating transparency');
                    deactivateTransparency(modal, note);
                } else {
                    cancelHold();
                }
            };
            
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            
            // Touch events for mobile with better detection
            let touchStartPos = null;
            let touchHoldTimer = null;
            
            modal.addEventListener('touchstart', (e) => {
                console.log('Touch start on:', e.target.className);
                
                if (e.touches.length !== 1) return;
                
                const isOnBackground = e.target === modal || 
                    (e.target.classList && e.target.classList.contains('fixed') && e.target.classList.contains('inset-0'));
                
                if (!isOnBackground || !currentUser) return;
                
                const touch = e.touches[0];
                touchStartPos = { x: touch.clientX, y: touch.clientY };
                isHoldActive = true;
                
                console.log('Starting touch hold timer...');
                touchHoldTimer = setTimeout(() => {
                    console.log('Touch hold timer expired');
                    if (isHoldActive) {
                        // Trigger haptic feedback
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        activateTransparency(modal, note);
                    }
                }, 800); // Slightly longer for touch
            }, { passive: true });
            
            modal.addEventListener('touchmove', (e) => {
                if (!isHoldActive || !touchStartPos) return;
                
                const touch = e.touches[0];
                const distance = Math.sqrt(
                    Math.pow(touch.clientX - touchStartPos.x, 2) + 
                    Math.pow(touch.clientY - touchStartPos.y, 2)
                );
                
                if (distance > 20) {
                    console.log('Touch moved too much, canceling hold');
                    cancelTouchHold();
                }
            }, { passive: true });
            
            modal.addEventListener('touchend', (e) => {
                if (isTransparent) {
                    console.log('Touch end - deactivating transparency');
                    deactivateTransparency(modal, note);
                } else {
                    cancelTouchHold();
                }
            }, { passive: true });
            
            function cancelHold() {
                if (holdTimer) {
                    clearTimeout(holdTimer);
                    holdTimer = null;
                }
                isHoldActive = false;
                startCoords = null;
                console.log('Hold canceled');
            }
            
            function cancelTouchHold() {
                if (touchHoldTimer) {
                    clearTimeout(touchHoldTimer);
                    touchHoldTimer = null;
                }
                isHoldActive = false;
                touchStartPos = null;
                console.log('Touch hold canceled');
            }
            
            function activateTransparency(modal, note) {
                console.log('Activating transparency mode');
                isTransparent = true;
                isHoldActive = false;
                
                // Make modal transparent and disable pointer events so map can be interacted with
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                modal.style.pointerEvents = 'none';
                if (modalContent) {
                    modalContent.style.opacity = '0.1';
                }
                
                // Highlight the pin for this note
                if (mapMarkers) {
                    const noteMarker = mapMarkers.find(m => m.noteId === note.id);
                    if (noteMarker) {
                        console.log('Highlighting pin for note');
                        highlightPin(noteMarker);
                    }
                }
                
                // Enable map dragging (ensure it's enabled)
                if (map && map.dragging) {
                    map.dragging.enable();
                }
                
                // Show instruction overlay with pointer events enabled
                showTransparencyInstructions();
            }
            
            function deactivateTransparency(modal, note) {
                console.log('Deactivating transparency mode');
                isTransparent = false;
                
                // Restore modal opacity
                modal.style.backgroundColor = '';
                if (modalContent) {
                    modalContent.style.opacity = '';
                }
                
                // Hide instruction overlay
                hideTransparencyInstructions();
                
                // Pin highlight will remain until modal closes
            }
            
            function showTransparencyInstructions() {
                // Remove existing instruction if any
                hideTransparencyInstructions();
                
                const instruction = document.createElement('div');
                instruction.id = 'transparencyInstruction';
                instruction.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-[3500] text-sm';
                instruction.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-hand-pointer"></i>
                        <span>Drag to move map ‚Ä¢ Release to restore note</span>
                    </div>
                `;
                document.body.appendChild(instruction);
                console.log('Transparency instructions shown');
            }
            
            function hideTransparencyInstructions() {
                const instruction = document.getElementById('transparencyInstruction');
                if (instruction) {
                    instruction.remove();
                    console.log('Transparency instructions hidden');
                }
            }
            
            // Cleanup function to remove event listeners when modal closes
            modal._cleanupTransparency = () => {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                cancelHold();
                cancelTouchHold();
                hideTransparencyInstructions();
            };
        }

        // Demo note generation system
        function startDemoNoteGeneration() {
            // Wait a bit after page load, then start generating notes
            setTimeout(() => {
                if (currentUser) {
                    generateDemoNote();
                    // Continue generating notes every 8-15 seconds
                    setInterval(() => {
                        if (currentUser && notes.length < 15) { // Don't overcrowd the map
                            generateDemoNote();
                        }
                    }, Math.random() * 7000 + 8000); // 8-15 seconds
                }
            }, 3000); // Wait 3 seconds after page load
        }
        
        function generateDemoNote() {
            if (!currentUser) return;
            
            // NYC area coordinates with some variation
            const baseCoords = [
                [40.7589, -73.9851], // Times Square
                [40.7614, -73.9776], // Bryant Park  
                [40.7505, -73.9934], // High Line
                [40.7282, -74.0776], // Brooklyn Bridge
                [40.7829, -73.9654], // Central Park
                [40.7484, -73.9857], // Empire State
                [40.7411, -74.0040], // SoHo
                [40.7831, -73.9712], // Upper East Side
                [40.7359, -74.0014], // Village
                [40.7549, -73.9840]  // Hell's Kitchen
            ];
            
            const demoNotes = [
                {
                    title: "Hidden Gem Bakery",
                    content: "Just discovered this amazing little bakery! Their croissants are incredible and the coffee is perfectly brewed. Local favorite spot.",
                    tags: ['bakery', 'coffee', 'hidden-gem', 'local'],
                    pinStyle: { type: 'emoji', value: 'ü•ê' },
                    privacy: 'public'
                },
                {
                    title: "Street Art Masterpiece",
                    content: "Incredible mural just appeared overnight! The artist really captured the neighborhood's spirit. Perfect lighting for photos in the morning.",
                    tags: ['street-art', 'photography', 'culture', 'mural'],
                    pinStyle: { type: 'emoji', value: 'üé®' },
                    privacy: 'public'
                },
                {
                    title: "Cozy Reading Nook",
                    content: "Found the perfect spot to read with a great view and comfortable seating. Quiet atmosphere, ideal for studying or relaxing.",
                    tags: ['reading', 'quiet', 'study', 'peaceful'],
                    pinStyle: { type: 'emoji', value: 'üìö' },
                    privacy: 'friends'
                },
                {
                    title: "Live Music Venue",
                    content: "Amazing acoustic set tonight! This intimate venue has fantastic sound and the musicians really connect with the audience.",
                    tags: ['music', 'live', 'entertainment', 'acoustic'],
                    pinStyle: { type: 'emoji', value: 'üéµ' },
                    privacy: 'public'
                },
                {
                    title: "Rooftop Garden",
                    content: "Discovered this beautiful rooftop garden with stunning city views. Great place to escape the hustle and bustle below.",
                    tags: ['garden', 'rooftop', 'views', 'nature', 'peaceful'],
                    pinStyle: { type: 'emoji', value: 'üåø' },
                    privacy: 'friends-of-friends'
                },
                {
                    title: "Food Truck Paradise",
                    content: "This food truck serves the most authentic tacos I've had outside of Mexico! Long line but totally worth the wait.",
                    tags: ['food-truck', 'tacos', 'authentic', 'street-food'],
                    pinStyle: { type: 'emoji', value: 'üåÆ' },
                    privacy: 'public'
                },
                {
                    title: "Sunset Viewpoint",
                    content: "Perfect spot to watch the sunset over the river. Brings a folding chair if you can - you'll want to stay for the whole show.",
                    tags: ['sunset', 'views', 'romantic', 'photography'],
                    pinStyle: { type: 'emoji', value: 'üåÖ' },
                    privacy: 'public'
                },
                {
                    title: "Vintage Record Store",
                    content: "Holy grail for vinyl collectors! Found some rare pressings and the owner knows everything about music history. Could spend hours here.",
                    tags: ['vinyl', 'music', 'vintage', 'collector', 'shopping'],
                    pinStyle: { type: 'emoji', value: 'üé∂' },
                    privacy: 'friends'
                }
            ];
            
            // Pick random elements
            const coords = baseCoords[Math.floor(Math.random() * baseCoords.length)];
            const noteTemplate = demoNotes[Math.floor(Math.random() * demoNotes.length)];
            
            // Add some coordinate variation (within ~2 blocks)
            const lat = coords[0] + (Math.random() - 0.5) * 0.01;
            const lng = coords[1] + (Math.random() - 0.5) * 0.01;
            
            // Create the note with glow effect
            const note = {
                id: Date.now() + Math.random(),
                lat,
                lng,
                title: noteTemplate.title,
                authorId: currentUser.id,
                author: currentUser.username,
                content: noteTemplate.content,
                tags: noteTemplate.tags,
                pinStyle: noteTemplate.pinStyle,
                privacy: noteTemplate.privacy,
                media: [],
                comments: [],
                createdAt: new Date()
            };
            
            // Add to notes array and map with glow effect
            notes.push(note);
            addNoteToMap(note, true); // true = isNewNote, triggers glow effect
            updateNoteCount();
            
            // Show a subtle notification
            showNotification(`üìç New note added: ${note.title}`, 'success');
        }
    </script>
</body>
</html>
